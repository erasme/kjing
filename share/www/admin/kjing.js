Ui.LBox.extend("KJing.RatioBox",{ratio:1,constructor:function(a){},setRatio:function(a){this.ratio!==a&&(this.ratio=a,this.invalidateMeasure())}},{measureCore:function(a,b){var c,d;this.ratio>a/b?(c=a,d=c/this.ratio):(d=b,c=d*this.ratio);return KJing.RatioBox.base.measureCore.call(this,c,d)},arrangeCore:function(a,b){var c,d,e,f;this.ratio>a/b?(c=a,d=c/this.ratio,e=0,f=(b-d)/2):(d=b,c=d*this.ratio,f=0,e=(a-c)/2);var g=this.getPaddingLeft(),h=this.getPaddingRight(),l=this.getPaddingTop(),m=this.getPaddingBottom();
c-=g+h;d-=l+m;for(h=0;h<this.getChildren().length;h++)this.getChildren()[h].arrange(g+e,l+f,c,d)}});Ui.CanvasElement.extend("KJing.RoundItemGraphic",{image:void 0,constructor:function(){this.image=new Ui.Image;this.appendChild(this.image);this.connect(this.image,"ready",this.invalidateDraw)},setImageSrc:function(a){this.image.setSrc(a)}},{canvasEngine:"canvas",updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight(),d=Math.min(b,c),e=d/2;if(this.image.getIsReady()){var f=this.image.getNaturalWidth(),g=this.image.getNaturalHeight(),h=Math.min(f,g),f=(f-h)/2,g=(g-h)/2,l=(b-d)/
2,m=(c-d)/2;a.save();a.beginPath();a.arc(b/2,c/2,e-0.5,0,2*Math.PI,!0);a.closePath();a.clip();a.drawImage(this.image.getDrawing(),f,g,h,h,l,m,d,d);a.restore();a.beginPath();a.arc(b/2,c/2,e-1,0,2*Math.PI,!0);a.closePath();a.strokeStyle="#ffffff";a.lineWidth=2;a.stroke()}}});Ui.LBox.extend("KJing.ResourceViewer",{resource:void 0,setupPropertiesButton:void 0,constructor:function(a){this.resource=a.resource;delete a.resource},getResource:function(){return this.resource},setState:function(a){},getState:function(){},getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();
a.close()});b.append(c);return a}},{},{types:void 0,constructor:function(){KJing.ResourceViewer.types={}},register:function(a,b){KJing.ResourceViewer.types[a]={type:a,creator:b}},getTypesDefs:function(){return KJing.ResourceViewer.types},getTypeDef:function(a){if(void 0!==KJing.ResourceViewer.types[a])return KJing.ResourceViewer.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.ResourceViewer.types[a])return KJing.ResourceViewer.types[a];if(void 0!==KJing.ResourceViewer.types.resource)return KJing.ResourceViewer.types.resource},
create:function(a){a=KJing.Resource.create(a);return new (KJing.ResourceViewer.getTypeDef(a.getType()).creator)({resource:a})},updateChildren:function(a,b,c,d){for(var e=[],f=[],g,h,l=void 0,m=[],k=0;k<d.length;k++){g=d[k];for(var l=void 0,n=1;void 0===l&&n<b.length;n++)b[n].getResource().getId()===g.getId()&&(l=b[n]);void 0===l?(g=KJing.ResourceIconViewer.create(g),void 0!==g&&(f.push(g),m.push(g))):m.push(l)}for(n=c;n<b.length;n++){h=b[n];l=void 0;for(k=0;void 0===l&&k<d.length;k++)g=d[k],g.getId()===
h.getResource().getId()&&(l=d[k]);void 0===l&&e.push(h)}for(k=0;k<e.length;k++)a.remove(e[k]);if(0<f.length)for(k=0;k<f.length;k++)a.append(f[k]);for(k=0;k<m.length;k++)a.moveAt(m[k],c+k)}});Ui.DropBox.extend("KJing.ResourceIcon",{resource:void 0,tagsBox:void 0,tags:void 0,isRound:!1,iconName:void 0,iconSrc:void 0,imageSrc:void 0,ownerImageSrc:void 0,squareSize:64,icon:void 0,progressbar:void 0,constructor:function(a){this.resource=a.resource;delete a.resource},getResource:function(){return this.resource},setSquareSize:function(a){this.squareSize=a;void 0!==this.tagsBox&&(this.tagsBox.setWidth(this.squareSize),this.tagsBox.setHeight(this.squareSize));void 0!==this.icon&&(KJing.SquareImage.hasInstance(this.icon)?
this.icon.setSquareSize(this.squareSize):(this.icon.setWidth(this.squareSize),this.icon.setHeight(this.squareSize)))},setRoundMode:function(a){this.isRound=a;void 0!==this.imageSrc&&this.setImage(this.imageSrc)},getProgressBar:function(){return this.progressbar},setProgressBar:function(a){void 0!==this.progressbar&&this.remove(this.progressbar);this.progressbar=a;void 0!==this.progressbar&&this.append(this.progressbar)},setIcon:function(a){this.iconName=a;Ui.Icon.hasInstance(this.icon)?this.icon.setIcon(this.iconName):
(this.icon=new Ui.Icon({icon:this.iconName,width:this.squareSize,height:this.squareSize}),this.setContent(this.icon),void 0!==this.tagsBox&&this.append(this.tagsBox),void 0!==this.progressbar&&this.append(this.progressbar))},setIconImage:function(a){this.iconSrc=a;this.icon=new KJing.SquareImage({src:this.iconSrc,squareSize:this.squareSize,horizontalAlign:"center",verticalAlign:"bottom"});this.setContent(this.icon);void 0!==this.tagsBox&&this.append(this.tagsBox);void 0!==this.progressbar&&this.append(this.progressbar)},
setImage:function(a){this.imageSrc=a;this.isRound?this.icon=new KJing.RoundItemGraphic({imageSrc:this.imageSrc,width:this.squareSize,height:this.squareSize}):(this.icon=new KJing.SquareImage({src:this.imageSrc,squareSize:this.squareSize,horizontalAlign:"center",verticalAlign:"bottom"}),this.connect(this.icon,"error",this.onImageError));this.setContent(this.icon);void 0!==this.tagsBox&&this.append(this.tagsBox);void 0!==this.progressbar&&this.append(this.progressbar)},getTags:function(){return this.tags},
setTags:function(a){this.tags=a;this.updateTags()},setOwnerImage:function(a){this.ownerImageSrc=a;this.updateTags()},updateTags:function(){if(void 0!==this.tags||void 0!==this.ownerImageSrc){void 0===this.tagsBox&&(this.tagsBox=new Ui.LBox({width:this.squareSize,height:this.squareSize}),this.append(this.tagsBox));var a=new Ui.Flow({itemAlign:"right",verticalAlign:"bottom"});this.tagsBox.setContent(a);if(void 0!==this.tags)for(var b=0;b<this.tags.length;b++){var c=this.tags[b],d="#00c3ff",e=c;"object"===
typeof c&&(e=c.icon,void 0!==c.color&&(d=c.color));a.append(new Ui.Icon({icon:e,width:24,height:24,fill:d}))}void 0!==this.ownerImageSrc&&a.append(new KJing.RoundItemGraphic({width:24,height:24,imageSrc:this.ownerImageSrc}))}else void 0!==this.tagsBox&&(this.remove(this.tagsBox),this.tagsBox=void 0)},onImageError:function(a){this.disconnect(a,"error",this.onImageError);void 0!==this.iconSrc?this.setIconImage(this.iconSrc):void 0!==this.iconName&&this.setIcon(this.iconName)},onResourceChange:function(){},
onResourceError:function(){this.setTags([{icon:"deny",color:"#ff5151"}])},onResourceDelete:function(){this.setTags([{icon:"deleted",color:"#ff5151"}])}},{onLoad:function(){KJing.ResourceIcon.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange();this.connect(this.resource,"error",this.onResourceError);if(this.resource.getIsError())this.onResourceError();this.connect(this.resource,"delete",this.onResourceDelete);
if(this.resource.getIsDeleted())this.onResourceDelete()},onUnload:function(){KJing.ResourceIcon.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.disconnect(this.resource,"error",this.onResourceError);this.disconnect(this.resource,"delete",this.onResourceDelete)}},{types:void 0,constructor:function(){KJing.ResourceIcon.types={}},register:function(a,b,c){KJing.ResourceIcon.types[a]={type:a,creator:b,actions:c}},getTypeDef:function(a){if(void 0!==
KJing.ResourceIcon.types[a])return KJing.ResourceIcon.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.ResourceIcon.types[a])return KJing.ResourceIcon.types[a]},create:function(a){a=KJing.Resource.create(a);return new (KJing.ResourceIcon.getTypeDef(a.getType()).creator)({resource:a})}});Ui.Image.extend("KJing.SquareImage",{squareSize:void 0,setSquareSize:function(a){this.squareSize=a;this.invalidateMeasure()}},{measureCore:function(a,b){if(this.getIsReady()){var c=this.getNaturalWidth()/this.getNaturalHeight();return 1<c?{width:this.squareSize,height:this.squareSize/c}:{width:this.squareSize*c,height:this.squareSize}}return{width:this.squareSize,height:this.squareSize}}});
Ui.DropBox.extend("KJing.ItemViewIcon",{tagsBox:void 0,tags:void 0,isRound:!1,iconName:void 0,iconSrc:void 0,imageSrc:void 0,ownerImageSrc:void 0,squareSize:48,icon:void 0,progressbar:void 0,constructor:function(){},setSquareSize:function(a){this.squareSize=a;void 0!==this.tagsBox&&(this.tagsBox.setWidth(this.squareSize),this.tagsBox.setHeight(this.squareSize));void 0!==this.icon&&(KJing.SquareImage.hasInstance(this.icon)?this.icon.setSquareSize(this.squareSize):(this.icon.setWidth(this.squareSize),
this.icon.setHeight(this.squareSize)))},setRoundMode:function(a){this.isRound=a;void 0!==this.imageSrc&&this.setImage(this.imageSrc)},setProgressBar:function(a){void 0!==this.progressbar&&this.remove(this.progressbar);this.progressbar=a;void 0!==this.progressbar&&this.append(this.progressbar)},setIcon:function(a){this.iconName=a;Ui.Icon.hasInstance(this.icon)?this.icon.setIcon(this.iconName):(this.icon=new Ui.Icon({icon:this.iconName,width:this.squareSize,height:this.squareSize}),this.setContent(this.icon),
void 0!==this.tagsBox&&this.append(this.tagsBox),void 0!==this.progressbar&&this.append(this.progressbar))},setIconImage:function(a){this.iconSrc=a;this.icon=new KJing.SquareImage({src:this.iconSrc,squareSize:this.squareSize,horizontalAlign:"center",verticalAlign:"bottom"});this.setContent(this.icon);void 0!==this.tagsBox&&this.append(this.tagsBox);void 0!==this.progressbar&&this.append(this.progressbar)},setImage:function(a){this.imageSrc=a;this.isRound?this.icon=new KJing.RoundItemGraphic({imageSrc:this.imageSrc,
width:this.squareSize,height:this.squareSize}):(this.icon=new KJing.SquareImage({src:this.imageSrc,squareSize:this.squareSize,horizontalAlign:"center",verticalAlign:"bottom"}),this.connect(this.icon,"error",this.onImageError));this.setContent(this.icon);void 0!==this.tagsBox&&this.append(this.tagsBox);void 0!==this.progressbar&&this.append(this.progressbar)},setTags:function(a){this.tags=a;this.updateTags()},setOwnerImage:function(a){this.ownerImageSrc=a;this.updateTags()},updateTags:function(){if(void 0!==
this.tags||void 0!==this.ownerImageSrc){void 0===this.tagsBox&&(this.tagsBox=new Ui.LBox({width:this.squareSize,height:this.squareSize}),this.append(this.tagsBox));var a=new Ui.Flow({itemAlign:"right",verticalAlign:"bottom"});this.tagsBox.setContent(a);if(void 0!==this.tags)for(var b=0;b<this.tags.length;b++)a.append(new Ui.Icon({icon:this.tags[b],width:24,height:24,fill:"#00c3ff"}));void 0!==this.ownerImageSrc&&a.append(new KJing.RoundItemGraphic({width:24,height:24,imageSrc:this.ownerImageSrc}))}else void 0!==
this.tagsBox&&(this.remove(this.tagsBox),this.tagsBox=void 0)},onImageError:function(a){this.disconnect(a,"error",this.onImageError);void 0!==this.iconSrc?this.setIconImage(this.iconSrc):void 0!==this.iconName&&this.setIcon(this.iconName)}});
Ui.Button.extend("KJing.IconViewer",{content:void 0,name:void 0,iconSrc:void 0,iconName:void 0,imageSrc:void 0,share:!1,tags:void 0,tagsBox:void 0,isRound:!1,itemIcon:void 0,selectedIcon:void 0,allowSelect:!0,constructor:function(a){this.setDraggableData(this);this.itemIcon=new KJing.ItemViewIcon({verticalAlign:"bottom",horizontalAlign:"center"});this.setIcon(this.itemIcon);this.setItemName("");this.connect(this,"press",function(){this.allowSelect&&(this.getIsSelected()?this.unselect():this.select())})},
setAllowSelect:function(a){this.allowSelect=a},getItemIcon:function(){return this.itemIcon},addType:function(a,b){this.itemIcon.addType(a,b)},setProgressBar:function(a){this.itemIcon.setProgressBar(a)},setItemTags:function(a){this.itemIcon.setTags(a)},setItemOwnerImage:function(a){this.itemIcon.setOwnerImage(a)},setItemIcon:function(a){this.itemIcon.setIcon(a)},setItemIconSrc:function(a){this.itemIcon.setIconImage(a)},setItemImage:function(a){this.itemIcon.setImage(a)},getItemName:function(){return this.name},
setItemName:function(a){this.name=a;this.setText(a)},setItemLabel:function(a){this.setText(a)},onImageError:function(a){this.disconnect(a,"error",this.onImageError);void 0!==this.iconSrc?this.setItemIconSrc(this.iconSrc):void 0!==this.iconName&&this.setItemIcon(this.iconName)}},{onSelect:function(){this.selectedIcon=new Ui.Icon({icon:"check",verticalAlign:"top",horizontalAlign:"right",marginTop:5,marginRight:5,width:32,height:32,fill:this.getStyleProperty("selectCheckColor")});this.getDropBox().append(this.selectedIcon)},
onUnselect:function(){this.getDropBox().remove(this.selectedIcon);this.selectedIcon=void 0},onStyleChange:function(){KJing.IconViewer.base.onStyleChange.apply(this,arguments);this.itemIcon.setSquareSize(this.getStyleProperty("iconSize"));this.itemIcon.setRoundMode(this.getStyleProperty("roundMode"));void 0!==this.selectedIcon&&this.selectedIcon.setFill(this.getStyleProperty("selectCheckColor"))}},{style:{selectCheckColor:"red",roundMode:!1}});KJing.IconViewer.extend("KJing.ResourceIconViewer",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.itemIcon=KJing.ResourceIcon.create(this.resource);this.itemIcon.setHorizontalAlign("center");this.itemIcon.setVerticalAlign("bottom");this.setIcon(this.itemIcon);this.setDraggableData(this.resource)},getResource:function(){return this.resource},getView:function(){for(var a=this.getParent();null!==a&&void 0!==a;){if(KJing.PartView.hasInstance(a))return a;a=a.getParent()}},
open:function(){this.getView().push(this.getResource().getName(),this.getResource().getId())},onItemProperties:function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open()},suppress:function(a){this.resource.suppress()},onResourceChange:function(){if(this.resource.getOwnerId()!==Ui.App.current.getUser().getId()&&this.resource.getOwnerId()!==this.resource.getId()){var a=KJing.Resource.create(this.resource.getOwnerId());if(a.getIsReady())this.onOwnerReady(a);else this.connect(a,
"ready",this.onOwnerReady)}a=this.resource.getName();void 0===a||null===a?this.setItemName(""):this.setItemName(a)},onOwnerReady:function(a){this.setItemOwnerImage(a.getFaceUrl())},onResourceDelete:function(){},testWriteRight:function(){return this.getResource().canWrite()}},{onLoad:function(){KJing.ResourceIconViewer.base.onLoad.apply(this,arguments);this.resource.monitor();this.connect(this.resource,"change",this.onResourceChange);this.connect(this.resource,"delete",this.onResourceDelete);if(this.resource.getIsReady())this.onResourceChange()},
onUnload:function(){KJing.ResourceIconViewer.base.onUnload.apply(this,arguments);this.resource.unmonitor();this.disconnect(this.resource,"change",this.onResourceChange);this.disconnect(this.resource,"delete",this.onResourceDelete)},getSelectionActions:function(){return{suppress:{text:"Supprimer",icon:"trash",testRight:this.testWriteRight,scope:this,callback:this.suppress,multiple:!1},edit:{text:"Propri\u00e9t\u00e9s",icon:"edit",scope:this,callback:this.onItemProperties,multiple:!1},open:{"default":!0,
text:"Ouvrir",icon:"eye",scope:this,callback:this.open,multiple:!1}}}},{types:void 0,constructor:function(){KJing.ResourceIconViewer.types={}},register:function(a,b){KJing.ResourceIconViewer.types[a]={type:a,creator:b}},getTypeDef:function(a){if(void 0!==KJing.ResourceIconViewer.types[a])return KJing.ResourceIconViewer.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.ResourceIconViewer.types[a])return KJing.ResourceIconViewer.types[a]},create:function(a){a=KJing.Resource.create(a);
var b=KJing.ResourceIconViewer.getTypeDef(a.getType());return void 0===b?new KJing.ResourceIconViewer({resource:a}):new b.creator({resource:a})}});Ui.VBox.extend("KJing.Field",{title:void 0,fieldBox:void 0,constructor:function(a){this.addEvents("change");var b=new Ui.Text({text:a.title});delete a.title;this.append(b);this.fieldBox=new Ui.LBox({marginLeft:10});this.append(this.fieldBox);a.desc&&(this.append(new Ui.Text({text:a.desc,color:"#aaaaaa"})),delete a.desc)},getTitle:function(){return this.title.getText()},setTitle:function(a){this.title.setText(a)},getField:function(){return this.fieldBox.getFirstChild()},setField:function(a){this.fieldBox.setContent(a)},
getValue:function(){if(void 0!==this.getField()&&void 0!==this.getField().getValue)return this.getField().getValue()},setValue:function(a){void 0!==this.getField()&&void 0!==this.getField().setValue&&this.getField().setValue(a)}});KJing.Field.extend("KJing.TextField",{constructor:function(a){a=new Ui.TextField;this.connect(a,"change",this.onFieldChange);this.setField(a)},getTextHolder:function(){return this.getField().getTextHolder()},setTextHolder:function(a){this.getField().setTextHolder(a)},setPasswordMode:function(a){this.getField().setPasswordMode(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});KJing.Field.extend("KJing.TextAreaField",{constructor:function(a){a=new Ui.TextAreaField;this.connect(a,"change",this.onFieldChange);this.setField(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});Ui.VBox.extend("KJing.ComboField",{title:void 0,field:void 0,constructor:function(a){this.addEvents("change");var b=new Ui.Text({text:a.title});delete a.title;this.append(b);this.field=new Ui.Combo({marginLeft:5});this.connect(this.field,"change",this.onFieldChange);this.append(this.field);a.desc&&(this.append(new Ui.Text({text:a.desc,color:"#aaaaaa"})),delete a.desc)},setField:function(a){this.field.setField(a)},getData:function(){return this.field.getData()},setData:function(a){this.field.setData(a)},
setCurrentAt:function(a){this.field.setCurrentAt(a)},getTitle:function(){return this.title.getText()},setTitle:function(a){this.title.setText(a)},getValue:function(){return this.field.getValue()},setValue:function(a){this.field.setValue(a)},setPasswordMode:function(a){this.field.setPasswordMode(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});Ui.CanvasElement.extend("KJing.QuotaGraphic",{value:0,setValue:function(a){this.value=a;this.invalidateDraw()}},{updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight(),d=this.getStyleProperty("radius"),d=Math.max(0,Math.min(d,Math.min(b/2,c/2)));this.getStyleProperty("borderWidth");Math.max(8,c-4-16);this.getIsDisabled()&&(a.globalAlpha=0.2);a.fillStyle=Ui.Color.create(this.getStyleProperty("background")).getCssRgba();a.beginPath();a.roundRect(0,0,b,c,d,d,d,d);a.closePath();
a.fill();a.globalAlpha=1;if(0<=this.value){var e=new Ui.Color({h:110*(1-this.value),s:0.5,l:1});a.fillStyle=e.getCssRgba();a.beginPath();a.roundRect(2,2,b*this.value-4,c-4,d,d,d,d);a.closePath();a.fill()}}},{style:{radius:3,borderWidth:2,background:"rgba(120,120,120,0.2)"}});
Ui.HBox.extend("KJing.Quota",{graphic:void 0,label:void 0,value:void 0,button:void 0,unit:"byte",editor:!1,constructor:function(a){this.addEvents("change");this.setSpacing(5);this.setPadding(3);this.value={used:0,max:0};a=new Ui.LBox({height:32});this.append(a,!0);this.graphic=new KJing.QuotaGraphic;a.append(this.graphic);this.label=new Ui.Label({margin:4,fontSize:16,verticalAlign:"center"});a.append(this.label)},setEditor:function(a){a=!0===a;a!==this.editor&&(this.editor=a,!0===this.editor?(this.button=
new Ui.TextFieldButton({icon:"edit"}),this.append(this.button),this.connect(this.button,"press",function(){var a=new Ui.Popup,c=new Ui.Form;a.setContent(c);var d=new Ui.VBox({margin:10,spacing:5});c.setContent(d);d.append(new Ui.Text({text:"Maximum"}));var e=new Ui.TextField({value:this.value.max,width:100,marginLeft:10});d.append(e);a.open(this.button,"right");this.connect(c,"submit",function(){a.close()});this.connect(a,"close",function(){var a=this.getValue();a.max=parseFloat(e.getValue());this.setValue(a)})})):
this.remove(this.button))},updateBytes:function(){var a,b=0<=this.value.max?this.value.max:this.value.used,c=1,d=2;a="octets";1E9<b?(a="Go",c=1E9):1E6<b?(a="Mo",c=1E6):1E3<b?(a="ko",c=1E3):d=0;b=(this.value.used/c).toFixed(d);0<=this.value.max?(c=(this.value.max/c).toFixed(d),a=b+" / "+c+" "+a):a=b+" "+a+" / infinite";this.label.setText(a)},updateSeconds:function(){var a,b=0<=this.value.max?this.value.max:this.value.used,c=1;a="s";7200<b?(a="h",c=3600):60<b?(a="min",c=60):2<b?(a="s",c=1):(a="ms",
c=0.001);b=(this.value.used/c).toFixed(2);0<=this.value.max?(c=(this.value.max/c).toFixed(2),a=b+" / "+c+" "+a):a=b+" "+a+" / infinite";this.label.setText(a)},getUnit:function(){return this.unit},setUnit:function(a){this.unit=a;this.updateLabel()},getValue:function(){return this.value},setValue:function(a){this.value={used:Math.max(0,parseFloat(a.used)),max:parseFloat(a.max)};isNaN(this.value.used)&&(this.value.used=0);if(isNaN(this.value.max)||0>this.value.max)this.value.max=-1;a=-1===this.value.max?
-1:Math.max(0,Math.min(1,0===this.value.max?0:this.value.used/this.value.max));this.updateLabel();this.graphic.setValue(a);this.fireEvent("change",this,this.getValue())},updateLabel:function(){"byte"===this.unit?this.updateBytes():this.updateSeconds()}});
KJing.Field.extend("KJing.QuotaField",{constructor:function(a){a=new KJing.Quota;this.connect(a,"change",this.onFieldChange);this.setField(a)},setEditor:function(a){this.getField().setEditor(a)},getUnit:function(){return this.getField().getUnit()},setUnit:function(a){this.getField().setUnit(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});Ui.Button.extend("KJing.OptionOpenButton",{constructor:function(){this.setIcon("optionarrow")}});
Ui.Fold.extend("KJing.OptionSection",{title:void 0,arrow:void 0,optionContent:void 0,constructor:function(){this.setOver(!1);this.setIsFolded(!1);this.optionOpenButton=new KJing.OptionOpenButton;this.arrow=this.optionOpenButton.getIcon();this.connect(this.optionOpenButton,"press",this.invert);this.setHeader(this.optionOpenButton);this.optionContent=new Ui.LBox({paddingLeft:30});KJing.OptionSection.base.setContent.call(this,this.optionContent)},setTitle:function(a){this.optionOpenButton.setText(a)}},
{setContent:function(a){this.optionContent.setContent(a)},setOffset:function(a){KJing.OptionSection.base.setOffset.call(this,a);void 0!==this.arrow&&this.arrow.setTransform(Ui.Matrix.createRotate(90*a))}});Ui.Button.extend("KJing.NewIcon",{constructor:function(a){this.setIcon("plus")}});KJing.NewIcon.extend("KJing.ResourceNewIcon",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.connect(this,"press",this.onNewPress)},onNewPress:function(){(new KJing.CreatorDialog({title:"Nouvelle ressource",resource:this.resource,types:KJing.ResourceCreator.getTypesDefs()})).open()}});Ui.SFlow.extend("KJing.CreatorSelector",{types:void 0,constructor:function(a){this.addEvents("done");"types"in a&&(this.types=a.types,delete a.types);this.setItemAlign("stretch");this.setUniform(!0);this.setStretchMaxRatio(3);this.setSpacing(5);for(var b in this.types){a=this.types[b];var c;a.uploader?(c=new Ui.UploadButton({text:a.text,icon:a.icon,orientation:"horizontal",width:200}),this.connect(c,"file",this.onButtonFile)):(c=new Ui.Button({text:a.text,icon:a.icon,orientation:"horizontal",width:200}),
this.connect(c,"press",this.onButtonPress));c.kjingNewResourceSelectorType=a;this.append(c)}},onButtonFile:function(a,b){this.fireEvent("done",this,a.kjingNewResourceSelectorType,b)},onButtonPress:function(a){this.fireEvent("done",this,a.kjingNewResourceSelectorType)}});KJing.IconViewer.extend("KJing.RightIconViewer",{resource:void 0,right:void 0,user:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.right=a.right;delete a.right;this.setItemName("");this.user=KJing.Resource.create(this.right.user);this.itemIcon=KJing.ResourceIcon.create(this.user);this.itemIcon.setVerticalAlign("bottom");this.itemIcon.setHorizontalAlign("center");this.setIcon(this.itemIcon);a=void 0;this.right.write&&this.right.admin?a=["pen","tools"]:this.right.write?
a=["pen"]:this.right.admin&&(a=["tools"]);this.setItemTags(a)},getResource:function(){return this.resource},getUser:function(){return this.user},onUserChange:function(){this.setItemName(this.user.getName())}},{onLoad:function(){KJing.RightIconViewer.base.onLoad.apply(this,arguments);this.connect(this.user,"change",this.onUserChange);if(this.user.getIsReady())this.onUserChange()},onUnload:function(){KJing.RightIconViewer.base.onUnload.apply(this,arguments);this.disconnect(this.user,"change",this.onUserChange)},
getSelectionActions:function(){return KJing.RightIconViewer.actions}},{actions:void 0,constructor:function(a){KJing.RightIconViewer.actions={suppress:{icon:"trash",text:"Retirer","default":!0,multiple:!0,callback:KJing.RightIconViewer.onSuppressAction}}},onSuppressAction:function(a){a=a.getElements();for(var b=[],c=0;c<a.length;c++)b.push({user:a[c].getUser().getId(),read:!1,write:!1,admin:!1});a[0].getResource().addRights(b)}});Ui.VBox.extend("KJing.ResourceRightCreator",{resource:void 0,searchField:void 0,writeField:void 0,readField:void 0,flow:void 0,valid:!1,onAddActionBinded:void 0,filterType:void 0,filterIconViewer:void 0,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.append(this.searchField);a=new Ui.HBox;this.append(a);this.writeField=
new Ui.CheckBox({text:"Ecriture"});this.adminField=new Ui.CheckBox({text:"Administrer"});a.append(this.writeField,!0);a.append(this.adminField,!0);this.flow=new Ui.Flow;this.append(this.flow);this.onAddActionBinded=this.onAddAction.bind(this)},setFilterType:function(a){this.filterType=a},setFilterIconViewer:function(a){this.filterIconViewer=a},getRights:function(){return{read:!0,write:this.writeField.getValue(),admin:this.adminField.getValue()}},create:function(){this.fireEvent("done",this)},onSearchValidate:function(){var a=
new KJing.Search({queryString:this.searchField.getValue(),filters:{type:this.filterType}});this.connect(a,"change",this.onSearchDone)},onSearchDone:function(a){this.flow.clear();a=a.getResources();for(var b=0;b<a.length;b++){var c=KJing.ResourceIconViewer.create(a[b]);this.flow.append(c)}},onAddAction:function(a){a=a.getElements();for(var b=this.getRights(),c=[],d=0;d<a.length;d++)c.push({user:a[d].getResource().getId(),read:b.read,write:b.write,admin:b.admin});this.resource.addRights(c);this.fireEvent("done",
this)},getContextActions:function(a,b){return this.filterIconViewer.hasInstance(a)?{add:{text:"Ajouter",icon:"plus","default":!0,callback:this.onAddActionBinded,multiple:!0}}:b}},{},{types:void 0,constructor:function(){KJing.ResourceRightCreator.types={}},register:function(a,b,c,d,e){KJing.ResourceRightCreator.types[a]={type:a,creator:b,icon:c,text:d,uploader:e}},getTypesDefs:function(){return KJing.ResourceRightCreator.types},getTypeDef:function(a){if(void 0!==KJing.ResourceRightCreator.types[a])return KJing.ResourceRightCreator.types[a];
for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.ResourceRightCreator.types[a])return KJing.ResourceRightCreator.types[a]}});KJing.ResourceRightCreator.extend("KJing.ResourceUserRightCreator",{constructor:function(a){this.setFilterType("user");this.setFilterIconViewer(KJing.UserIconViewer)}});KJing.ResourceRightCreator.extend("KJing.ResourceGroupRightCreator",{constructor:function(a){this.setFilterType("group");this.setFilterIconViewer(KJing.GroupIconViewer)}});
KJing.ResourceRightCreator.register("rightuser",KJing.ResourceUserRightCreator,"person","Utilisateur");KJing.ResourceRightCreator.register("rightgroup",KJing.ResourceGroupRightCreator,"group","Groupe de personne");KJing.NewIcon.extend("KJing.ResourceRightNewIcon",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.connect(this,"press",this.onNewPress)},onNewPress:function(){(new KJing.CreatorDialog({title:"Ajouter un droit",resource:this.resource,types:KJing.ResourceRightCreator.getTypesDefs()})).open()}});KJing.IconViewer.extend("KJing.WebAccount",{label:void 0,accountIcon:void 0,user:void 0,constructor:function(a){this.addEvents("delete");this.user=a.user;delete a.user;this.setItemIcon("google")},getUser:function(){return this.user},setAccountIcon:function(a){this.setItemIcon(a)},"delete":function(){this.fireEvent("delete",this)},testDeleteRight:function(){var a=this.user.getData(),b=0;null!==a.login&&b++;null!==a.googleid&&b++;null!==a.facebookid&&b++;return 1<b}});
Ui.Dialog.extend("KJing.WebAccountNewDialog",{user:void 0,path:void 0,constructor:function(a){this.addEvents("done");this.user=a.user;delete a.user;this.setTitle("Nouveau compte Web");this.setPreferredWidth(400);this.setPreferredHeight(400);this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.VBox({spacing:5});this.setContent(a);var b=this.user.getData();if(null===b.login){var c=new Ui.Button({icon:"localaccount",text:"HOST",orientation:"horizontal"});this.connect(c,"press",this.onLocalPress);
a.append(c)}null===b.googleid&&(c=new Ui.Button({icon:"google",text:"Google",orientation:"horizontal"}),this.connect(c,"press",this.onGooglePress),a.append(c));null===b.facebookid&&(c=new Ui.Button({icon:"facebook",text:"Facebook",orientation:"horizontal"}),this.connect(c,"press",this.onFacebookPress),a.append(c))},onLocalPress:function(){var a=new Ui.VBox({spacing:10});this.setContent(a);var b=new Ui.TextField,c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Identifiant",textAlign:"right",
verticalAlign:"center",width:100}));c.append(b,!0);a.append(c);passwordField=new Ui.TextField({passwordMode:!0});c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Mot de passe",textAlign:"right",verticalAlign:"center",width:100}));c.append(passwordField,!0);a.append(c);var d=new Ui.Text({color:"red"});d.hide();a.append(d);var e=void 0,f=new Ui.Button({text:"Cr\u00e9er"});this.connect(f,"press",function(){var a=new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.user.getId(),content:JSON.stringify({type:"user",
login:b.getValue(),password:passwordField.getValue()})});this.connect(a,"done",function(){this.close();this.user.getData().login=b.getValue();this.fireEvent("done",this,new KJing.LocalAccount({user:this.user}))});this.connect(a,"error",function(a){var b=a.getStatus(),c="Echec de la cr\u00e9ation. V\u00e9rifier vos donn\u00e9es";403==b?1==a.getResponseJSON().code&&(c="Echec: mot de passe trop faible"):409==b&&(c="Echec: identifiant d\u00e9j\u00e0 utilis\u00e9");void 0!==e&&e.abort();d.setText(c);d.show();
e=new Core.DelayedTask({scope:this,delay:4,callback:function(){d.hide()}});this.getContent().enable();f.enable()});this.getContent().disable();f.disable();a.send()});this.setActionButtons([f])},onGooglePress:function(){this.setContent(new Ui.Text({verticalAlign:"center",textAlign:"center",text:"En attente d'authorization..."}));var a=window.open("/cloud/googleoauth2/redirect?state=grant","googleoauth");this.connect(a,"unload",function(){this.close()})},onFacebookPress:function(){this.setContent(new Ui.Text({verticalAlign:"center",
textAlign:"center",text:"En attente d'authorization..."}));var a=window.open("/cloud/facebookoauth2/redirect?state=grant","facebookoauth");this.connect(a,"unload",function(){this.close()})}});
Ui.Dialog.extend("KJing.GoogleAccountDialog",{user:void 0,account:void 0,constructor:function(a){this.user=a.user;delete a.user;this.account=a.account;delete a.account;this.setPreferredWidth(400);this.setTitle("Compte Google");this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.Button({text:"Supprimer"});this.connect(a,"press",this.onDeletePress);var b=new Ui.VBox({spacing:10});this.setContent(b);var c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Identifiant",textAlign:"right",verticalAlign:"center",
width:100}));c.append(new Ui.Text({text:this.user.getData().googleid}),!0);b.append(c);this.account.testDeleteRight()&&this.setActionButtons([a])},onDeletePress:function(){this.account["delete"]();this.close()}});
KJing.WebAccount.extend("KJing.GoogleAccount",{constructor:function(a){this.setAccountIcon("google");this.setText("Google")},onGoogleEdit:function(){(new KJing.GoogleAccountDialog({user:this.getUser(),account:this})).open()},onGoogleDelete:function(){this["delete"]()}},{"delete":function(){(new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.getUser().getId(),content:JSON.stringify({googleid:null})})).send();this.fireEvent("delete",this)},getSelectionActions:function(){return{"delete":{text:"Supprimer",
icon:"trash",color:"#d02020",testRight:this.testDeleteRight,scope:this,callback:this.onGoogleDelete,multiple:!1},edit:{"default":!0,text:"Modifier",icon:"pen",scope:this,callback:this.onGoogleEdit,multiple:!1}}}});
Ui.Dialog.extend("KJing.FacebookAccountDialog",{user:void 0,account:void 0,constructor:function(a){this.user=a.user;delete a.user;this.account=a.account;delete a.account;this.setPreferredWidth(400);this.setTitle("Compte Facebook");this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.Button({text:"Supprimer"});this.connect(a,"press",this.onDeletePress);var b=new Ui.VBox({spacing:10});this.setContent(b);var c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Identifiant",textAlign:"right",verticalAlign:"center",
width:100}));c.append(new Ui.Text({text:this.user.getData().facebookid}),!0);b.append(c);this.account.testDeleteRight()&&this.setActionButtons([a])},onDeletePress:function(){this.account["delete"]();this.close()}});
KJing.WebAccount.extend("KJing.FacebookAccount",{constructor:function(a){this.setAccountIcon("facebook");this.setText("Facebook")},onFacebookEdit:function(){(new KJing.FacebookAccountDialog({user:this.getUser(),account:this})).open()},onFacebookDelete:function(){this["delete"]()}},{"delete":function(){(new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.getUser().getId(),content:JSON.stringify({facebookid:null})})).send();this.fireEvent("delete",this)},getSelectionActions:function(){return{"delete":{text:"Supprimer",
icon:"trash",color:"#d02020",testRight:this.testDeleteRight,scope:this,callback:this.onFacebookDelete,multiple:!1},edit:{"default":!0,text:"Modifier",icon:"pen",scope:this,callback:this.onFacebookEdit,multiple:!1}}}});
Ui.Dialog.extend("KJing.LocalAccountDialog",{user:void 0,account:void 0,loginField:void 0,passwordField:void 0,deleteButton:void 0,saveButton:void 0,errorMessage:void 0,errorTimeout:void 0,constructor:function(a){this.user=a.user;delete a.user;this.account=a.account;delete a.account;this.setPreferredWidth(400);this.setTitle("Compte local");this.setCancelButton(new Ui.DialogCloseButton);this.deleteButton=new Ui.Button({text:"Supprimer"});this.connect(this.deleteButton,"press",this.onDeletePress);this.saveButton=
new Ui.DefaultButton({text:"Enregistrer"});this.connect(this.saveButton,"press",this.onSavePress);a=new Ui.VBox({spacing:10});this.setContent(a);this.loginField=new Ui.TextField({value:this.user.getData().login});var b=new Ui.HBox({spacing:10});b.append(new Ui.Text({text:"Identifiant",textAlign:"right",verticalAlign:"center",width:100}));b.append(this.loginField,!0);a.append(b);this.passwordField=new Ui.TextField({textHolder:"********",passwordMode:!0});b=new Ui.HBox({spacing:10});b.append(new Ui.Text({text:"Mot de passe",
textAlign:"right",verticalAlign:"center",width:100}));b.append(this.passwordField,!0);a.append(b);this.errorMessage=new Ui.Text({color:"red"});this.errorMessage.hide();a.append(this.errorMessage);this.account.testDeleteRight()?this.setActionButtons([this.deleteButton,this.saveButton]):this.setActionButtons([this.saveButton])},onDeletePress:function(){this.account["delete"]();this.close()},onSavePress:function(){var a={};void 0!=this.passwordField.getValue()&&""!=this.passwordField.getValue()&&(a.password=
this.passwordField.getValue());a.login=this.loginField.getValue();a=new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.user.getId(),content:JSON.stringify(a)});this.connect(a,"done",this.onSaveDone);this.connect(a,"error",this.onSaveError);this.getContent().disable();this.saveButton.disable();this.deleteButton.disable();a.send()},onSaveDone:function(){this.close()},onSaveError:function(a){var b="Echec de la modification. V\u00e9rifier vos donn\u00e9es";403==a.getStatus()&&1==a.getResponseJSON().code&&
(b="Echec: mot de passe trop faible");this.showError(b);this.getContent().enable();this.saveButton.enable();this.deleteButton.enable()},showError:function(a){void 0!=this.errorTimeout&&this.errorTimeout.abort();this.errorMessage.setText(a);this.errorMessage.show();this.errorTimeout=new Core.DelayedTask({scope:this,delay:4,callback:this.onShowErrorTimeout})},onShowErrorTimeout:function(){void 0!==this.errorTimeout&&(this.errorTimeout.abort(),this.errorTimeout=void 0,this.errorMessage.hide());this.errorTimeout=
void 0;this.errorMessage.hide()}});
KJing.WebAccount.extend("KJing.LocalAccount",{constructor:function(a){this.setAccountIcon("localaccount");this.setText("Local")},onLocalEdit:function(){(new KJing.LocalAccountDialog({user:this.getUser(),account:this})).open()},onLocalDelete:function(){this["delete"]()}},{"delete":function(){(new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.user.getId(),content:JSON.stringify({login:null,password:null})})).send();this.fireEvent("delete",this)},getSelectionActions:function(){return{"delete":{text:"Supprimer",icon:"trash",
color:"#d02020",testRight:this.testDeleteRight,scope:this,callback:this.onLocalDelete,multiple:!1},edit:{"default":!0,text:"Modifier",icon:"pen",scope:this,callback:this.onLocalEdit,multiple:!1}}}});
KJing.OptionSection.extend("KJing.WebAccountSection",{flow:void 0,user:void 0,plus:void 0,googleAccount:void 0,facebookAccount:void 0,localAccount:void 0,constructor:function(a){this.user=a.user;delete a.user;this.setTitle("Comptes Web");this.selection=[];this.flow=new Ui.Flow({uniform:!0});this.setContent(this.flow);this.plus=new KJing.NewIcon;this.flow.append(this.plus);this.connect(this.plus,"press",this.onPlusPress)},testPlus:function(){4<=this.flow.getChildren().length?this.plus.hide(!0):this.plus.show()},
onPlusPress:function(){(new KJing.WebAccountNewDialog({user:this.user})).open()},onUserChange:function(){null!==this.user.getData().googleid&&void 0===this.googleAccount?(this.googleAccount=new KJing.GoogleAccount({user:this.user}),this.flow.prepend(this.googleAccount)):null===this.user.getData().googleid&&void 0!==this.googleAccount&&(this.flow.remove(this.googleAccount),this.googleAccount=void 0);null!==this.user.getData().facebookid&&void 0===this.facebookAccount?(this.facebookAccount=new KJing.FacebookAccount({user:this.user}),
this.flow.prepend(this.facebookAccount)):null===this.user.getData().facebookid&&void 0!==this.facebookAccount&&(this.flow.remove(this.facebookAccount),this.facebookAccount=void 0);null!==this.user.getData().login&&void 0===this.localAccount?(this.localAccount=new KJing.LocalAccount({user:this.user}),this.flow.prepend(this.localAccount)):null===this.user.getData().login&&void 0!==this.localAccount&&(this.flow.remove(this.localAccount),this.localAccount=void 0);this.testPlus()}},{onLoad:function(){KJing.WebAccountSection.base.onLoad.call(this);
this.connect(this.user,"change",this.onUserChange);this.onUserChange()},onUnload:function(){KJing.WebAccountSection.base.onUnload.call(this);this.disconnect(this.user,"change",this.onUserChange)}});Ui.SFlow.extend("KJing.ResourceCreator",{nameField:void 0,resource:void 0,resourceType:"resource",valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.setStretchMaxRatio(5);this.nameField=new KJing.TextField({title:"Nom",width:150});this.connect(this.nameField,"change",this.checkValid);this.append(this.nameField)},setType:function(a){this.type=a},create:function(){var a=new Core.HttpRequest({method:"POST",
url:"/cloud/resource",content:JSON.stringify({type:this.type,parent:this.resource.getId(),name:this.nameField.getValue()})});this.connect(a,"done",this.onRequestDone);this.connect(a,"done",this.onRequestFail);this.valid=!1;this.fireEvent("notvalid",this);a.send()},onRequestFail:function(){this.valid=!0;this.fireEvent("valid",this)},onRequestDone:function(){this.fireEvent("done",this)},checkValid:function(){var a=""!==this.nameField.getValue();this.valid!==a&&((this.valid=a)?this.fireEvent("valid",
this):this.fireEvent("notvalid",this))}},{},{types:void 0,constructor:function(){KJing.ResourceCreator.types={}},register:function(a,b,c,d,e){KJing.ResourceCreator.types[a]={type:a,creator:b,icon:c,text:d,uploader:e}},getTypesDefs:function(){return KJing.ResourceCreator.types},getTypeDef:function(a){if(void 0!==KJing.ResourceCreator.types[a])return KJing.ResourceCreator.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.ResourceCreator.types[a])return KJing.ResourceCreator.types[a]}});Ui.SFlow.extend("KJing.ResourceProperties",{resource:void 0,nameField:void 0,createTimeField:void 0,modifyTimeField:void 0,positionField:void 0,quotaField:void 0,rightsSection:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.setSpacing(5);this.setStretchMaxRatio(10);this.build()},formatSize:function(a){return 1E9<a?(a/1E9).toFixed(2)+" Go":1E6<a?(a/1E6).toFixed(2)+" Mo":1E3<a?(a/1E3).toFixed(2)+" ko":a+" octets"},formatDate:function(a){var b=
"",b=10>a.getDate()?b+("0"+a.getDate()):b+a.getDate(),b=b+"/",b=10>a.getMonth()+1?b+("0"+(a.getMonth()+1)):b+(a.getMonth()+1),b=b+("/"+a.getFullYear()+" "),b=10>a.getHours()?b+("0"+a.getHours()):b+a.getHours(),b=b+":",b=10>a.getMinutes()?b+("0"+a.getMinutes()):b+a.getMinutes(),b=b+":";return b=10>a.getSeconds()?b+("0"+a.getSeconds()):b+a.getSeconds()},formatDuration:function(a){return 7200<a?(a/3600).toFixed(2)+" H":120<a?(a/60).toFixed(2)+" min":2<a?a.toFixed(2)+" s":1E3*a+" ms"},build:function(){this.nameField=
new KJing.TextField({title:"Nom",value:this.resource.getName(),width:400});this.append(this.nameField);this.append(new KJing.TextField({title:"Identifiant",value:this.resource.getId(),width:150,enable:!1}),void 0,"newline");this.quotaField=new KJing.TextField({title:"Stockage utilis\u00e9",value:this.formatSize(this.resource.getData().quotaBytesUsed),width:150,enable:!1});this.append(this.quotaField);this.positionField=new KJing.TextField({title:"Position",value:this.resource.getData().position,width:150});
this.append(this.positionField);this.createTimeField=new KJing.TextField({title:"Cr\u00e9ation",value:this.formatDate(new Date(this.resource.getData().ctime)),width:150,enable:!1});this.append(this.createTimeField,void 0,"newline");this.modifyTimeField=new KJing.TextField({title:"Modification",value:this.formatDate(new Date(this.resource.getData().mtime)),width:150,enable:!1});this.append(this.modifyTimeField);this.rightsSection=new KJing.ResourceRightsSection({resource:this.resource});this.append(this.rightsSection,
void 0,"newline")},getPropertiesJson:function(){return{name:this.nameField.getValue(),position:parseInt(this.positionField.getValue())}},save:function(){return this.resource.changeData(this.getPropertiesJson())}},{},{types:void 0,constructor:function(){KJing.ResourceProperties.types={}},register:function(a,b){KJing.ResourceProperties.types[a]={type:a,creator:b}},getTypeDef:function(a){if(void 0!==KJing.ResourceProperties.types[a])return KJing.ResourceProperties.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=
a.substring(0,b),void 0!==KJing.ResourceProperties.types[a])return KJing.ResourceProperties.types[a];if(void 0!==KJing.ResourceProperties.types.resource)return KJing.ResourceProperties.types.resource}});KJing.ResourceProperties.register("resource",KJing.ResourceProperties);Ui.LBox.extend("KJing.ResourceControllerViewer",{controller:void 0,constructor:function(a){this.controller=a.controller;delete a.controller},getController:function(){return this.controller}},{},{types:void 0,constructor:function(){KJing.ResourceControllerViewer.types={}},register:function(a,b){KJing.ResourceControllerViewer.types[a]={type:a,creator:b}},getTypesDefs:function(){return KJing.ResourceControllerViewer.types},getTypeDef:function(a){if(void 0!==KJing.ResourceControllerViewer.types[a])return KJing.ResourceControllerViewer.types[a];
for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.ResourceControllerViewer.types[a])return KJing.ResourceControllerViewer.types[a]},create:function(a){var b=KJing.ResourceControllerViewer.getTypeDef(a.getResource().getType());return void 0===b?new KJing.ResourceControllerViewer({controller:a}):new b.creator({controller:a})}});KJing.OptionSection.extend("KJing.ResourceRightsSection",{resource:void 0,flow:void 0,constructor:function(a){this.setTitle("Droits");this.resource=a.resource;delete a.resource;this.flow=new Ui.Flow({spacing:5,uniform:!0});this.setContent(this.flow);if(this.resource.getIsReady())this.onResourceChange()},onResourceChange:function(){this.flow.clear();var a=new KJing.ResourceRightNewIcon({resource:this.resource});this.flow.append(a);for(var a=this.resource.getRights(),b=0;b<a.length;b++){var c=new KJing.RightIconViewer({resource:this.resource,
right:a[b]});this.flow.append(c)}this.resource.canAdmin()||this.flow.disable()}},{onLoad:function(){KJing.ResourceRightsSection.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange)},onUnload:function(){KJing.ResourceRightsSection.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange)}});
Ui.Dialog.extend("KJing.ResourcePropertiesDialog",{resource:void 0,propertiesViewer:void 0,saveButton:void 0,constructor:function(a){this.setFullScrolling(!0);this.setPreferredWidth(500);this.setPreferredHeight(500);this.setTitle("Propri\u00e9t\u00e9s");this.resource=a.resource;delete a.resource;this.propertiesViewer=new (KJing.ResourceProperties.getTypeDef(this.resource.getType()).creator)({resource:this.resource});this.setContent(this.propertiesViewer);this.setCancelButton(new Ui.DialogCloseButton);
Ui.App.current.getUser().isAdmin()||this.resource.canWrite()?(a=new Ui.Button({text:"Supprimer"}),this.connect(a,"press",this.onDeletePress),this.saveButton=new Ui.DefaultButton({text:"Enregistrer"}),this.connect(this.saveButton,"press",this.onSavePress),this.setActionButtons([a,this.saveButton])):this.propertiesViewer.disable()},onDeletePress:function(){this.resource.suppress();this.close()},onSavePress:function(){this.propertiesViewer.disable();this.saveButton.disable();var a=this.propertiesViewer.save();
this.connect(a,"done",function(){this.close()});this.connect(a,"error",function(){this.close()})}});Ui.Dialog.extend("KJing.CreatorDialog",{transBox:void 0,resource:void 0,prevButton:void 0,createButton:void 0,creator:void 0,selector:void 0,types:void 0,dialogTitle:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;"types"in a&&(this.types=a.types,delete a.types);this.setTitle("Nouvelle ressource");this.setFullScrolling(!0);this.setPreferredWidth(500);this.setPreferredHeight(450);this.transBox=new Ui.TransitionBox;this.setContent(this.transBox);this.selector=new KJing.CreatorSelector({types:this.types});
this.connect(this.selector,"done",this.onSelectorDone);this.transBox.replaceContent(this.selector);this.setCancelButton(new Ui.DialogCloseButton({text:"Annuler"}));this.prevButton=new Ui.Button({text:"Pr\u00e9c\u00e9dent"});this.connect(this.prevButton,"press",this.onPrevPress);this.createButton=new Ui.DefaultButton({text:"Cr\u00e9er"});this.connect(this.createButton,"press",this.onCreatePress)},onSelectorDone:function(a,b,c){this.dialogTitle=this.getTitle();this.setTitle(b.text);this.setActionButtons([this.prevButton,
this.createButton]);this.creator=void 0!==c?new b.creator({resource:this.resource,file:c}):new b.creator({resource:this.resource});this.transBox.replaceContent(this.creator);this.connect(this.creator,"done",this.onCreatorDone);this.connect(this.creator,"valid",this.onCreatorValid);this.connect(this.creator,"notvalid",this.onCreatorNotvalid);this.onCreatorNotvalid(this.creator)},onPrevPress:function(){this.setTitle(this.dialogTitle);this.setActionButtons([]);this.transBox.replaceContent(this.selector);
void 0!==this.creator&&(this.disconnect(this.creator,"done",this.onCreatorDone),this.disconnect(this.creator,"valid",this.onCreatorValid),this.disconnect(this.creator,"notvalid",this.onCreatorNovalid),this.creator=void 0)},onCreatePress:function(){this.creator.create()},onCreatorDone:function(){this.close();this.resource.update()},onCreatorValid:function(){this.createButton.enable()},onCreatorNotvalid:function(){this.createButton.disable()}});Ui.Element.extend("KJing.MediaController",{controller:void 0,state:"initial",duration:void 0,position:void 0,isReady:!1,constructor:function(a){this.addEvents("ready","ended","timeupdate","bufferingupdate","statechange","error");this.controller=a.controller;delete a.controller},play:function(){this.controller.sendOrder({order:"play"})},pause:function(){this.controller.sendOrder({order:"pause"})},getDuration:function(){return this.duration},setCurrentTime:function(a){this.controller.sendOrder({order:"seek",
time:a})},getCurrentTime:function(){return this.position*this.duration},getState:function(){return this.state},getIsReady:function(){return this.isReady},onControllerChange:function(){this.duration!==this.controller.getDuration()&&(this.duration=this.controller.getDuration());this.state!==this.controller.getState()&&void 0!==this.controller.getState()&&(this.state=this.controller.getState(),this.fireEvent("statechange",this,this.state));this.position!==this.controller.getPosition()&&void 0!==this.controller.getPosition()&&
(this.position=this.controller.getPosition(),this.fireEvent("timeupdate",this,this.getCurrentTime(),this.getDuration()));this.isReady||(this.isReady=this.controller.getIsReady()&&void 0!==this.duration)&&this.fireEvent("ready",this)}},{onLoad:function(){KJing.MediaController.base.onLoad.apply(this,arguments);this.connect(this.controller,"change",this.onControllerChange);if(this.controller.getIsReady())this.onControllerChange()},onUnload:function(){KJing.MediaController.base.onUnload.apply(this,arguments);
this.disconnect(this.controller,"change",this.onControllerChange)}});Core.Object.extend("KJing.Message",{message:void 0,ready:!1,request:void 0,searchText:"",constructor:function(a){this.addEvents("ready","change","delete");if("message"in a)this.message=a.message,delete a.message,this.updateData(this.message);else if("id"in a){var b=a.id;delete a.id;this.message={id:b};this.update()}},getIsReady:function(){return this.ready},update:function(){void 0!==this.request&&(this.disconnect(this.request,"done",this.onGetMessageDone),this.disconnect(this.request,"error",this.onGetMessageError),
this.request.abort());this.request=new Core.HttpRequest({url:"/cloud/message/"+this.message.id});this.connect(this.request,"done",this.onGetMessageDone);this.connect(this.request,"error",this.onGetMessageError);this.request.send()},updateData:function(a){this.message=a;this.updateSearchText();this.ready||(this.ready=!0,this.fireEvent("ready",this));this.fireEvent("change",this)},updateSearchText:function(){var a=this.getDate();this.searchText=a.getDate()-1+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+
" ";a=this.message.origin===Ui.App.current.getUser().getId()?KJing.Resource.create(this.message.destination):KJing.Resource.create(this.message.origin);void 0!==a&&(this.searchText+=a.getName()+" ");this.searchText="resource"===this.message.type?this.searchText+("partage ressource "+this.message.content.name):"contact"===this.message.type?this.searchText+"ajoute contact":"comment"===this.message.type?this.searchText+("commentaire ressource "+this.message.content.resource.name):"call"===this.message.type?
this.searchText+"appel video":this.searchText+this.message.content;this.searchText=this.searchText.toLowerCase().toNoDiacritics()},getMessage:function(){return this.message},getId:function(){return this.message.id},getType:function(){return this.message.type},getOrigin:function(){return this.message.origin},getDestination:function(){return this.message.destination},getSeen:function(){return-1!==this.message.seen},getDate:function(){return new Date(1E3*this.message.create)},getContent:function(){return this.message.content},
getSearchText:function(){return this.searchText},markSeen:function(){this.getSeen()||(new Core.HttpRequest({method:"PUT",url:"/cloud/message/"+this.message.id})).send()},onGetMessageError:function(a){404==a.getStatus()&&this.fireEvent("delete",this);this.request=void 0},onGetMessageDone:function(a){a=a.getResponseJSON();this.updateData(a);this.request=void 0}});Core.Object.extend("KJing.Messages",{user:void 0,ready:!1,data:void 0,request:void 0,messages:void 0,socket:void 0,monitorCount:0,retryTask:void 0,constructor:function(a){this.addEvents("ready","change","error","monitor","unmonitor");this.user=a.user;delete a.user;this.messages=[];this.update()},getUser:function(){return this.user},getIsReady:function(){return this.ready},getData:function(){return this.data},update:function(){if(void 0===this.request){var a="/cloud/message?limit=30&user="+this.user.getId();
this.request=new Core.HttpRequest({url:a});this.connect(this.request,"done",this.onGetDataDone);this.connect(this.request,"error",this.onGetDataError);this.request.send()}},updateData:function(a){this.data=a;a=[];for(var b=0;b<this.data.length;b++){for(var c=void 0,d=0;void 0===c&&d<this.messages.length;d++)this.messages[d].getId()===this.data[b].id&&(c=this.messages[d]);void 0!==c?(c.updateData(this.data[b]),a.push(c)):a.push(new KJing.Message({message:this.data[b]}))}this.messages=a;this.ready||
(this.ready=!0,this.fireEvent("ready",this));this.fireEvent("change",this)},getMessages:function(){return this.messages},getUnseenMessages:function(){for(var a=[],b=0;b<this.messages.length;b++)this.messages[b].getSeen()||a.push(this.messages[b]);return a},monitor:function(){this.retryTask=void 0;this.monitorCount++;if(void 0===this.socket){var a="/cloud/message/"+this.user.getId();this.socket=new Core.Socket({service:a});this.connect(this.socket,"message",this.onMessageReceived);this.connect(this.socket,
"error",this.onSocketError);this.connect(this.socket,"close",this.onSocketClose)}},unmonitor:function(){0<this.monitorCount&&(0>=--this.monitorCount&&void 0!==this.socket)&&(this.socket.close(),this.socket=void 0);void 0!==this.retryTask&&(this.retryTask.abort(),this.retryTask=void 0)},onGetDataError:function(a){this.fireEvent("error",this);this.request=void 0},onGetDataDone:function(a){a=a.getResponseJSON();this.updateData(a);this.request=void 0},onMessageReceived:function(a,b){JSON.parse(b);this.update()},
onSocketError:function(){this.socket.close()},onSocketClose:function(){this.socket=void 0;void 0!==this.connectionId&&this.fireEvent("unmonitor",this);this.connectionMessageCount=this.connectionId=void 0;0<this.monitorCount&&(this.retryTask=new Core.DelayedTask({delay:5,scope:this,callback:function(){this.retryTask=void 0;if(0<this.monitorCount&&void 0===this.socket){var a="/cloud/message/"+this.user.getId();this.socket=new Core.Socket({service:a});this.connect(this.socket,"message",this.onMessageReceived);
this.connect(this.socket,"error",this.onSocketError);this.connect(this.socket,"close",this.onSocketClose)}}}))},sendMessage:function(a,b,c){void 0===c&&(c="message");KJing.User.hasInstance(a)&&(a=a.getId());a=new Core.HttpRequest({method:"POST",url:"/cloud/message",content:JSON.stringify({content:b,type:c,origin:this.user.getId(),destination:a})});a.send();return a}});Ui.Pressable.extend("KJing.MessageView",{user:void 0,sourceFace:void 0,message:void 0,dialog:void 0,destinationFace:void 0,contact:void 0,previewBox:void 0,label:void 0,dateLabel:void 0,showDestination:!0,showSource:!0,source:void 0,destination:void 0,bg:void 0,constructor:function(a){this.user=a.user;delete a.user;this.message=a.message;delete a.message;"dialog"in a&&(this.dialog=a.dialog,delete a.dialog);"showSource"in a&&(this.showSource=a.showSource,delete a.showSource);"showDestination"in a&&
(this.showDestination=a.showDestination,delete a.showDestination);this.message.getOrigin()===this.user.getId()?this.source=this.user:this.source=KJing.Resource.create(this.message.getOrigin());this.message.getDestination()===this.user.getId()?this.destination=this.user:this.destination=KJing.Resource.create(this.message.getDestination());this.bg=new Ui.Rectangle;this.append(this.bg);a=new Ui.HBox({spacing:10});this.append(a);var b=new Ui.LBox({verticalAlign:"top",horizontalAlign:"right"});b.append(new Ui.Rectangle({fill:"#f1f1f1",
margin:0}));this.sourceFace=new Ui.Image({width:32,height:32,margin:0});b.append(this.sourceFace);this.showSource&&a.append(b);b=new Ui.VBox({spacing:5});a.append(b,!0);this.dateLabel=new Ui.Text({opacity:0.8,fontSize:10,textAlign:"left"});this.updateDateLabel();b.append(this.dateLabel);this.label=new Ui.Text({text:""});b.append(this.label);"message"===this.message.getType()&&this.label.setText(this.message.getContent());b=new Ui.LBox({verticalAlign:"top",horizontalAlign:"right"});b.append(new Ui.Rectangle({fill:"#f1f1f1",
margin:0}));this.destinationFace=new Ui.Image({width:32,height:32,margin:0});b.append(this.destinationFace);this.showDestination&&a.append(b);this.setLock("contact"!==this.message.getType()&&"resource"!==this.message.getType()&&"message"===this.message.getType()&&Ui.Dialog.hasInstance(this.dialog));this.connect(this,"press",this.onMessageViewPress)},updateDateLabel:function(){var a;a=this.source===this.user?"Moi, ":this.source.getName()+", ";var b=new Date-this.message.getDate();if(604800>b){var c=
Math.floor(b/864E5),d=Math.floor(b/36E5),b=Math.floor(b/6E4);a+="il y a ";a=0<c?a+(c+" jours"):0<d?a+(d+" heures"):a+(b+" minutes")}else a+="le ",c=this.message.getDate(),a+=c.getDate()-1+"/"+(c.getMonth()+1)+"/"+c.getFullYear();this.dateLabel.setText(a)},setAllowMessage:function(a){a?this.setLock(!1):this.setLock("message"===this.message.getType())},onBothReady:function(){this.updateDateLabel();var a;if(this.message.getOrigin()===this.user.getId()){var b=this.destination.getName()+" ";a="J'ai ";
a="resource"===this.message.getType()?a+('partag\u00e9 la ressource "'+this.message.getContent().name+'" avec '+b):"contact"===this.message.getType()?a+("ajout\u00e9 "+b+" \u00e0 mes contacts"):"call"===this.message.getType()?a+("pass\u00e9 un appel vid\u00e9o \u00e0 "+b):this.message.getContent()}else a=this.source.getName()+" ",a="resource"===this.message.getType()?a+('vous a partag\u00e9 la ressource "'+this.message.getContent().name+'"'):"contact"==this.message.getType()?a+"vous a ajout\u00e9 \u00e0 ses contacts":
"call"===this.message.getType()?a+"vous a appel\u00e9 en vid\u00e9o":this.message.getContent();this.label.setText(a)},onDestinationChange:function(){void 0!==this.destination.getFaceUrl()&&this.destinationFace.setSrc(this.destination.getFaceUrl());if(this.source.getIsReady())this.onBothReady()},onMessageViewPress:function(){this.message.markSeen();if("message"==this.message.getType()){var a;a=this.message.getOrigin()===this.user.getId()?this.destination:this.source;(new KJing.ContactMessagesDialog({user:this.user,
contact:a})).open()}else"resource"==this.message.getType()?(Ui.App.current.setMainStack([{text:"Root",resource:Ui.App.current.getUser()},{text:this.source.getName(),resource:this.source},{text:this.message.getContent().name,resource:KJing.Resource.create(this.message.getContent().id)}]),void 0!==this.dialog&&Ui.Dialog.hasInstance(this.dialog)&&this.dialog.close()):"contact"==this.message.getType()&&(Ui.App.current.setMainPath("user:"+this.message.getContent()),void 0!==this.dialog&&Ui.Dialog.hasInstance(this.dialog)&&
this.dialog.close())},onSourceChange:function(){void 0!==this.source.getFaceUrl()&&this.sourceFace.setSrc(this.source.getFaceUrl());if(this.destination.getIsReady())this.onBothReady()},getMessage:function(){return this.message},getSearchText:function(){return this.dateLabel.getText()+" "+this.label.getText()}},{onStyleChange:function(){this.bg.setFill(this.getStyleProperty("background"))},onLoad:function(){KJing.MessageView.base.onLoad.apply(this,arguments);if(void 0!==this.source){if(this.source.getIsReady())this.onSourceChange();
this.connect(this.source,"change",this.onSourceChange)}if(void 0!==this.destination){if(this.destination.getIsReady())this.onDestinationChange();this.connect(this.destination,"change",this.onDestinationChange)}},onUnload:function(){KJing.MessageView.base.onUnload.apply(this,arguments);void 0!==this.source&&this.disconnect(this.source,"change",this.onSourceChange);void 0!==this.destination&&this.disconnect(this.destination,"change",this.onDestinationChange)}},{style:{background:"rgba(250, 250, 250, 0)"}});Ui.LBox.extend("KJing.ContactNewMessage",{user:void 0,contact:void 0,userface:void 0,textfield:void 0,sendButton:void 0,text:void 0,request:void 0,vbox:void 0,constructor:function(a){this.addEvents("new");this.user=a.user;delete a.user;this.contact=a.contact;delete a.contact;var b=new Ui.VBox;this.vbox=b;this.append(b);a=new Ui.HBox({spacing:5});b.append(a,!0);b=new Ui.LBox({verticalAlign:"top",horizontalAlign:"right",margin:0});a.append(b);b.append(new Ui.Rectangle({fill:"#999999"}));b.append(new Ui.Rectangle({fill:"#f1f1f1",
margin:1}));this.userface=new Ui.Image({width:32,height:32,margin:1});b.append(this.userface);this.textfield=new Ui.TextAreaField({margin:0,marginLeft:0,textHolder:"Un message ?"});this.connect(this.textfield.textarea,"focus",this.onTextAreaFocus);this.connect(this.textfield.textarea,"blur",this.onTextAreaBlur);this.connect(this.textfield,"change",function(a,b){""==b?this.sendButton.disable():this.sendButton.enable()});a.append(this.textfield,!0);this.sendButton=new Ui.DefaultButton({text:"Envoyer",
horizontalAlign:"right",marginBottom:10,marginRight:10});this.sendButton.disable();this.connect(this.sendButton,"press",this.onButtonPress)},onTextAreaFocus:function(){void 0==this.sendButton.getParent()&&this.vbox.append(this.sendButton)},onTextAreaBlur:function(){void 0!==this.sendButton.getParent()&&""===this.textfield.getValue()&&this.vbox.remove(this.sendButton)},onUserChange:function(){void 0!==this.user.getFaceUrl()&&this.userface.setSrc(this.user.getFaceUrl())},onButtonPress:function(){this.text=
this.textfield.getValue();this.request=Ui.App.current.getMessages().sendMessage(this.contact,this.text,"message");this.connect(this.request,"done",this.onRequestDone);this.connect(this.request,"error",this.onRequestError);this.disable()},onRequestDone:function(){this.fireEvent("new",this,this.text);this.textfield.setValue("");this.enable();this.request=void 0},onRequestError:function(){this.textfield.setValue("");this.enable();this.request=void 0}},{onLoad:function(){KJing.ContactNewMessage.base.onLoad.call(this);
this.connect(this.user,"change",this.onUserChange);this.onUserChange()},onUnload:function(){KJing.ContactNewMessage.base.onUnload.call(this);this.disconnect(this.user,"change",this.onUserChange)}});
Ui.Dialog.extend("KJing.ContactMessagesDialog",{user:void 0,contact:void 0,messagesView:void 0,startMessageId:-1,messageRequest:void 0,messages:void 0,transBox:void 0,messagesPart:void 0,videoconfPart:void 0,constructor:function(a){this.user=a.user;delete a.user;this.contact=a.contact;delete a.contact;this.setFullScrolling(!1);this.setTitle("Messages");this.setPreferredWidth(600);this.setPreferredHeight(600);this.setCancelButton(new Ui.DialogCloseButton);this.messagesPart=new Ui.ScrollingArea;this.setContent(this.messagesPart);
a=new Ui.VBox({margin:10,spacing:10});this.messagesPart.setContent(a);a.append(new KJing.ContactNewMessage({user:this.user,contact:this.contact}));this.messagesView=new Ui.VBox({spacing:15});a.append(this.messagesView);this.updateMessages()},updateMessages:function(){void 0!==this.messagesRequest&&(this.disconnect(this.messagesRequest,"done",this.onGetMessagesDone),this.disconnect(this.messagesRequest,"error",this.onGetMessagesError),this.messagesRequest.abort());this.messagesRequest=new Core.HttpRequest({url:"/cloud/message?limit=100&user="+
this.user.getId()+"&with="+this.contact.getId()});this.connect(this.messagesRequest,"done",this.onGetMessagesDone);this.connect(this.messagesRequest,"error",this.onGetMessagesError);this.messagesRequest.send()},onGetMessagesDone:function(){var a=this.messagesRequest.getResponseJSON();this.messages=[];for(var b=0;b<a.length;b++)this.messages.push(new KJing.Message({message:a[b]}));this.updateMessagesView();this.messagesRequest=void 0},onGetMessagesError:function(){this.messagesRequest=void 0},findMessageView:function(a){for(var b=
0;b<this.messagesView.getChildren().length;b++)if(KJing.MessageView.hasInstance(this.messagesView.getChildren()[b])&&this.messagesView.getChildren()[b].getMessage().getId()==a.getId())return this.messagesView.getChildren()[b]},updateMessagesView:function(){if(void 0!==this.messages){for(var a=[],b=this.messages,c,d=b.length-1;0<=d;d--){var e=void 0,f=b[d].getDate();void 0!==c&&(c.getFullYear()!=f.getFullYear()?(e=new Ui.HBox({spacing:10}),e.append(new Ui.Label({text:c.getFullYear(),fontSize:14,fontWeight:"bold"})),
e.append(new Ui.Separator({verticalAlign:"center"}),!0)):c.getMonth()!=f.getMonth()&&(e=new Ui.HBox({spacing:10}),e.append(new Ui.Separator({verticalAlign:"center",width:10})),e.append(new Ui.Label({text:"Janvier F\u00e9vrier Mars Avril Mai Juin Juillet Ao\u00fbt Septembre Octobre Novembre D\u00e9cembre".split(" ")[c.getMonth()],fontSize:12})),e.append(new Ui.Separator({verticalAlign:"center"}),!0)));c=f;b[d].getOrigin()===this.user.getId()?b[d].getDestination()==this.contact.getId()&&(f=this.findMessageView(b[d]),
void 0==f&&(void 0!==e&&this.messagesView.prepend(e),f=new KJing.MessageView({user:this.user,message:b[d],dialog:this,showDestination:!1}),this.messagesView.prepend(f))):b[d].getOrigin()===this.contact.getId()&&(f=this.findMessageView(b[d]),void 0==f&&(void 0!==e&&this.messagesView.prepend(e),f=new KJing.MessageView({user:this.user,message:b[d],dialog:this,showDestination:!1}),this.messagesView.prepend(f),!b[d].getSeen()&&"message"===b[d].getType()&&a.push(b[d])))}for(d=0;d<a.length;d++)a[d].markSeen()}},
onMessagesChange:function(){if(void 0!==this.messages){for(var a=Ui.App.current.getMessages().getMessages(),b=a.length-1;0<=b;b--){for(var c=a[b],d=void 0,e=0;void 0===d&&e<this.messages.length;e++)this.messages[e].getId()===c.getId()&&(d=this.messages[e]);void 0===d&&this.messages.unshift(c)}this.updateMessagesView()}}},{onLoad:function(){KJing.ContactMessagesDialog.base.onLoad.apply(this,arguments);this.connect(Ui.App.current.getMessages(),"change",this.onMessagesChange)},onUnload:function(){KJing.ContactMessagesDialog.base.onUnload.apply(this,
arguments);this.disconnect(Ui.App.current.getMessages(),"change",this.onMessagesChange)}});KJing.MessageView.extend("KJing.UserNotifyView",{constructor:function(a){this.setAllowMessage(!0)}});
Ui.ScrollLoader.extend("KJing.MessagesLoader",{user:void 0,dialog:void 0,data:void 0,filteredData:void 0,constructor:function(a){this.user=a.user;delete a.user;this.dialog=a.dialog;delete a.dialog;this.data=a.data;delete a.data;this.filteredData=this.data},testFilter:function(a,b){for(var c=!0,d=0;c&&d<a.length;d++)c=-1!==b.indexOf(a[d]);return c},setFilter:function(a){var b;if(void 0!==a&&""!==a){b=a.split(" ");for(a=0;a<b.length;a++)b[a]=b[a].toLowerCase().toNoDiacritics()}this.filteredData=[];
for(a=0;a<this.data.length;a++){var c=this.data[a];void 0===b?this.filteredData.push(c):this.testFilter(b,c.getSearchText())&&this.filteredData.push(c)}this.fireEvent("change")}},{getMin:function(){return 0},getMax:function(){return this.filteredData.length-1},getElementAt:function(a){if(!(a>this.filteredData.length-1))return this.filteredData[a].getOrigin()===this.user.getId()?new KJing.MessageView({user:this.user,message:this.filteredData[a],dialog:this.dialog,showSource:!1,marginBottom:20}):new KJing.MessageView({user:this.user,
message:this.filteredData[a],dialog:this.dialog,showDestination:!1,marginBottom:20})}});
Ui.Dialog.extend("KJing.HistoryMessagesDialog",{messages:void 0,user:void 0,messagesView:void 0,messagesLoader:void 0,constructor:function(a){this.messages=a.messages;delete a.messages;this.user=this.messages.getUser();this.setPreferredWidth(600);this.setPreferredHeight(600);this.setTitle("Historique des messages");this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.TextButtonField({buttonIcon:"search",width:150});this.connect(a,"validate",this.onSearchValidate);Ui.Box.setResizable(a,!0);this.setActionButtons([a]);
a=new Core.HttpRequest({url:"/cloud/message?limit=5000&user="+this.user.getId()});this.connect(a,"done",function(a){a=a.getResponseJSON();for(var c=[],d=0;d<a.length;d++){var e=new KJing.Message({message:a[d]});"comment"!=e.getType()&&c.push(e)}this.messagesLoader=new KJing.MessagesLoader({user:this.user,dialog:this,data:c});a=new Ui.VBoxScrollingArea({loader:this.messagesLoader});this.setContent(a)});a.send()},onSearchValidate:function(a,b){void 0!==this.messagesLoader&&this.messagesLoader.setFilter(b)}});
Ui.MenuPopup.extend("KJing.HistoryMessagesPopup",{messages:void 0,user:void 0,notifyView:void 0,noNotifyMessage:void 0,messagesView:void 0,startMessageId:-1,constructor:function(a){this.messages=a.messages;delete a.messages;this.user=this.messages.getUser();this.setPreferredWidth(400);this.setPreferredHeight(400);a=new Ui.VBox({margin:10,spacing:10});this.setContent(a);a.append(new Ui.Text({text:"Notifications",fontWeight:"bold"}));this.notifyView=new Ui.VBox({spacing:10});a.append(this.notifyView);
this.noNotifyMessage=new Ui.Text({margin:15,textAlign:"center",text:"il n'y a pas de nouveau message"});this.noNotifyMessage.hide(!0);a.append(this.noNotifyMessage);this.markAllSeenButton=new Ui.DefaultButton({icon:"done",text:"Tout valider",horizontalAlign:"right"});this.markAllSeenButton.hide(!0);this.connect(this.markAllSeenButton,"press",this.onMarkAllSeenPress);a.append(this.markAllSeenButton);a.append(new Ui.Text({text:"Messages anciens",fontWeight:"bold"}));this.messagesView=new Ui.VBox({spacing:20});
a.append(this.messagesView);var b=new Ui.DefaultButton({text:"Plus de messages...",marginBottom:10});this.connect(b,"press",this.onMorePress);a.append(b)},findNotifyView:function(a){for(var b=0;b<this.notifyView.getChildren().length;b++)if(KJing.UserNotifyView.hasInstance(this.notifyView.getChildren()[b])&&this.notifyView.getChildren()[b].getMessage().getId()==a.getId())return this.notifyView.getChildren()[b]},findMessageView:function(a){for(var b=0;b<this.messagesView.getChildren().length;b++)if(KJing.MessageView.hasInstance(this.messagesView.getChildren()[b])&&
this.messagesView.getChildren()[b].getMessage().getId()==a.getId())return this.messagesView.getChildren()[b]},updateNotifyView:function(){for(var a=this.messages.getMessages(),b=0,c=a.length-1;0<=c;c--)if(!a[c].getSeen()&&a[c].getOrigin()!==this.user.getId()){var d=this.findNotifyView(a[c]);void 0===d&&(d=a[c].getOrigin()===this.user.getId()?new KJing.UserNotifyView({user:this.user,message:a[c],dialog:this,showSource:!1}):new KJing.UserNotifyView({user:this.user,message:a[c],dialog:this,showDestination:!1}),
this.notifyView.prepend(d),b++)}a=[];for(c=0;c<this.notifyView.getChildren().length;c++)b=this.notifyView.getChildren()[c],KJing.UserNotifyView.hasInstance(b)&&b.getMessage().getSeen()&&a.push(this.notifyView.getChildren()[c]);for(c=0;c<a.length;c++)this.notifyView.remove(a[c]);0===this.notifyView.getChildren().length?(this.noNotifyMessage.show(),this.markAllSeenButton.hide(!0)):(this.noNotifyMessage.hide(!0),this.markAllSeenButton.show())},updateMessagesView:function(){for(var a=this.messages.getMessages(),
b=a.length-1;0<=b;b--)if(a[b].getSeen()){var c=this.findMessageView(a[b]);a[b].getOrigin()===this.user.getId()?void 0==c&&(c=new KJing.MessageView({user:this.user,message:a[b],dialog:this,showSource:!1}),this.messagesView.prepend(c)):void 0==c&&(c=new KJing.MessageView({user:this.user,message:a[b],dialog:this,showDestination:!1}),this.messagesView.prepend(c))}},onMessagesChange:function(){this.updateNotifyView();this.updateMessagesView()},onMarkAllSeenPress:function(){for(var a=0;a<this.messages.getMessages().length;a++){var b=
this.messages.getMessages()[a];b.getDestination()===this.user.getId()&&!b.getSeen()&&b.markSeen()}},onMorePress:function(){this.close();(new KJing.HistoryMessagesDialog({messages:this.messages})).open()}},{onLoad:function(){KJing.HistoryMessagesPopup.base.onLoad.apply(this,arguments);this.connect(this.messages,"change",this.onMessagesChange);this.onMessagesChange()},onUnload:function(){KJing.HistoryMessagesPopup.base.onUnload.apply(this,arguments);this.disconnect(this.messages,"change",this.onMessagesChange)}});Ui.LBox.extend("KJing.WizardItem",{data:void 0,isDone:!1,constructor:function(a){this.data=a.data;delete a.data;this.addEvents("done")},getData:function(){return this.data},getIsDone:function(){return this.isDone},done:function(){this.isDone||(this.isDone=!0,this.fireEvent("done"))},save:function(){this.onSave()},onSave:function(){}});Core.Object.extend("KJing.LoginCreator",{data:void 0,session:void 0,isDone:!1,constructor:function(a){this.data=a.data;delete a.data;this.session=a.session;delete a.session;this.addEvents("done","fail")},getIsDone:function(){return this.isDone},getData:function(){return this.data},getSession:function(){return this.session},done:function(a){this.isDone||(this.isDone=!0,this.fireEvent("done",this,a))},fail:function(){this.fireEvent("fail",this)}});KJing.WizardItem.extend("KJing.LoginWizardSelector",{selectItem:void 0,constructor:function(a){this.addEvents("choose");var b=new Ui.VBox({uniform:!0,spacing:10});this.setContent(b);for(var c=KJing.LoginWizard.getWizardTypes(),d=0;d<c.length;d++){var e=KJing.LoginWizard.getWizard(c[d]),e=new Ui.Button({icon:e.icon,text:e.name,orientation:"horizontal"});this.connect(e,"press",this.onItemPress);e.hostLoginWizardSelector=c[d];b.append(e)}delete a.wizardType},getSelectedType:function(){return this.selectItem.hostLoginWizardSelector},
onItemPress:function(a){this.selectItem=a;this.fireEvent("done",this)}});
Ui.Dialog.extend("KJing.LoginWizard",{previousButton:void 0,nextButton:void 0,transBox:void 0,position:0,current:void 0,wizardType:void 0,data:void 0,constructor:function(a){this.addEvents("done");this.setTitle("Connexion");this.setFullScrolling(!0);this.setPreferredWidth(450);this.setPreferredHeight(450);this.setAutoClose(!1);this.data={};this.previousButton=new Ui.Button({text:"Pr\u00e9c\u00e9dent"});this.previousButton.hide();this.connect(this.previousButton,"press",this.onPreviousPress);this.nextButton=
new Ui.DefaultButton({text:"Suivant"});this.connect(this.nextButton,"press",this.onNextPress);this.transBox=new Ui.TransitionBox;this.setContent(this.transBox);this.current=new KJing.LoginWizardSelector;this.transBox.replaceContent(this.current);this.connect(this.current,"done",this.onItemDone);this.nextButton.disable()},onPreviousPress:function(){this.position--;this.disconnect(this.current,"done",this.onItemDone);this.current.save();0>this.position&&(this.position=0);if(0==this.position)this.setTitle("Connexion"),
this.current=new KJing.LoginWizardSelector({wizardType:this.wizardType}),this.previousButton.hide(),this.setActionButtons(void 0);else{var a=KJing.LoginWizard.getWizard(this.wizardType);this.setTitle(a.name);this.current=new a.array[this.position-1]({data:this.data})}this.nextButton.setText("Suivant");this.connect(this.current,"done",this.onItemDone);this.transBox.replaceContent(this.current);this.current.getIsDone()?this.nextButton.enable():this.nextButton.disable()},onItemDone:function(){if(0==
this.position)this.onNextPress();this.nextButton.enable()},onNextPress:function(){this.position++;this.disconnect(this.current,"done",this.onItemDone);this.current.save();this.nextButton.disable();this.previousButton.show();1==this.position&&(this.setActionButtons([this.previousButton,this.nextButton]),this.wizardType!=this.current.getSelectedType()&&(this.wizardType=this.current.getSelectedType(),this.data={}));var a=KJing.LoginWizard.getWizard(this.wizardType);this.position>a.array.length?(a=new a.creator({data:this.data,
item:this.current}),this.disable(),this.connect(a,"done",this.onCreatorDone),this.connect(a,"fail",this.onCreatorFail)):(this.setTitle(a.name),this.current=new a.array[this.position-1]({data:this.data}),this.position==a.array.length?this.nextButton.setText(a.endlabel):this.nextButton.setText("Suivant"),this.connect(this.current,"done",this.onItemDone),this.transBox.replaceContent(this.current))},onCreatorDone:function(a,b){this.close();this.fireEvent("done",this,b)},onCreatorFail:function(){this.enable();
this.position--;this.nextButton.enable()}},{},{apps:void 0,constructor:function(){this.apps={}},register:function(a,b,c,d,e,f){KJing.LoginWizard.apps[a]={name:b,icon:c,array:d,creator:e,endlabel:f}},getWizardTypes:function(){var a=[],b;for(b in KJing.LoginWizard.apps)a.push(b);return a},getWizard:function(a){return KJing.LoginWizard.apps[a]}});KJing.LoginCreator.extend("KJing.Local.Creator",{item:void 0,constructor:function(a){this.item=a.item;delete a.item;a=new Core.HttpRequest({method:"POST",url:"/cloud/user/login",content:JSON.stringify({login:this.getData().login,password:this.getData().password})});this.connect(a,"done",this.onLoginBasicDone);this.connect(a,"error",this.onLoginBasicFails);a.send()},onLoginBasicDone:function(a){"localStorage"in window&&(this.data.localstore?(localStorage.setItem("login",this.data.login),localStorage.setItem("password",
this.data.password)):(localStorage.removeItem("login"),localStorage.removeItem("password")));this.done()},onLoginBasicFails:function(){this.fail();this.item.showError()}});
KJing.WizardItem.extend("KJing.Local.Wizard",{loginField:void 0,passwordField:void 0,localStoreField:void 0,errorMessage:void 0,errorTimeout:void 0,constructor:function(a){a=new Ui.SFlow({spacing:5,itemAlign:"stretch",stretchMaxRatio:5});this.setContent(a);this.loginField=new KJing.TextField({title:"Identifiant",width:250});this.connect(this.loginField,"change",this.onChange);a.append(this.loginField);this.passwordField=new KJing.TextField({title:"Mot de passe",passwordMode:!0,width:250});this.connect(this.passwordField,
"change",this.onChange);a.append(this.passwordField);this.localStoreField=new Ui.CheckBox({text:"Se souvenir de moi"});"localStorage"in window&&a.append(this.localStoreField);this.errorMessage=new Ui.Text({text:"Echec: Identifiant ou mot de passe incorrect",color:"red"});this.errorMessage.hide();a.append(this.errorMessage);a=this.getData();void 0!=a.login?this.loginField.setValue(a.login):"localStorage"in window&&void 0!=localStorage.getItem("login")&&this.loginField.setValue(localStorage.getItem("login"));
void 0!=a.password?this.passwordField.setValue(a.password):"localStorage"in window&&void 0!=localStorage.getItem("password")&&this.passwordField.setValue(localStorage.getItem("password"));void 0!=a.localstore?this.localStoreField.setValue(a.localstore):"localStorage"in window&&(void 0!=localStorage.getItem("password")||void 0!=localStorage.getItem("login"))&&this.localStoreField.setValue(!0);this.onChange()},showError:function(){void 0!=this.errorTimeout&&this.errorTimeout.abort();this.errorMessage.show();
this.errorTimeout=new Core.DelayedTask({scope:this,delay:4,callback:this.onShowErrorTimeout})},onShowErrorTimeout:function(){this.errorTimeout=void 0;this.errorMessage.hide()},onChange:function(){void 0!=this.errorTimeout&&(this.errorTimeout.abort(),this.errorTimeout=void 0,this.errorMessage.hide());""!=this.loginField.getValue()&&""!=this.passwordField.getValue()&&this.done()}},{onSave:function(){var a=this.getData();a.login=this.loginField.getValue();a.password=this.passwordField.getValue();a.localstore=
this.localStoreField.getValue()}});KJing.LoginWizard.register("local","Local","localaccount",[KJing.Local.Wizard],KJing.Local.Creator,"Connecter");KJing.WizardItem.extend("KJing.Google.Wizard",{constructor:function(a){this.setContent(new Ui.Text({text:"Redirection en cours...",textAlign:"center",verticalAlign:"center"}));location="/cloud/googleoauth2/redirect?state=create"}});KJing.WizardItem.extend("KJing.Facebook.Wizard",{constructor:function(a){this.setContent(new Ui.Text({text:"Redirection en cours...",textAlign:"center",verticalAlign:"center"}));location="/cloud/facebookoauth2/redirect?state=create"}});KJing.LoginCreator.extend("KJing.Create.Creator",{item:void 0,newuser:void 0,newresources:void 0,resources:void 0,constructor:function(a){this.item=a.item;delete a.item;a=new Core.HttpRequest({method:"POST",url:"/cloud/resource",content:JSON.stringify({type:"user",login:this.getData().login,password:this.getData().password,firstname:this.getData().firstname,lastname:this.getData().lastname})});this.connect(a,"done",this.onCreateUserDone);this.connect(a,"error",this.onCreateUserError);a.send()},onCreateUserError:function(a){var b=
a.getStatus(),c="Echec de la cr\u00e9ation. V\u00e9rifier vos donn\u00e9es";409==b?c="Echec: l'identifiant existe d\u00e9j\u00e0":403==b&&1==a.getResponseJSON().code&&(c="Echec: mot de passe trop faible");this.item.showError(c);this.fail()},onCreateUserDone:function(){var a=new Core.HttpRequest({method:"POST",url:"/cloud/user/login",content:JSON.stringify({login:this.getData().login,password:this.getData().password})});this.connect(a,"done",this.onLoginBasicDone);this.connect(a,"error",this.onLoginBasicFails);
a.send()},onLoginBasicDone:function(){this.done()},onLoginBasicFails:function(){this.fail()}});
KJing.WizardItem.extend("KJing.Create.Wizard",{firstnameField:void 0,lastnameField:void 0,loginField:void 0,passwordField:void 0,errorMessage:void 0,errorTimeout:void 0,constructor:function(a){a=new Ui.SFlow({spacing:10,itemAlign:"stretch",stretchMaxRatio:5});this.setContent(a);this.firstnameField=new KJing.TextField({title:"Pr\u00e9nom",width:150});this.connect(this.firstnameField,"change",this.onChange);a.append(this.firstnameField);this.lastnameField=new KJing.TextField({title:"Nom",width:150});
this.connect(this.lastnameField,"change",this.onChange);a.append(this.lastnameField);this.loginField=new KJing.TextField({title:"Identifiant",width:400});this.connect(this.loginField,"change",this.onChange);a.append(this.loginField);this.passwordField=new KJing.TextField({title:"Mot de passe",width:400,passwordMode:!0,desc:"8 caract\u00e8res minimum avec chiffre et lettre"});this.connect(this.passwordField,"change",this.onChange);a.append(this.passwordField);this.errorMessage=new Ui.Text({text:"Echec de la cr\u00e9ation. V\u00e9rifier vos donn\u00e9es",
color:"red"});this.errorMessage.hide();a.append(this.errorMessage);a=this.getData();void 0!==a.login&&this.loginField.setValue(a.login);void 0!==a.password&&this.passwordField.setValue(a.password);this.onChange()},showError:function(a){void 0!==this.errorTimeout&&this.errorTimeout.abort();this.errorMessage.setText(a);this.errorMessage.show();this.errorTimeout=new Core.DelayedTask({scope:this,delay:4,callback:this.onShowErrorTimeout})},onShowErrorTimeout:function(){void 0!=this.errorTimeout&&(this.errorTimeout.abort(),
this.errorTimeout=void 0,this.errorMessage.hide());this.errorTimeout=void 0;this.errorMessage.hide()},onChange:function(){""!=this.firstnameField.getValue()&&(""!=this.lastnameField.getValue()&&""!=this.loginField.getValue()&&""!=this.passwordField.getValue())&&this.done()}},{onSave:function(){var a=this.getData();a.firstname=this.firstnameField.getValue();a.lastname=this.lastnameField.getValue();a.login=this.loginField.getValue();a.password=this.passwordField.getValue()}});
KJing.LoginWizard.register("create","Nouveau compte","plus",[KJing.Create.Wizard],KJing.Create.Creator,"Cr\u00e9er");KJing.ResourceCreator.extend("KJing.FolderCreator",{constructor:function(a){this.setType("folder")}});KJing.ResourceCreator.register("folder",KJing.FolderCreator,"folder","Classeur");KJing.ResourceIcon.extend("KJing.FolderIcon",{constructor:function(a){this.setIcon("folder");a=this.onIconEffect.bind(this);this.addType(KJing.Folder,a);this.addType(KJing.File,a);this.addType(KJing.Group,a);this.addType(KJing.User,a);this.addType(KJing.Map,a);this.addType("files",["copy"]);this.connect(this,"dropfile",this.onIconDropFile);this.connect(this,"drop",this.onIconDrop);this.connect(this,"dragenter",this.onIconDragEnter);this.connect(this,"dragleave",this.onIconDragLeave)},onIconEffect:function(a){return this.getResource().canWrite()?
a.getParentId()===this.resource.getId()?[]:a.getOwnerId()===this.resource.getOwnerId()?a.getId()===this.resource.getId()||a.getIsParentOf(this.resource)?[]:KJing.File.hasInstance(a)?["move","copy","link"]:["move","link"]:KJing.File.hasInstance(a)?["copy","link"]:["link"]:[]},onIconDropFile:function(a,b,c,d,e){a=new Core.FilePostUploader({file:b,service:"/cloud/file"});c=Ui.App.current.addUploader(a);b="file:"+b.getMimetype().replace("/",":");a.setField("define",JSON.stringify({type:b,parent:this.getResource().getId(),
position:0,uploader:c}));a.send()},onIconDrop:function(a,b,c,d,e){KJing.Resource.hasInstance(b)&&("move"===c?b.setParent(this.getResource()):"link"===c?(a=new Core.HttpRequest({method:"POST",url:"/cloud/link",content:JSON.stringify({type:"link",parent:this.getResource().getId(),link:b.getId()})}),a.send()):"copy"===c&&(a=new Core.HttpRequest({method:"POST",url:"/cloud/file/"+encodeURIComponent(b.getId())+"/copy",content:JSON.stringify({type:"file",parent:this.resource.getId(),position:0})}),a.send()))},
onIconDragEnter:function(){this.setIcon("folderopen")},onIconDragLeave:function(){this.setIcon("folder")}});KJing.ResourceIcon.register("folder",KJing.FolderIcon);KJing.ResourceIconViewer.extend("KJing.FolderIconViewer",{});KJing.ResourceIconViewer.register("folder",KJing.FolderIconViewer);KJing.ResourceViewer.extend("KJing.FolderViewer",{newItem:void 0,flow:void 0,constructor:function(a){this.flow=new Ui.FlowDropBox({uniform:!0});this.setContent(this.flow);a=this.onItemEffect.bind(this);this.flow.addType(KJing.Folder,a);this.flow.addType(KJing.File,a);this.flow.addType(KJing.Group,a);this.flow.addType(KJing.User,a);this.flow.addType(KJing.Map,a);this.flow.addType(KJing.Link,a);this.flow.addType("files",this.onFileEffect.bind(this));this.connect(this.flow,"dropat",this.onItemDropAt);
this.connect(this.flow,"dropfileat",this.onItemDropFileAt);this.newItem=new KJing.ResourceNewIcon({resource:this.resource});this.flow.append(this.newItem);this.resource.getIsChildrenReady()||this.resource.loadChildren();this.onResourceChange()},onFileEffect:function(){return this.getResource().canWrite()?["copy"]:[]},onItemEffect:function(a,b){if(this.getResource().canWrite()){if(a.getParentId()===this.resource.getId()){for(var c=this.flow.getLogicalChildren(),d=void 0,e=0;void 0===d&&e<c.length;e++){var f=
c[e];KJing.ResourceIconViewer.hasInstance(f)&&f.getResource().getId()===a.getId()&&(d=e)}return 0<c.length&&!KJing.ResourceIconViewer.hasInstance(c[0])&&0===b||void 0===d||b===d||b===d+1?[]:KJing.File.hasInstance(a)?["move","copy"]:["move"]}return a.getOwnerId()===this.resource.getOwnerId()?a.getId()===this.resource.getId()||a.getIsParentOf(this.resource)?[]:KJing.File.hasInstance(a)?["move","copy","link"]:["move","link"]:KJing.File.hasInstance(a)?["copy","link"]:["link"]}return[]},onItemDropAt:function(a,
b,c,d,e,f){console.log(this+".onItemDropAt "+b+", effect: "+c+", pos: "+d);d--;KJing.Resource.hasInstance(b)&&("move"===c?(b.getParentId()===this.resource.getId()&&d>b.getData().position&&d--,b.changeData({parent:this.resource.getId(),position:d})):"link"===c?(a=new Core.HttpRequest({method:"POST",url:"/cloud/link",content:JSON.stringify({type:"link",parent:this.resource.getId(),position:d,link:b.getId()})}),a.send()):"copy"===c&&(a=new Core.HttpRequest({method:"POST",url:"/cloud/file/"+encodeURIComponent(b.getId())+
"/copy",content:JSON.stringify({type:this.resource.getType(),parent:this.resource.getId(),position:d})}),a.send()))},onItemDropFileAt:function(a,b,c,d,e,f){d--;console.log(this+".onItemDropFileAt mimetype: "+(""===b.getMimetype()));a="file:"+b.getMimetype().replace("/",":");b=new Core.FilePostUploader({file:b,service:"/cloud/file"});c=Ui.App.current.addUploader(b);b.setField("define",JSON.stringify({type:a,parent:this.resource.getId(),position:d,uploader:c}));this.connect(b,"error",this.onUploadError);
this.connect(b,"complete",this.onUploadError);b.send()},onUploadError:function(a){this.resource.update()},onResourceChange:function(){this.newItem.setDisabled(!this.getResource().canWrite());KJing.ResourceViewer.updateChildren(this.flow,this.flow.getLogicalChildren(),1,this.getResource().getChildren())}},{onLoad:function(){KJing.FolderViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.FolderViewer.base.onUnload.apply(this,
arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});KJing.ResourceViewer.register("resource",KJing.FolderViewer);KJing.ResourceViewer.register("folder",KJing.FolderViewer);Ui.UploadButton.extend("KJing.UploadFaceButton",{user:void 0,image:void 0,constructor:function(a){this.user=a.user;delete a.user;this.image=new Ui.Image({width:64,height:64,margin:10});this.setIcon(this.image)},onUploadComplete:function(a){this.user.update()},onUserChange:function(){this.image.setSrc(this.user.getFaceUrl())}},{onFile:function(a,b){KJing.UploadFaceButton.base.onFile.apply(this,arguments);var c=new Core.FilePostUploader({file:b,service:"/cloud/user/"+this.user.getId()+"/face"});this.connect(c,
"complete",this.onUploadComplete);Ui.App.current.addUploader(c);c.send()},onLoad:function(){KJing.UploadFaceButton.base.onLoad.call(this);this.connect(this.user,"change",this.onUserChange);this.onUserChange()},onUnload:function(){KJing.UploadFaceButton.base.onUnload.call(this);this.disconnect(this.user,"change",this.onUserChange)}});KJing.ResourceProperties.extend("KJing.UserProperties",{userAvatarButton:void 0,userQuotaField:void 0,firstnameField:void 0,lastnameField:void 0,emailField:void 0,descriptionField:void 0,adminField:void 0,webSection:void 0},{build:function(){KJing.UserProperties.base.build.apply(this,arguments);this.remove(this.nameField);var a=this.getChildPosition(this.quotaField);this.remove(this.quotaField);this.userQuotaField=new KJing.QuotaField({title:"Stockage utilis\u00e9",unit:"byte",editor:Ui.App.current.getUser().isAdmin(),
disabled:!Ui.App.current.getUser().isAdmin(),value:{used:this.resource.getData().quotaBytesUsed,max:this.resource.getData().quotaBytesMax}});this.insertAt(this.userQuotaField,a);a=0;this.userAvatarButton=new KJing.UploadFaceButton({user:this.resource,marginLeft:10});this.insertAt(this.userAvatarButton,a++,"right","flush");this.firstnameField=new KJing.TextField({title:"Pr\u00e9nom",width:150,value:this.resource.getData().firstname});this.insertAt(this.firstnameField,a++);this.lastnameField=new KJing.TextField({title:"Nom",
width:150,value:this.resource.getData().lastname});this.insertAt(this.lastnameField,a++);this.emailField=new KJing.TextField({title:"Email",width:250,value:this.resource.getData().email});this.insertAt(this.emailField,a++,void 0,"newline");this.descriptionField=new KJing.TextAreaField({title:"Description",width:250,value:this.resource.getData().description});this.insertAt(this.descriptionField,a++);Ui.App.current.getUser().isAdmin()&&(this.adminField=new Ui.CheckBox({text:"Compte administrateur",
value:this.resource.getData().admin}),this.resource.getId()===Ui.App.current.getUser().getId()&&this.adminField.disable(),this.insertAt(this.adminField,a++));this.resource.canAdmin()&&(this.webSection=new KJing.WebAccountSection({user:this.resource}),this.insertAt(this.webSection,a++))},getPropertiesJson:function(){var a=KJing.UserProperties.base.getPropertiesJson.apply(this,arguments);a.firstname=this.firstnameField.getValue();a.lastname=this.lastnameField.getValue();a.email=this.emailField.getValue();
a.description=this.descriptionField.getValue();Ui.App.current.getUser().isAdmin()&&(a.admin=this.adminField.getValue(),a.quotaBytesMax=this.userQuotaField.getValue().max,0>a.quotaBytesMax&&(a.quotaBytesMax=null));return a}});KJing.ResourceProperties.register("user",KJing.UserProperties);Ui.SFlow.extend("KJing.UserCreator",{resource:void 0,firstnameField:void 0,lastnameField:void 0,loginField:void 0,passwordField:void 0,valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.setStretchMaxRatio(5);this.firstnameField=new KJing.TextField({title:"Pr\u00e9nom",width:100});this.connect(this.firstnameField,"change",this.checkValid);this.append(this.firstnameField);this.lastnameField=new KJing.TextField({title:"Nom",
width:100});this.connect(this.lastnameField,"change",this.checkValid);this.append(this.lastnameField);this.loginField=new KJing.TextField({title:"Identifiant",width:200});this.connect(this.loginField,"change",this.checkValid);this.append(this.loginField);this.passwordField=new KJing.TextField({title:"Mot de passe",width:200,passwordMode:!0,desc:"8 caract\u00e8res minimum avec chiffre et lettre"});this.connect(this.passwordField,"change",this.checkValid);this.append(this.passwordField)},create:function(){var a=
new Core.HttpRequest({method:"POST",url:"/cloud/resource",content:JSON.stringify({type:"user",parent:this.resource.getId(),firstname:this.firstnameField.getValue(),lastname:this.lastnameField.getValue(),login:this.loginField.getValue(),password:this.passwordField.getValue()})});this.connect(a,"done",this.onRequestDone);this.connect(a,"done",this.onRequestFail);this.valid=!1;this.fireEvent("notvalid",this);a.send()},onRequestFail:function(){this.valid=!0;this.fireEvent("valid",this)},onRequestDone:function(){this.fireEvent("done",
this)},checkValid:function(){var a=""!==this.loginField.getValue(),b=this.passwordField.getValue(),a=a&""!==b&8<=b.length;this.valid!==a&&((this.valid=a)?this.fireEvent("valid",this):this.fireEvent("notvalid",this))}});KJing.ResourceIcon.extend("KJing.UserIcon",{constructor:function(a){this.setRoundMode(!0);this.setIcon("person")}},{onResourceChange:function(){void 0!==this.getResource().getFaceUrl()&&this.setImage(this.getResource().getFaceUrl());var a=this.getResource().getIsConnected(),b=this.getTags();void 0===b&&(b=[]);for(var c=0;c<b.length;c++){var d=b[c];if("object"===typeof d&&"connected"===d.icon)break}a&&c>=b.length?(b.push({icon:"connected",color:"#24e455"}),this.setTags(b)):!a&&c<b.length&&(b.splice(c,
1),this.setTags(b))}});KJing.ResourceIcon.register("user",KJing.UserIcon);KJing.ResourceIconViewer.extend("KJing.UserIconViewer",{constructor:function(a){},testAdminRight:function(){return Ui.App.current.getUser().getId()!==this.getResource().getId()&&Ui.App.current.getUser().isAdmin()},onSwitch:function(){var a=new Ui.Dialog({title:"Connexion au compte",fullScrolling:!1,preferredWidth:400});a.setContent(new Ui.Text({text:'Voulez vous vraiment ouvrir une session sur le compte de "'+this.getResource().getName()+'" ? ATTENTION, vous ne serez plus sur votre compte et vous aller agir au nom de cette personne.'}));
a.setCancelButton(new Ui.DialogCloseButton({text:"Annuler"}));var b=new Ui.DefaultButton({text:"Commuter"});a.setActionButtons([b]);this.connect(b,"press",function(){a.close();window.open("?user="+encodeURIComponent(this.getResource().getId()))});a.open()},onMessages:function(){(new KJing.ContactMessagesDialog({user:Ui.App.current.getUser(),contact:this.getResource()})).open()}},{getSelectionActions:function(){return{messages:{text:"Messages",icon:"bubble",scope:this,callback:this.onMessages,multiple:!1},
switchOrder:{text:"Commuter",icon:"switch",testRight:this.testAdminRight,scope:this,callback:this.onSwitch,multiple:!1},suppress:{text:"Supprimer",icon:"trash",testRight:this.testAdminRight,scope:this,callback:this.suppress,multiple:!1},edit:{text:"Propri\u00e9t\u00e9s",icon:"edit",scope:this,callback:this.onItemProperties,multiple:!1},open:{"default":!0,text:"Ouvrir",icon:"eye",scope:this,callback:this.open,multiple:!1}}}});KJing.ResourceIconViewer.register("user",KJing.UserIconViewer);KJing.ResourceViewer.extend("KJing.UserShareByViewer",{flow:void 0,newItem:void 0,constructor:function(a){this.flow=new Ui.Flow({spacing:5,uniform:!0});this.setContent(this.flow);this.newItem=new KJing.NewIcon({disabled:!0});this.flow.append(this.newItem);if(this.resource.getIsReady())this.onResourceChange()},onResourceChange:function(){KJing.ResourceViewer.updateChildren(this.flow,this.flow.getChildren(),1,this.resource.getSharesBy())}},{onLoad:function(){KJing.UserShareByViewer.base.onLoad.apply(this,
arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.UserShareByViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.extend("KJing.UserShareWithViewer",{dropbox:void 0,flow:void 0,newItem:void 0,onResourceUnshareBinded:void 0,constructor:function(a){this.dropbox=new Ui.DropBox;this.setContent(this.dropbox);a=this.onItemEffect.bind(this);this.dropbox.addType(KJing.Resource,a);this.connect(this.dropbox,"drop",this.onItemDrop);this.flow=new Ui.Flow({spacing:5,uniform:!0});this.dropbox.setContent(this.flow);this.newItem=new KJing.NewIcon({disabled:!0});this.flow.append(this.newItem);this.onResourceUnshareBinded=
this.onResourceUnshare.bind(this);if(this.resource.getIsReady())this.onResourceChange()},onItemEffect:function(a){return a.canAdmin()?["share"]:[]},onItemDrop:function(a,b,c,d,e){a=b.addRights([{user:this.resource.getId(),read:!0,write:!1,admin:!1}]);this.connect(a,"done",function(){this.resource.update()})},onResourceChange:function(){KJing.ResourceViewer.updateChildren(this.flow,this.flow.getChildren(),1,this.resource.getSharesWith())},testWriteRight:function(a){return this.getResource().canWrite()},
onResourceUnshare:function(a){a=a.getElements();for(var b=0;b<a.length;b++)a[b].getResource().addRights([{user:this.resource.getId(),read:!1,write:!1,admin:!1}])},getContextActions:function(a,b){KJing.ResourceIconViewer.hasInstance(a)&&(delete b.suppress,b.suppress={text:"Retirer",icon:"trash",testRight:this.testWriteRight,callback:this.onResourceUnshareBinded,multiple:!0});return b}},{onLoad:function(){KJing.UserShareWithViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",
this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.UserShareWithViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.extend("KJing.UserViewer",{viewMode:void 0,constructor:function(a){Ui.App.current.getUser().getId()===this.getResource().getId()?this.setViewMode("resource"):this.setViewMode("shareBy")},setViewMode:function(a){a!==this.viewMode&&(this.viewMode=a,"resource"===this.viewMode?this.setContent(new KJing.FolderViewer({resource:this.resource})):"shareBy"===this.viewMode?this.setContent(new KJing.UserShareByViewer({resource:this.resource})):this.setContent(new KJing.UserShareWithViewer({resource:this.resource})))}},
{getState:function(){return{viewMode:this.viewMode}},setState:function(a){void 0!==a&&void 0!==a.viewMode&&this.setViewMode(a.viewMode)},getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});a.setContent(b);if(Ui.App.current.getUser().isAdmin()&&Ui.App.current.getUser().getId()!==this.getResource().getId()){var c=new Ui.SegmentBar({margin:10,orientation:"horizontal",field:"text",data:[{text:"Ressources",value:"resource"},{text:"Partag\u00e9 par",value:"shareBy"},{text:"Partag\u00e9 avec",
value:"shareWith"}]});b.append(c);"resource"===this.viewMode?c.setCurrentPosition(0):"shareWith"===this.viewMode?c.setCurrentPosition(2):c.setCurrentPosition(1);this.connect(c,"change",function(b,c){this.setViewMode(c.value);a.close()})}else Ui.App.current.getUser().getId()!==this.getResource().getId()&&(c=new Ui.SegmentBar({margin:10,orientation:"horizontal",field:"text",data:[{text:"Partag\u00e9 par",value:"shareBy"},{text:"Partag\u00e9 avec",value:"shareWith"}]}),b.append(c),"shareWith"===this.viewMode?
c.setCurrentPosition(1):c.setCurrentPosition(0),this.connect(c,"change",function(b,c){this.setViewMode(c.value);a.close()}));c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.close()});b.append(c);return a}});KJing.ResourceViewer.register("user",KJing.UserViewer);KJing.ResourceCreator.extend("KJing.GroupCreator",{constructor:function(a){this.setType("group")}});KJing.ResourceCreator.register("group",KJing.GroupCreator,"group","Groupe de personne");Ui.VBox.extend("KJing.GroupMemberCreator",{resource:void 0,searchField:void 0,flow:void 0,valid:!1,onAddActionBinded:void 0,filterType:void 0,filterIconViewer:void 0,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.append(this.searchField);this.flow=new Ui.Flow;this.append(this.flow);this.onAddActionBinded=this.onAddAction.bind(this)},
setFilterType:function(a){this.filterType=a},setFilterIconViewer:function(a){this.filterIconViewer=a},create:function(){this.fireEvent("done",this)},onSearchValidate:function(){var a=new KJing.Search({queryString:this.searchField.getValue(),filters:{type:this.filterType}});this.connect(a,"change",this.onSearchDone)},onSearchDone:function(a){this.flow.clear();a=a.getResources();for(var b=0;b<a.length;b++){var c=KJing.ResourceIconViewer.create(a[b]);this.flow.append(c)}},onSearchError:function(a){},
getContextActions:function(a,b){if(this.filterIconViewer.hasInstance(a))return{add:{text:"Ajouter",icon:"plus","default":!0,callback:this.onAddActionBinded,multiple:!0}}},onAddAction:function(a){a=a.getElements();for(var b=[],c=0;c<a.length;c++)b.push(a[c].getResource());this.resource.addUsers(b);this.fireEvent("done",this)}},{},{types:void 0,constructor:function(){KJing.GroupMemberCreator.types={}},register:function(a,b,c,d,e){KJing.GroupMemberCreator.types[a]={type:a,creator:b,icon:c,text:d,uploader:e}},
getTypesDefs:function(){return KJing.GroupMemberCreator.types},getTypeDef:function(a){if(void 0!==KJing.GroupMemberCreator.types[a])return KJing.GroupMemberCreator.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.GroupMemberCreator.types[a])return KJing.GroupMemberCreator.types[a]}});KJing.GroupMemberCreator.extend("KJing.GroupUserMemberCreator",{constructor:function(a){this.setFilterType("user");this.setFilterIconViewer(KJing.UserIconViewer)}});
KJing.GroupMemberCreator.extend("KJing.GroupGroupMemberCreator",{constructor:function(a){this.setFilterType("group");this.setFilterIconViewer(KJing.GroupIconViewer)}});KJing.GroupMemberCreator.register("groupuser",KJing.GroupUserMemberCreator,"person","Utilisateur");KJing.GroupMemberCreator.register("groupgroup",KJing.GroupGroupMemberCreator,"group","Groupe de personne");KJing.NewIcon.extend("KJing.GroupMemberNewIcon",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.connect(this,"press",this.onNewPress)},onNewPress:function(){(new KJing.CreatorDialog({title:"Ajout d'un membre",resource:this.resource,types:KJing.GroupMemberCreator.getTypesDefs()})).open()}});KJing.ResourceViewer.extend("KJing.GroupUserViewer",{dropbox:void 0,flow:void 0,onUserDetachBinded:void 0,testWriteRightBinded:void 0,newItem:void 0,constructor:function(a){this.dropbox=new Ui.DropBox;this.setContent(this.dropbox);this.flow=new Ui.Flow({spacing:5,uniform:!0});this.dropbox.setContent(this.flow);a=this.onItemEffect.bind(this);this.dropbox.addType(KJing.Group,a);this.dropbox.addType(KJing.User,a);this.connect(this.dropbox,"drop",this.onItemDrop);this.onUserDetachBinded=this.onUserDetach.bind(this);
this.testWriteRightBinded=this.resource.canWrite.bind(this.resource);this.newItem=new KJing.GroupMemberNewIcon({resource:this.resource,disabled:!this.resource.canWrite()});this.flow.append(this.newItem);if(this.resource.getIsReady())this.onResourceChange()},onItemEffect:function(a){for(var b=this.getResource().getUsers(),c=0;c<b.length;c++)if(b[c]===a.getId())return[];return["link"]},onResourceChange:function(){this.newItem.setDisabled(!this.getResource().canWrite());for(var a=this.resource.getUsers(),
b=[],c=0;c<a.length;c++)b.push(KJing.Resource.create(a[c]));KJing.ResourceViewer.updateChildren(this.flow,this.flow.getChildren(),1,b)},onItemDrop:function(a,b,c,d,e){this.resource.addUser(b)},onUserDetach:function(a){a=a.getElements();for(var b=0;b<a.length;b++)this.resource.removeUser(a[b].getResource())},getContextActions:function(a,b){if(KJing.UserIconViewer.hasInstance(a)||KJing.GroupIconViewer.hasInstance(a))delete b.suppress,b.suppress={text:"Retirer",icon:"trash",testRight:this.testWriteRightBinded,
callback:this.onUserDetachBinded,multiple:!0};return b}},{onLoad:function(){KJing.GroupUserViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.GroupUserViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.extend("KJing.GroupShareViewer",{dropbox:void 0,flow:void 0,newItem:void 0,onResourceUnshareBinded:void 0,testWriteRightBinded:void 0,constructor:function(a){this.dropbox=new Ui.DropBox;this.setContent(this.dropbox);this.flow=new Ui.Flow({spacing:5,uniform:!0});this.dropbox.setContent(this.flow);this.newItem=new KJing.NewIcon({disabled:!0});this.flow.append(this.newItem);a=this.onItemEffect.bind(this);this.dropbox.addType(KJing.Resource,a);this.connect(this.dropbox,"drop",this.onItemDrop);
this.onResourceUnshareBinded=this.onResourceUnshare.bind(this);this.testWriteRightBinded=this.resource.canWrite.bind(this.resource);if(this.resource.getIsReady())this.onResourceChange()},onItemEffect:function(a){for(var b=this.getResource().getShares(),c=0;c<b.length;c++)if(b[c]===a.getId())return[];return["share"]},onResourceChange:function(){KJing.ResourceViewer.updateChildren(this.flow,this.flow.getChildren(),1,this.resource.getShares())},onItemDrop:function(a,b,c,d,e){a=b.addRights([{user:this.resource.getId(),
read:!0,write:!1,admin:!1}]);this.connect(a,"done",function(){this.resource.update()})},onResourceUnshare:function(a){a=a.getElements();for(var b=0;b<a.length;b++)a[b].getResource().addRights([{user:this.resource.getId(),read:!1,write:!1,admin:!1}])},getContextActions:function(a,b){KJing.ResourceIconViewer.hasInstance(a)&&(delete b.suppress,b.suppress={text:"Retirer",icon:"trash",testRight:this.testWriteRightBinded,callback:this.onResourceUnshareBinded,multiple:!0});return b}},{onLoad:function(){KJing.GroupShareViewer.base.onLoad.apply(this,
arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.GroupShareViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.extend("KJing.GroupViewer",{viewMode:"user",constructor:function(a){this.setContent(new KJing.GroupUserViewer({resource:this.resource}))},setViewMode:function(a){a!==this.viewMode&&(this.viewMode=a,"share"===this.viewMode?this.setContent(new KJing.GroupShareViewer({resource:this.resource})):this.setContent(new KJing.GroupUserViewer({resource:this.resource})))}},{getState:function(){return{viewMode:this.viewMode}},setState:function(a){void 0!==a&&void 0!==a.viewMode&&this.setViewMode(a.viewMode)},
getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.SegmentBar({margin:10,orientation:"horizontal",field:"text",data:[{text:"Utilisateurs",value:"user"},{text:"Partages",value:"share"}]});b.append(c);"share"===this.viewMode?c.setCurrentPosition(1):c.setCurrentPosition(0);this.connect(c,"change",function(b,c){this.setViewMode(c.value);a.close()});c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();
a.close()});b.append(c);return a}});KJing.ResourceViewer.register("group",KJing.GroupViewer);KJing.ResourceIcon.extend("KJing.GroupIcon",{constructor:function(a){this.setIcon("group");a=this.onIconEffect.bind(this);this.addType(KJing.Group,a);this.addType(KJing.User,a);this.connect(this,"drop",this.onIconDrop);this.connect(this,"dragenter",this.onIconDragEnter);this.connect(this,"dragleave",this.onIconDragLeave)},onIconEffect:function(a){if(a.getId()===this.getId())return[];for(var b=this.getResource().getUsers(),c=0;c<b.length;c++)if(b[c]===a.getId())return[];return["link"]},onIconDrop:function(a,
b,c,d,e){this.getResource().addUser(b)},onIconDragEnter:function(){this.setIcon("groupopen")},onIconDragLeave:function(){this.setIcon("group")}});KJing.ResourceIcon.register("group",KJing.GroupIcon);KJing.ResourceIconViewer.extend("KJing.GroupIconViewer",{});KJing.ResourceIconViewer.register("group",KJing.GroupIconViewer);KJing.ResourceProperties.extend("KJing.DeviceProperties",{deviceUrlField:void 0},{build:function(){KJing.DeviceProperties.base.build.apply(this,arguments);this.deviceUrlField=new KJing.TextField({title:"URL du client Web",width:300,disabled:!0,value:(new Core.Uri({uri:"../client/?device="+this.resource.getId()})).toString()});this.insertAt(this.deviceUrlField,1)}});KJing.ResourceProperties.register("device",KJing.DeviceProperties);KJing.IconViewer.extend("KJing.FileControlIconViewer",{controller:void 0,currentGraphic:void 0,constructor:function(a){this.controller=a.controller;delete a.controller;this.setDraggableData(void 0);this.currentGraphic=new Ui.Rectangle({height:4,verticalAlign:"bottom"});this.currentGraphic.hide();this.append(this.currentGraphic);this.itemIcon=KJing.ResourceIcon.create(this.controller.getResource());this.itemIcon.setHorizontalAlign("center");this.itemIcon.setVerticalAlign("center");this.setIcon(this.itemIcon);
this.setItemName("");if(this.controller.getIsReady())this.onFileReady();else this.connect(this.controller,"ready",this.onFileReady)},getController:function(){return this.controller},onFileReady:function(){this.setItemName(this.controller.getResource().getName())}},{onPress:function(){this.controller.setCurrent()},onCurrent:function(){this.currentGraphic.show()},onUncurrent:function(){this.currentGraphic.hide()},onStyleChange:function(){KJing.FileControlIconViewer.base.onStyleChange.apply(this,arguments);
this.currentGraphic.setFill(this.getStyleProperty("activeForeground"))},onLoad:function(){KJing.FileControlIconViewer.base.onLoad.apply(this,arguments);this.connect(this.controller,"current",this.onCurrent);this.connect(this.controller,"uncurrent",this.onUncurrent);if(this.controller.getIsCurrent())this.onCurrent();else this.onUncurrent()},onUnload:function(){KJing.FileControlIconViewer.base.onUnload.apply(this,arguments);this.disconnect(this.controller,"current",this.onCurrent);this.disconnect(this.controller,
"uncurrent",this.onUncurrent)}});Ui.CarouselableLoader.extend("KJing.DeviceListLoader",{device:void 0,constructor:function(a){this.device=a.device;delete a.device}},{getMin:function(){return 0},getMax:function(){return this.device.getDevicePlayList().length-1},getElementAt:function(a){return KJing.ResourceControllerViewer.create(this.device.getDevicePlayList()[a])}});
KJing.ResourceViewer.extend("KJing.DeviceViewer",{file:void 0,volumeControl:void 0,path:void 0,mainVBox:void 0,listView:void 0,ratioBox:void 0,viewer:void 0,carousel:void 0,loader:void 0,message:void 0,constructor:function(a){},buildNoControl:function(){void 0===this.message&&(this.message=new Ui.Text({text:"Le client d'affichage n'est pas connect\u00e9. Vous ne pouvez donc pas le contr\u00f4ler pour le moment",textAlign:"center",verticalAlign:"center",margin:40}),this.setContent(this.message),this.mainVBox=
void 0)},buildControl:function(){if(void 0===this.mainVBox){var a=new Ui.VBox({spacing:5});this.mainVBox=a;this.setContent(a);var b=new Ui.HBox;a.append(b,!0);a=new Ui.DropBox;a.addType(KJing.File,["play"]);a.addType(KJing.Folder,["play"]);b.append(a,!0);this.connect(a,"drop",this.onDrop);this.ratioBox=new KJing.RatioBox({ratio:4/3});a.setContent(this.ratioBox);this.ratioBox.append(new Ui.Rectangle({fill:"black"}));this.loader=new KJing.DeviceListLoader({device:this.resource});this.carousel=new Ui.Carousel3({loader:this.loader,
bufferingSize:1});this.connect(this.carousel,"change",this.onCarouselChange);this.ratioBox.append(this.carousel);a=new Ui.VBox;b.append(a);this.volumeControl=new Ui.Slider({orientation:"vertical"});this.connect(this.volumeControl,"change",this.onVolumeControlChange);a.append(this.volumeControl,!0);a.append(new Ui.Icon({icon:"sound",width:24,height:24,horizontalAlign:"center"}));this.listView=new KJing.DeviceControlListView({resource:this.resource});this.mainVBox.append(this.listView);this.message=
void 0}},onCarouselChange:function(a,b,c){"user"===c&&this.resource.setDevicePosition(b)},onDeviceChange:function(){this.resource.getIsConnected()?(this.buildControl(),this.resource.getIsDeviceSync()&&(this.ratioBox.setRatio(this.resource.getDeviceRatio()),this.carousel.getCurrentPosition()!==this.resource.getDevicePosition()&&this.carousel.setCurrentAt(this.resource.getDevicePosition()),this.volumeControl.getValue()!==this.resource.getDeviceVolume()&&this.volumeControl.setValue(this.resource.getDeviceVolume()))):
this.buildNoControl()},onDrop:function(a,b,c,d,e){(KJing.File.hasInstance(b)||KJing.Folder.hasInstance(b))&&this.resource.setPath(b.getId())},onVolumeControlChange:function(){this.resource.setDeviceVolume(this.volumeControl.getValue())},onPlayListChange:function(){void 0!==this.carousel&&this.carousel.setLoader(this.loader)}},{getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",
function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.close()});b.append(c);return a},onLoad:function(){KJing.DeviceViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onDeviceChange);this.connect(this.resource,"playlistchange",this.onPlayListChange);this.resource.monitor();this.resource.control();if(this.resource.getIsReady())this.onDeviceChange()},onUnload:function(){KJing.DeviceViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,
"change",this.onDeviceChange);this.disconnect(this.resource,"playlistchange",this.onPlayListChange);this.resource.unmonitor();this.resource.uncontrol()}});
Ui.ScrollingArea.extend("KJing.DeviceControlListView",{resource:void 0,flow:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.setScrollVertical(!1);this.flow=new Ui.HBox;this.setContent(this.flow)},getResource:function(){return this.resource},onDeviceChange:function(){for(var a=this.resource.getDevicePlayList(),b=[],c=0;c<a.length;c++){for(var d=a[c],e=!1,f,g=0;g<this.flow.getChildren().length;g++)if(f=this.flow.getChildren()[g].getController(),d.getId()===f.getId()&&
d.getResource().getId()===f.getResource().getId()){e=!0;break}!1===e&&b.push(d)}for(var h=[],g=0;g<this.flow.getChildren().length;g++){var l=this.flow.getChildren()[g];f=l.getController();e=!1;for(c=0;c<a.length;c++)if(d=a[c],d.getId()===f.getId()&&d.getResource().getId()===f.getResource().getId()){e=!0;break}!1===e&&h.push(l)}for(c=0;c<h.length;c++)this.flow.remove(h[c]);for(c=0;c<b.length;c++)f=b[c],this.flow.insertAt(new KJing.FileControlIconViewer({controller:f}),f.getId())}},{onLoad:function(){KJing.DeviceControlListView.base.onLoad.apply(this,
arguments);this.connect(this.resource,"change",this.onDeviceChange);this.resource.monitor();this.onDeviceChange()},onUnload:function(){KJing.DeviceControlListView.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onDeviceChange);this.resource.unmonitor()}});KJing.ResourceViewer.register("device",KJing.DeviceViewer);Ui.CanvasElement.extend("KJing.DeviceIconGraphic",{ratio:1.33,online:!1,image:void 0,imageSrc:void 0,constructor:function(a){this.image=new Ui.Image;this.appendChild(this.image);this.connect(this.image,"ready",this.invalidateDraw);this.connect(this.image,"error",this.invalidateDraw)},setRatio:function(a){isNaN(a)&&(ratis=1.33);this.ratio!==a&&(this.ratio=a,this.invalidateDraw())},setOnline:function(a){this.online!==a&&(this.online=a,this.invalidateDraw())},setImageSrc:function(a){this.imageSrc!==
a&&(this.imageSrc=a,this.image.setSrc(this.imageSrc))}},{updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight(),d=Math.min(b,c),e=Math.round(0.05*d),f;1<this.ratio?f=d/this.ratio:(f=d,d=f*this.ratio);var b=(b-d)/2,c=c-f,g=d-2*e,h=f-2*e;a.fillStyle="black";a.fillRect(b,c,d,f);if(void 0!==this.imageSrc&&this.image.getIsReady()){var l=this.image.getNaturalWidth(),m=this.image.getNaturalHeight(),l=l/m,k;l>this.ratio?(m=d,k=m/l):(k=f,m=k*l);a.drawImage(this.image.getDrawing(),b+
(d-m)/2,c+(f-k)/2,m,k)}a.fillStyle=this.online?"#81e309":"#f75265";a.beginPath();a.moveTo(b,c);a.lineTo(b+d,c);a.lineTo(b+d,c+f);a.lineTo(b,c+f);a.moveTo(b+e,c+e);a.lineTo(b+e,c+e+h);a.lineTo(b+e+g,c+e+h);a.lineTo(b+e+g,c+e);a.closePath();a.fill()}});
Ui.DropBox.extend("KJing.DeviceIcon",{resource:void 0,icon:void 0,ownerImageSrc:void 0,tagsBox:void 0,tags:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.icon=new KJing.DeviceIconGraphic({width:64,height:64});this.setContent(this.icon);this.connect(this,"drop",this.onResourceDrop);this.addType(KJing.File,["play"]);this.addType(KJing.Folder,["play"])},setSquareSize:function(a){this.icon.setWidth(a);this.icon.setHeight(a)},setRoundMode:function(a){},setTags:function(a){this.tags=
a;this.updateTags()},setOwnerImage:function(a){this.ownerImageSrc=a;this.updateTags()},updateTags:function(){if(void 0!==this.tags||void 0!==this.ownerImageSrc){void 0===this.tagsBox&&(this.tagsBox=new Ui.LBox({width:this.squareSize,height:this.squareSize}),this.append(this.tagsBox));var a=new Ui.Flow({itemAlign:"right",verticalAlign:"bottom"});this.tagsBox.setContent(a);if(void 0!==this.tags)for(var b=0;b<this.tags.length;b++)a.append(new Ui.Icon({icon:this.tags[b],width:24,height:24,fill:"#00c3ff"}));
void 0!==this.ownerImageSrc&&a.append(new KJing.RoundItemGraphic({width:24,height:24,imageSrc:this.ownerImageSrc}))}else void 0!==this.tagsBox&&(this.remove(this.tagsBox),this.tagsBox=void 0)},onResourceDrop:function(a,b,c,d,e){KJing.Resource.hasInstance(b)&&this.resource.setPath(b.getId())},onResourceChange:function(){this.icon.setOnline(this.resource.getIsConnected());this.icon.setRatio(this.resource.getDeviceRatio());var a=this.resource.getDevicePlayList();if(void 0!==a&&0<a.length){var b=this.resource.getDevicePosition(),
a=a[b];if(a.getIsReady())this.onControllerReady(a);else this.connect(a,"ready",this.onControllerReady)}else if(null!==this.resource.getData().path)if(a=KJing.Resource.create(this.resource.getData().path),a.getIsReady())this.onResourceReady(a);else this.connect(a,"ready",this.onResourceReady)},onControllerReady:function(a){this.onResourceReady(a.getResource())},onResourceReady:function(a){void 0!==a.data.thumbnailLow&&(a=KJing.Resource.create(a.data.thumbnailLow),this.icon.setImageSrc(a.getDownloadUrl()))}},
{onLoad:function(){KJing.DeviceIcon.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange()},onUnload:function(){KJing.DeviceIcon.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange)}});KJing.ResourceIcon.register("device",KJing.DeviceIcon);KJing.ResourceIconViewer.extend("KJing.DeviceIconViewer",{});KJing.ResourceIconViewer.register("device",KJing.DeviceIconViewer);KJing.ResourceProperties.extend("KJing.MapProperties",{mapUrlField:void 0,mapPublicNameField:void 0},{build:function(){KJing.MapProperties.base.build.apply(this,arguments);this.mapUrlField=new KJing.TextField({title:"URL des clients Web",width:300,disabled:!0});this.mapUrlField.setValue((new Core.Uri({uri:"../client/?parent="+this.resource.getId()})).toString());this.insertAt(this.mapUrlField,1);this.mapPublicNameField=new KJing.TextField({title:"Nom publique de la salle",width:300});null!==this.resource.getData().publicName&&
this.mapPublicNameField.setValue(this.resource.getData().publicName);this.insertAt(this.mapPublicNameField,2)},getPropertiesJson:function(){var a=KJing.MapProperties.base.getPropertiesJson.apply(this,arguments),b=this.mapPublicNameField.getValue();""===b&&(b=null);a.publicName=b;return a}});KJing.ResourceProperties.register("map",KJing.MapProperties);KJing.ResourceCreator.extend("KJing.MapMemberCreator",{},{},{types:void 0,constructor:function(){KJing.MapMemberCreator.types={}},register:function(a,b,c,d,e){KJing.MapMemberCreator.types[a]={type:a,creator:b,icon:c,text:d,uploader:e}},getTypesDefs:function(){return KJing.MapMemberCreator.types},getTypeDef:function(a){if(void 0!==KJing.MapMemberCreator.types[a])return KJing.MapMemberCreator.types[a];for(var b;-1!=(b=a.lastIndexOf(":"));)if(a=a.substring(0,b),void 0!==KJing.MapMemberCreator.types[a])return KJing.MapMemberCreator.types[a]}});KJing.MapMemberCreator.extend("KJing.MapDeviceCreator",{constructor:function(a){this.setType("device")}});KJing.MapMemberCreator.register("device",KJing.MapDeviceCreator,"eye","Client de diffusion Web");KJing.ResourceCreator.extend("KJing.MapCreator",{constructor:function(a){this.setType("map")}});KJing.ResourceCreator.register("map",KJing.MapCreator,"map","Salle de diffusion");KJing.ResourceIcon.extend("KJing.MapIcon",{constructor:function(a){this.setIcon("map");this.addType(KJing.File,["play"]);this.addType(KJing.Folder,[{action:"playall",text:"Envoyer \u00e0 tous",dragicon:"dragplay"},{action:"playlinear",text:"R\u00e9partir sur tous",dragicon:"dragplay"},{action:"playrandom",text:"R\u00e9partir al\u00e9atoirement",dragicon:"dragplay"}]);this.connect(this,"drop",this.onIconDrop);this.connect(this,"dragenter",this.onIconDragEnter);this.connect(this,"dragleave",this.onIconDragLeave)},
onIconDrop:function(a,b,c,d,e){if(KJing.File.hasInstance(b)||KJing.Folder.hasInstance(b)){var f=this.getResource().getDevices();if(KJing.File.hasInstance(b))for(a=0;a<f.length;a++)f[a].device.setPath(b.getId());else if("playall"===c)for(a=0;a<f.length;a++)f[a].device.setPath(b.getId());else if("playlinear"===c){var g=b;a=function(){for(var a=g.getChildren(),b=0;b<f.length;b++)f[b].device.setPath(a[b%a.length].getId())};g.getIsChildrenReady()?a():(g.loadChildren(),this.connect(g,"change",a))}else"playrandom"===
c&&(g=b,a=function(){var a=b.getChildren();if(0<a.length)for(var c=a.slice(0),d=0;d<f.length;d++){0===c.length&&(c=a.slice(0));var e=Math.min(c.length-1,Math.max(0,Math.floor(Math.random()*c.length))),g=c[e];c.splice(e,1);f[d].device.setPath(g.getId())}},g.getIsChildrenReady()?a():(g.loadChildren(),this.connect(g,"change",a)))}},onIconDragEnter:function(){this.setIcon("mapopen")},onIconDragLeave:function(){this.setIcon("map")}});KJing.ResourceIcon.register("map",KJing.MapIcon);KJing.NewIcon.extend("KJing.MapMemberNewIcon",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.connect(this,"press",this.onNewPress)},onNewPress:function(){(new KJing.CreatorDialog({title:"Client de diffusion",resource:this.resource,types:KJing.MapMemberCreator.getTypesDefs()})).open()}});KJing.ResourceViewer.extend("KJing.MapProvisioningViewer",{flow:void 0,newItem:void 0,constructor:function(a){this.flow=new Ui.Flow({spacing:5,uniform:!0});this.setContent(this.flow);this.newItem=new KJing.MapMemberNewIcon({resource:this.resource});this.flow.append(this.newItem);if(this.resource.getIsReady())this.onResourceChange()},onResourceChange:function(){this.newItem.setDisabled(!this.getResource().canWrite());for(var a=this.getResource().getChildren(),b=[],c=0;c<a.length;c++)KJing.Device.hasInstance(a[c])&&
b.push(a[c]);KJing.ResourceViewer.updateChildren(this.flow,this.flow.getChildren(),1,b)}},{onLoad:function(){KJing.MapProvisioningViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.MapProvisioningViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.extend("KJing.MapMapViewer",{devicesBox:void 0,fold:void 0,provisioningText:void 0,mapDevicesView:void 0,constructor:function(a){a=new Ui.VBox;this.setContent(a);this.mapDevicesView=new KJing.MapDevicesViewer({resource:this.resource});a.append(this.mapDevicesView,!0);var b=new Ui.ScrollingArea({scrollVertical:!1});this.devicesBox=new Ui.HBox({height:120,uniform:!0});b.setContent(this.devicesBox);var c=new Ui.Pressable;c.append(new Ui.Rectangle({fill:"rgba(120,120,120,0.1)"}));
this.provisioningText=new Ui.Text({text:"Hello World",margin:5,textAlign:"center"});c.append(this.provisioningText);this.fold=new Ui.Fold({over:!1});this.connect(c,"press",function(){this.fold.invert()});this.fold.setHeader(c);this.fold.setContent(b);a.append(this.fold);if(this.resource.getIsReady())this.onResourceChange()},onResourceChange:function(){for(var a=this.resource.getChildren(),b=this.devicesBox.getChildren(),c=[],d=0;d<b.length;d++){for(var e=!1,f=0;!e&&f<a.length;f++)KJing.Device.hasInstance(a[f])&&
(this.resource.isAttachedDevice(a[f])||(e=b[d].getResource().getId()===a[f].getId()));e||c.push(b[d])}for(f=0;f<c.length;f++)this.devicesBox.remove(c[f]);for(var c=[],g=0,f=0;f<a.length;f++)if(KJing.Device.hasInstance(a[f])&&!this.resource.isAttachedDevice(a[f])){g++;e=!1;for(d=0;!e&&d<b.length;d++)e=b[d].getResource().getId()===a[f].getId();e||c.push(a[f])}for(f=0;f<c.length;f++)this.devicesBox.append(KJing.ResourceIconViewer.create(c[f]));this.provisioningText.setText(g+" clients en attente")}},
{onLoad:function(){KJing.MapMapViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.MapMapViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.extend("KJing.MapViewer",{viewMode:"map",constructor:function(a){this.setContent(new KJing.MapMapViewer({resource:this.resource}))},setViewMode:function(a){a!==this.viewMode&&(this.viewMode=a,"provisioning"===this.viewMode?this.setContent(new KJing.MapProvisioningViewer({resource:this.resource})):this.setContent(new KJing.MapMapViewer({resource:this.resource})))},onSaveState:function(){var a=new Ui.Dialog({preferredWidth:350});a.setTitle("Nom de l'\u00e9tat");a.setCancelButton(new Ui.DialogCloseButton);
var b=new Ui.Button({text:"Enregistrer",disabled:!0});a.setActionButtons([b]);var c=new Ui.TextField;a.setContent(c);this.connect(c,"change",function(){""===c.getValue()?b.disable():b.enable()});a.setContent(c);this.connect(b,"press",function(){for(var a=[],b=this.resource.getDevices(),f=0;f<b.length;f++)a.push({device:b[f].device.getId(),path:b[f].device.getPath()});for(var f=Ui.App.current.paned.getContent1().getContentView().getResource(),g=Ui.App.current.paned.getContent2().getContentView().getResource(),
b=null,b=f.getId()!==this.resource.getId()&&f.canWrite()?f:g.getId()!==this.resource.getId()&&g.canWrite()?g:Ui.App.current.getUser(),g="----",f=0;16>f;f++)g+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(62*Math.random())];g+="----";f=new Core.HttpRequest({method:"POST",url:"/cloud/file"});f.setRequestHeader("Content-Type","multipart/form-data; boundary="+g);f.setContent("--"+g+'\r\nContent-Disposition: form-data; name="define"\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n'+
JSON.stringify({parent:b.getId(),name:c.getValue(),mimetype:"application/x-kjing-state",position:0})+"\r\n--"+g+'\r\nContent-Disposition: form-data; name="file"; filename="noname"\r\nContent-Type: application/x-kjing-state; charset=UTF-8\r\n\r\n'+JSON.stringify(a)+"\r\n--"+g+"--\r\n");f.send()});a.open()}},{getState:function(){return{viewMode:this.viewMode}},setState:function(a){void 0!==a&&void 0!==a.viewMode&&this.setViewMode(a.viewMode)},getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});
a.setContent(b);var c=new Ui.SegmentBar({margin:10,orientation:"horizontal",field:"text",data:[{text:"Carte",value:"map"},{text:"Rattach\u00e9s",value:"provisioning"}]});b.append(c);"provisioning"===this.viewMode?c.setCurrentPosition(1):c.setCurrentPosition(0);this.connect(c,"change",function(b,c){this.setViewMode(c.value);a.close()});c=new Ui.Button({text:"Enregistrer l'\u00e9tat",icon:"savecloud"});this.connect(c,"press",this.onSaveState);b.append(c);c=new Ui.Button({text:"Propri\u00e9t\u00e9s",
icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.close()});b.append(c);return a}});KJing.ResourceViewer.register("map",KJing.MapViewer);KJing.DeviceIconViewer.extend("KJing.MapDeviceIconViewer",{map:void 0,x:0,y:0,constructor:function(a){},getMap:function(){return this.map},setMap:function(a){this.map=a},getX:function(){return this.x},setX:function(a){this.x=a},getY:function(){return this.y},setY:function(a){this.y=a}},{suppress:function(){this.map.detachDevice(this.resource)}});
Ui.DropBox.extend("KJing.MapDevicesViewer",{resource:void 0,image:void 0,fixed:void 0,devices:void 0,mapX:0,mapY:0,mapWidth:100,mapHeight:100,constructor:function(a){this.resource=a.resource;delete a.resource;this.devices=[];this.fixed=new Ui.Fixed;this.setContent(this.fixed);this.addType("files",["copy"]);this.addType(KJing.Device,["move"]);this.addType(KJing.Folder,[{action:"playall",text:"Envoyer \u00e0 tous",dragicon:"dragplay"},{action:"playlinear",text:"R\u00e9partir sur tous",dragicon:"dragplay"},
{action:"playrandom",text:"R\u00e9partir al\u00e9atoirement",dragicon:"dragplay"}]);this.addType(KJing.File,["play"]);this.connect(this,"dropfile",this.onMapDropFile);this.connect(this,"drop",this.onMapDrop);this.image=new Ui.Image;a=this.resource.getMapImageUrl();void 0!==a&&this.image.setSrc(a);this.image.getIsReady()||this.image.hide();this.connect(this.image,"ready",function(){this.image.show()});this.connect(this.image,"error",function(){this.image.hide()});this.fixed.append(this.image,0,0);
this.connect(this.image,"ready",this.onReady);this.connect(this.fixed,"resize",this.onResize);this.addEvents("ready")},getIsReady:function(){return this.image.getIsReady()},onReady:function(){this.updateSize();this.fireEvent("ready",this)},onResize:function(){this.updateSize()},updateSize:function(){var a=this.image.getNaturalWidth(),b=this.image.getNaturalHeight();void 0===a&&(a=100);void 0===b&&(b=100);var c=this.getLayoutWidth(),d=this.getLayoutHeight();if(a/b<c/d){var e=d,f=a*e/b;this.mapX=-(f-
c)/2;this.mapY=0}else f=c,e=b*f/a,this.mapX=0,this.mapY=-(e-d)/2;this.mapWidth=f;this.mapHeight=e;this.fixed.setPosition(this.image,this.mapX,this.mapY);this.image.setWidth(f);this.image.setHeight(e);this.updateDevicesPositions()},updateDevicesPositions:function(){for(var a=this.mapWidth,b=this.mapHeight,c=0;c<this.devices.length;c++)this.fixed.setPosition(this.devices[c],this.mapX+this.devices[c].getX()*a,this.mapY+this.devices[c].getY()*b)},onMapDropFile:function(a,b,c,d,e){this.resource.setMapImage(b)},
onMapDrop:function(a,b,c,d,e,f){if(KJing.Device.hasInstance(b))a=f.getDragDelta(),d-=this.mapX,e-=this.mapY,d-=a.x,e-=a.y,d+=f.draggable.getLayoutWidth()/2,e+=f.draggable.getLayoutHeight()/2,d/=this.mapWidth,e/=this.mapHeight,this.resource.isAttachedDevice(b)?(this.resource.moveDevice(b,d,e),f.draggable.setX(d),f.draggable.setY(e),this.updateDevicesPositions()):this.resource.attachDevice(b,d,e);else{var g=this.resource.getDevices();if(KJing.File.hasInstance(b))for(d=0;d<g.length;d++)g[d].device.setPath(b.getId());
else if("playall"===c)for(d=0;d<g.length;d++)g[d].device.setPath(b.getId());else if("playlinear"===c){var h=b;d=function(){for(var a=h.getChildren(),b=0;b<g.length;b++)g[b].device.setPath(a[b%a.length].getId())};h.getIsChildrenReady()?d():(h.loadChildren(),this.connect(h,"change",d))}else"playrandom"===c&&(h=b,d=function(){var a=b.getChildren();if(0<a.length)for(var c=a.slice(0),d=0;d<g.length;d++){0===c.length&&(c=a.slice(0));var e=Math.min(c.length-1,Math.max(0,Math.floor(Math.random()*c.length))),
f=c[e];c.splice(e,1);g[d].device.setPath(f.getId())}},h.getIsChildrenReady()?d():(h.loadChildren(),this.connect(h,"change",d)))}},onResourceChange:function(){console.log(this+".onResourceChange");var a=this.resource.getMapImageUrl();void 0!==a&&a!==this.image.getSrc()&&this.image.setSrc(a);for(var a=[],b=this.resource.getDevices(),c=0;c<this.devices.length;c++){for(var d=this.devices[c],e=void 0,f=0;void 0===e&&f<b.length;f++)b[f].device.getId()===d.getResource().getId()&&(e=b[f]);void 0===e?this.fixed.remove(d):
(a.push(d),d.setX(e.x),d.setY(e.y))}for(c=0;c<b.length;c++){e=void 0;for(f=0;void 0===e&&f<this.devices.length;f++)this.devices[f].getResource().getId()===b[c].device.getId()&&(e=this.devices[f]);void 0===e&&(d=new KJing.MapDeviceIconViewer({resource:b[c].device,map:this.resource,x:b[c].x,y:b[c].y}),a.push(d),this.fixed.append(d,0,0),this.fixed.setRelativePosition(d,0.5,0.5,!1))}this.devices=a;this.updateDevicesPositions()}},{onLoad:function(){KJing.MapDevicesViewer.base.onLoad.apply(this,arguments);
this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor();if(this.resource.getIsReady())this.onResourceChange()},onUnload:function(){KJing.MapDevicesViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});Ui.SFlow.extend("KJing.FileCreator",{resource:void 0,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;var b=a.file;delete a.file;a=new Core.FilePostUploader({file:b,service:"/cloud/file"});var c=Ui.App.current.addUploader(a);a.setField("define",JSON.stringify({type:"file:"+b.getMimetype().replace("/",":"),parent:this.resource.getId(),uploader:c}));this.connect(a,"progress",this.onUploadProgress);this.connect(a,"complete",this.onUploadComplete);
a.send()},create:function(){},onUploadProgress:function(a){},onUploadComplete:function(a){this.fireEvent("done",this);this.resource.update()}});KJing.ResourceCreator.register("file",KJing.FileCreator,"file","Fichier local",!0);KJing.ResourceProperties.extend("KJing.FileProperties",{durationField:void 0},{getPropertiesJson:function(){var a=KJing.FileProperties.base.getPropertiesJson.apply(this,arguments),b=parseFloat(this.durationField.getValue()),c=null;0<b&&(c=Math.round(1E3*b));a.durationMs=c;return a},build:function(){KJing.FileProperties.base.build.apply(this,arguments);var a=this.resource.getData(),b=-1;null!==a.durationMs&&(b=a.durationMs/1E3);this.durationField=new KJing.TextField({title:"Dur\u00e9e d'affichage",
value:b,width:200});this.insertAt(this.durationField,1)}});KJing.ResourceProperties.register("file",KJing.FileProperties);KJing.ResourceViewer.extend("KJing.FileViewer",{text:void 0,downloadButton:void 0,constructor:function(a){a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center",spacing:10});this.setContent(a);a.append(new Ui.Icon({icon:"file",width:128,height:128,horizontalAlign:"center"}));this.text=new Ui.Text({textAlign:"center",text:this.resource.getName(),fontSize:20});a.append(this.text);this.downloadButton=new Ui.DownloadButton({text:"T\u00e9l\u00e9charger",horizontalAlign:"center"});this.downloadButton.setSrc(this.resource.getDownloadUrl(!0));
a.append(this.downloadButton)},onResourceChange:function(){this.text.setText(this.resource.getName());this.downloadButton.setSrc(this.resource.getDownloadUrl(!0))}},{onLoad:function(){KJing.FileViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.FileViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.register("file",KJing.FileViewer);KJing.ResourceIcon.extend("KJing.FileIcon",{uploader:void 0,constructor:function(a){this.setIcon("file")},onUploaderProgress:function(a,b,c){this.getProgressBar().setValue(b/c)},onUploaderErrorOrComplete:function(a){this.setProgressBar(void 0);this.disconnect(this.uploader,"progress",this.onUploaderProgress);this.disconnect(this.uploader,"complete",this.onUploaderErrorOrComplete);this.disconnect(this.uploader,"error",this.onUploaderErrorOrComplete);this.uploader=void 0}},{onResourceChange:function(){if(void 0!==
this.resource.getData().uploader){this.setIcon("uploadfile");var a=Ui.App.current.getUploaderById(this.resource.getData().uploader);if(this.uploader!==a){void 0!==this.uploader&&(this.disconnect(this.uploader,"progress",this.onUploaderProgress),this.disconnect(this.uploader,"complete",this.onUploaderErrorOrComplete),this.disconnect(this.uploader,"error",this.onUploaderErrorOrComplete));var b;this.uploader=a;void 0!==this.uploader&&(b=new Ui.ProgressBar({verticalAlign:"bottom",margin:4}),this.connect(this.uploader,
"progress",this.onUploaderProgress),this.connect(this.uploader,"complete",this.onUploaderErrorOrComplete),this.connect(this.uploader,"error",this.onUploaderErrorOrComplete));this.setProgressBar(b)}}else void 0!==this.resource.getPreviewUrl()?this.setIconImage(this.resource.getPreviewUrl()):this.setIcon("file")}});KJing.ResourceIcon.register("file",KJing.FileIcon);KJing.ResourceIconViewer.extend("KJing.FileIconViewer",{preview:void 0,constructor:function(a){},deleteFile:function(){void 0!==this.uploader&&(this.uploader.abort(),this.uploader=void 0);void 0!==this.resource&&this.resource.suppress()},onDelete:function(a){a.getElements()[0].getResource().suppress()},onProperties:function(a){a=a.getElements()[0];(new KJing.ResourcePropertiesDialog({resource:a.getResource()})).open()},onOpen:function(a){a=a.getElements()[0];a.getView().push(a.getResource().getName(),
a.getResource().getId())},onDownload:function(a){a=a.getElements();for(var b=0;b<a.length;b++)window.open(a[b].getResource().getDownloadUrl(!0),"_blank")}},{getSelectionActions:function(){return void 0!==this.getResource().getData().uploader?{suppress:{text:"Supprimer",icon:"trash",color:"#d02020",testRight:this.testWriteRight,callback:this.onDelete,multiple:!1}}:{download:{text:"T\u00e9l\u00e9charger",icon:"savedisk",callback:this.onDownload,multiple:!1},suppress:{text:"Supprimer",icon:"trash",color:"#d02020",
testRight:this.testWriteRight,callback:this.onDelete,multiple:!1},properties:{text:"Propri\u00e9t\u00e9s",icon:"edit",callback:this.onProperties,multiple:!1},open:{"default":!0,text:"Ouvrir",icon:"eye",callback:this.onOpen,multiple:!1}}}});KJing.ResourceIconViewer.register("file",KJing.FileIconViewer);KJing.ResourceCreator.extend("KJing.TextCreator",{constructor:function(a){this.setType("file:text:plain")}},{create:function(){for(var a="----",b=0;16>b;b++)a+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(62*Math.random())];a+="----";b=new Core.HttpRequest({method:"POST",url:"/cloud/file"});b.setRequestHeader("Content-Type","multipart/form-data; boundary="+a);b.setContent("--"+a+'\r\nContent-Disposition: form-data; name="define"\r\nContent-Type: application/x-kjing-state; charset=UTF-8\r\n\r\n'+
JSON.stringify({type:this.type,parent:this.resource.getId(),name:this.nameField.getValue(),mimetype:"text/plain",position:0})+"\r\n--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="noname"\r\nContent-Type: text/plain; charset=UTF-8\r\n\r\n\r\n--'+a+"--\r\n");this.connect(b,"done",this.onRequestDone);this.connect(b,"done",this.onRequestFail);b.send()},onRequestDone:function(a){this.fireEvent("done",this);a=KJing.File.create(a.getResponseJSON());(new KJing.TextEditor({file:a})).open()}});
KJing.ResourceCreator.register("textfile",KJing.TextCreator,"text","Fichier texte vide");KJing.ResourceViewer.extend("KJing.TextViewer",{text:void 0,constructor:function(a){a=new Ui.ScaleBox({fixedWidth:800,fixedHeight:600});this.setContent(a);a.append(new Ui.Rectangle({fill:"black"}));this.text=new Ui.Text({margin:20,style:{"Ui.Text":{fontSize:40,color:"white",interLine:1}}});a.append(this.text);this.loadText()},loadText:function(){var a=new Core.HttpRequest({method:"GET",url:this.resource.getDownloadUrl()});this.connect(a,"done",this.onTextLoaded);a.send()},onTextLoaded:function(a){this.text.setText(a.getResponseText())},
onResourceChange:function(){this.loadText()}},{getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.Button({text:"Edit",icon:"edit"});this.connect(c,"press",function(){(new KJing.TextEditor({file:this.resource})).open();var a=c.getParentByClass(Ui.Popup);void 0!==a&&a.close()});b.append(c);c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();
a.close()});b.append(c);return a},onLoad:function(){KJing.TextViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.TextViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});KJing.ResourceViewer.register("file:text:plain",KJing.TextViewer);Ui.Dialog.extend("KJing.TextEditor",{file:void 0,textField:void 0,updateRequest:void 0,saveRequest:void 0,constructor:function(a){this.file=a.file;delete a.file;this.setTitle("Edition de texte");this.setFullScrolling(!0);this.setPreferredWidth(600);this.setPreferredHeight(600);this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.DefaultButton({text:"Enregistrer & Fermer"});this.connect(a,"press",this.onSaveQuitPress);this.setActionButtons([a]);a=new Ui.ScaleBox({fixedWidth:800,fixedHeight:600});
this.setContent(a);a.append(new Ui.Rectangle({fill:"black"}));this.textField=navigator.isIE7||navigator.isIE8?new Ui.TextArea({margin:20,style:{"Ui.TextArea":{fontSize:40,color:"white",interLine:1}}}):new Ui.ContentEditable({margin:20,style:{"Ui.ContentEditable":{fontSize:40,color:"white",interLine:1}}});a.append(this.textField);this.updateText()},updateText:function(){void 0===this.updateRequest&&(this.updateRequest=new Core.HttpRequest({url:this.file.getDownloadUrl()}),this.connect(this.updateRequest,
"done",this.onUpdateTextDone),this.connect(this.updateRequest,"error",this.onUpdateTextError),this.updateRequest.send())},onUpdateTextDone:function(){var a=this.updateRequest.getResponseText();""===a&&(a="\n");navigator.isIE7||navigator.isIE8?this.textField.setValue(a):this.textField.setText(a);this.updateRequest=void 0},onUpdateTextError:function(){this.updateRequest=void 0},onSaveQuitPress:function(){var a;a=navigator.isIE7||navigator.isIE8?this.textField.getValue():this.textField.getText();this.saveRequest=
new Core.HttpRequest({method:"PUT",url:this.file.getUploadUrl()});this.saveRequest.setContent(a);this.connect(this.saveRequest,"done",this.onSaveTextDone);this.connect(this.saveRequest,"error",this.onSaveTextError);this.saveRequest.send()},onSaveTextDone:function(){this.close()},onSaveTextError:function(){this.close()}});Ui.ScrollingArea.extend("KJing.TextControllerViewer",{controller:void 0,text:void 0,changeLock:!1,contentRev:-1,constructor:function(a){this.controller=a.controller;delete a.controller;this.setMaxScale(4);a=new Ui.ScaleBox({fixedWidth:800,fixedHeight:600});this.setContent(a);a.append(new Ui.Rectangle({fill:"black"}));this.text=new Ui.Text({margin:20,style:{"Ui.Text":{fontSize:40,color:"white"}}});a.append(this.text);this.connect(this,"scroll",this.onControllerTransform)},onControllerTransform:function(){this.changeLock||
this.controller.setTransform(-this.getRelativeOffsetX(),-this.getRelativeOffsetY(),this.getScale())},onControllerChange:function(){if(this.controller.getResource().getContentRev()!==this.contentRev){this.contentRev=this.controller.getResource().getContentRev();var a=new Core.HttpRequest({method:"GET",url:this.controller.getResource().getDownloadUrl()});this.connect(a,"done",this.onTextLoaded);a.send()}!this.getIsDown()&&!this.getIsInertia()&&(this.changeLock=!0,this.setScale(this.controller.getTransform().scale),
this.setOffset(-this.controller.getTransform().x,-this.controller.getTransform().y,!1),this.changeLock=!1)},onTextLoaded:function(a){this.text.setText(a.getResponseText())}},{onLoad:function(){KJing.TextControllerViewer.base.onLoad.apply(this,arguments);this.connect(this.controller,"change",this.onControllerChange);if(this.controller.getIsReady())this.onControllerChange()},onUnload:function(){KJing.TextControllerViewer.base.onUnload.apply(this,arguments);this.disconnect(this.controller,"change",this.onControllerChange)}});
KJing.ResourceControllerViewer.register("file:text:plain",KJing.TextControllerViewer);KJing.FileProperties.extend("KJing.ImageProperties",{imageWidthField:void 0,imageHeightField:void 0},{build:function(){KJing.ImageProperties.base.build.apply(this,arguments);var a=this.resource.getData();"imageMediaInfo"in a&&(this.imageWidthField=new KJing.TextField({title:"Largeur",value:a.imageMediaInfo.width,disabled:!0,width:200}),this.insertAt(this.imageWidthField,2,void 0,"newline"),this.imageHeightField=new KJing.TextField({title:"Hauteur",value:a.imageMediaInfo.height,disabled:!0,width:200}),
this.insertAt(this.imageHeightField,3))}});KJing.ResourceProperties.register("file:image",KJing.ImageProperties);KJing.ResourceViewer.extend("KJing.ImageViewer",{scroll:void 0,image:void 0,constructor:function(a){this.scroll=new Ui.ScrollingArea({maxScale:4});this.setContent(this.scroll);this.image=new KJing.ScaledImage2;"file:image:gif"===this.resource.getType()?this.image.setSrc(this.resource.getDownloadUrl()):void 0!==this.resource.getPreviewHighUrl()&&this.image.setSrc(this.resource.getPreviewHighUrl());this.scroll.setContent(this.image)},onResourceChange:function(){"file:image:gif"===this.resource.getType()?
this.image.setSrc(this.resource.getDownloadUrl()):void 0!==this.resource.getPreviewHighUrl()&&this.image.setSrc(this.resource.getPreviewHighUrl())}},{onLoad:function(){KJing.ImageViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.ImageViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
KJing.ResourceViewer.register("file:image",KJing.ImageViewer);Ui.ScrollingArea.extend("KJing.ImageControllerViewer",{controller:void 0,image:void 0,imageSrc:void 0,changeLock:!1,constructor:function(a){this.controller=a.controller;delete a.controller;this.setMaxScale(4);this.image=new KJing.ScaledImage2;this.setContent(this.image);this.connect(this,"scroll",this.onControllerTransform)},onControllerTransform:function(){this.changeLock||this.controller.setTransform(-this.getRelativeOffsetX(),-this.getRelativeOffsetY(),this.getScale())},onControllerChange:function(){var a;
"file:image:gif"===this.controller.getResource().getType()?a=this.controller.getResource().getDownloadUrl():void 0!==this.controller.getResource().getPreviewHighUrl()&&(a=this.controller.getResource().getPreviewHighUrl());this.imageSrc!==a&&(this.imageSrc=a,this.image.setSrc(a));!this.getIsDown()&&!this.getIsInertia()&&(this.changeLock=!0,this.setScale(this.controller.getTransform().scale),this.setOffset(-this.controller.getTransform().x,-this.controller.getTransform().y,!1),this.changeLock=!1)}},
{onLoad:function(){KJing.ImageControllerViewer.base.onLoad.apply(this,arguments);this.connect(this.controller,"change",this.onControllerChange);if(this.controller.getIsReady())this.onControllerChange()},onUnload:function(){KJing.ImageControllerViewer.base.onUnload.apply(this,arguments);this.disconnect(this.controller,"change",this.onControllerChange)}});KJing.ResourceControllerViewer.register("file:image",KJing.ImageControllerViewer);KJing.FileProperties.extend("KJing.VideoProperties",{videoWidthField:void 0,videoHeightField:void 0,videoDurationField:void 0},{build:function(){KJing.VideoProperties.base.build.apply(this,arguments);this.remove(this.durationField);var a=this.resource.getData();"videoMediaInfo"in a&&(this.videoWidthField=new KJing.TextField({title:"Largeur",value:a.videoMediaInfo.width,disabled:!0,width:200}),this.insertAt(this.videoWidthField,1),this.videoHeightField=new KJing.TextField({title:"Hauteur",value:a.videoMediaInfo.height,
disabled:!0,width:200}),this.insertAt(this.videoHeightField,2),this.videoDurationField=new KJing.TextField({title:"Dur\u00e9e",value:this.formatDuration(a.videoMediaInfo.durationMilliseconds/1E3),disabled:!0,width:200}),this.insertAt(this.videoDurationField,3))}});KJing.ResourceProperties.register("file:video",KJing.VideoProperties);KJing.ResourceViewer.extend("KJing.VideoViewer",{pressable:void 0,player:void 0,playing:!1,constructor:function(a){this.addEvents("end");this.pressable=new Ui.Pressable;this.pressable.setLock(!0);this.setContent(this.pressable);this.connect(this.pressable,"press",this.onVideoPress)},onVideoEnd:function(a){this.playing=!1;this.fireEvent("end",this)},onVideoStateChange:function(a){this.pressable.setLock(this.player.getIsControlsVisible())},onVideoPress:function(){void 0!==this.player&&"playing"==this.player.getState()&&
this.player.pause()},uncurrent:function(){void 0!==this.player&&this.player.pause()},play:function(){this.playing=!0;var a=!navigator.iOs&&!navigator.Android;void 0!==this.player&&a&&this.player.play()},onResourceChange:function(){if(void 0===this.resource.getData().videoMp4)this.pressable.setContent(new Ui.Text({text:"Impossible de lire ce fichier vid\u00e9o",verticalAlign:"center",textAlign:"center"}));else{var a=KJing.File.create(this.resource.getData().videoMp4);"application/x-cache-progress"===
a.getMimetype()?(a=new Ui.VBox({verticalAlign:"center",spacing:10}),a.append(new Ui.Loading({width:50,height:50,horizontalAlign:"center"})),a.append(new Ui.Text({text:"Encodage en cours... Veuillez patienter",textAlign:"center"})),this.pressable.setContent(a)):"video/mp4"===a.getMimetype()?(this.player=new KJing.VideoPlayer({src:a.getDownloadUrl(),poster:this.resource.getPreviewHighUrl()}),this.connect(this.player,"statechange",this.onVideoStateChange),this.connect(this.player,"end",this.onVideoEnd),
this.pressable.setContent(this.player),this.playing&&this.play()):this.pressable.setContent(new Ui.Text({text:"Impossible de lire ce fichier vid\u00e9o",verticalAlign:"center",textAlign:"center"}))}}},{onVisible:function(){this.resource.monitor();void 0===this.player&&(this.connect(this.resource,"change",this.onResourceChange),this.onResourceChange())},onHidden:function(){this.resource.unmonitor();this.disconnect(this.resource,"change",this.onResourceChange);void 0!==this.player&&this.player.pause()}});
KJing.ResourceViewer.register("file:video",KJing.VideoViewer);Ui.LBox.extend("KJing.VideoControllerViewer",{controller:void 0,scroll:void 0,image:void 0,imageSrc:void 0,changeLock:!1,mediaController:void 0,mediaBar:void 0,constructor:function(a){this.controller=a.controller;delete a.controller;this.scroll=new Ui.ScrollingArea({maxScale:4});this.append(this.scroll);this.image=new KJing.ScaledImage2;this.scroll.setContent(this.image);this.mediaController=new KJing.MediaController({controller:this.controller,verticalAlign:"top",horizontalAlign:"left",width:0,height:0});
this.append(this.mediaController);this.mediaBar=new KJing.MediaPlayBar({media:this.mediaController,verticalAlign:"bottom"});this.append(this.mediaBar);this.connect(this.scroll,"scroll",this.onControllerTransform)},onControllerTransform:function(){this.changeLock||this.controller.setTransform(-this.scroll.getRelativeOffsetX(),-this.scroll.getRelativeOffsetY(),this.scroll.getScale())},onControllerChange:function(){var a;"file:image:gif"===this.controller.getResource().getType()?a=this.controller.getResource().getDownloadUrl():
void 0!==this.controller.getResource().getPreviewHighUrl()&&(a=this.controller.getResource().getPreviewHighUrl());this.imageSrc!==a&&(this.imageSrc=a,this.image.setSrc(a));!this.scroll.getIsDown()&&!this.scroll.getIsInertia()&&(this.changeLock=!0,this.scroll.setScale(this.controller.getTransform().scale),this.scroll.setOffset(-this.controller.getTransform().x,-this.controller.getTransform().y,!1),this.changeLock=!1)}},{onLoad:function(){KJing.VideoControllerViewer.base.onLoad.apply(this,arguments);
this.connect(this.controller,"change",this.onControllerChange);if(this.controller.getIsReady())this.onControllerChange()},onUnload:function(){KJing.VideoControllerViewer.base.onUnload.apply(this,arguments);this.disconnect(this.controller,"change",this.onControllerChange)}});KJing.ResourceControllerViewer.register("file:video",KJing.VideoControllerViewer);KJing.FileProperties.extend("KJing.AudioProperties",{audioDurationField:void 0},{build:function(){KJing.AudioProperties.base.build.apply(this,arguments);this.remove(this.durationField);var a=this.resource.getData();"audioMediaInfo"in a&&(this.audioDurationField=new KJing.TextField({title:"Dur\u00e9e",value:this.formatDuration(a.audioMediaInfo.durationMilliseconds/1E3),disabled:!0,width:200}),this.insertAt(this.audioDurationField,1))}});KJing.ResourceProperties.register("file:audio",KJing.AudioProperties);KJing.ResourceViewer.extend("KJing.AudioViewer",{player:void 0,playing:!1,constructor:function(a){this.addEvents("end")},uncurrent:function(){void 0!==this.player&&this.player.pause()},play:function(){this.playing=!0;var a=!navigator.iOs&&!navigator.Android;void 0!==this.player&&a&&this.player.play()},onMediaEnd:function(){this.fireEvent("end",this)},onResourceChange:function(){if(void 0===this.resource.getData().audioMp3)this.setContent(new Ui.Text({text:"Impossible d'\u00e9couter ce fichier son",
verticalAlign:"center",textAlign:"center"}));else{var a=KJing.File.create(this.resource.getData().audioMp3);"application/x-cache-progress"===a.getMimetype()?(a=new Ui.VBox({verticalAlign:"center",spacing:10}),a.append(new Ui.Loading({width:50,height:50,horizontalAlign:"center"})),a.append(new Ui.Text({text:"Encodage en cours... Veuillez patienter",textAlign:"center"})),this.setContent(a)):"audio/mpeg"===a.getMimetype()?(this.player=new KJing.AudioPlayer({src:a.getDownloadUrl(),text:this.resource.getName()}),
this.connect(this.player,"end",this.onMediaEnd),this.setContent(this.player),this.playing&&this.play()):this.setContent(new Ui.Text({text:"Impossible d'\u00e9couter ce fichier son",verticalAlign:"center",textAlign:"center"}))}}},{onVisible:function(){this.resource.monitor();void 0===this.player&&(this.connect(this.resource,"change",this.onResourceChange),this.onResourceChange())},onHidden:function(){this.resource.unmonitor();this.disconnect(this.resource,"change",this.onResourceChange);void 0!==this.player&&
this.player.pause()}});KJing.ResourceViewer.register("file:audio",KJing.AudioViewer);Ui.LBox.extend("KJing.AudioControllerViewer",{controller:void 0,mediaController:void 0,mediaBar:void 0,constructor:function(a){this.controller=a.controller;delete a.controller;this.mediaController=new KJing.MediaController({controller:this.controller,verticalAlign:"top",horizontalAlign:"left",width:0,height:0});this.append(this.mediaController);this.mediaBar=new KJing.MediaPlayBar({media:this.mediaController,verticalAlign:"bottom"});this.append(this.mediaBar)}});
KJing.ResourceControllerViewer.register("file:audio",KJing.AudioControllerViewer);KJing.FileProperties.extend("KJing.PdfProperties",{pdfPagesField:void 0},{build:function(){KJing.PdfProperties.base.build.apply(this,arguments);var a;a=void 0!==this.resource.getData().pdf?this.resource.getData().pdf.pdfPages.length:this.resource.getData().pdfPages.length;this.pdfPagesField=new KJing.TextField({title:"Nombre de pages",width:300,disabled:!0,value:a});this.insertAt(this.pdfPagesField,1)}});KJing.ResourceProperties.register("file:application:pdf",KJing.PdfProperties);
KJing.ResourceProperties.register("file:application:msword",KJing.PdfProperties);Ui.ScrollingArea.extend("KJing.PdfPage",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.setMaxScale(4);this.setContent(new KJing.ScaledImage2({src:this.resource.getDownloadUrl()}))}});
Ui.CarouselableLoader.extend("KJing.PdfPagesLoader",{resource:void 0,pages:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.pages=this.resource.getData().pdfPages;void 0===this.pages&&(this.pages=[])}},{getMin:function(){return 0},getMax:function(){return this.pages.length-1},getElementAt:function(a){return new KJing.PdfPage({resource:KJing.Resource.create(this.pages[a])})}});
KJing.ResourceViewer.extend("KJing.PdfViewer",{data:void 0,isCurrent:!1,carousel:void 0,loader:void 0,checkTask:void 0,request:void 0,position:0,constructor:function(a){},onPagesReady:function(){void 0!==this.resource.getData().pdf?this.loader=new KJing.PdfPagesLoader({resource:KJing.Resource.create(this.resource.getData().pdf)}):this.loader=new KJing.PdfPagesLoader({resource:this.resource});this.carousel=new Ui.Carousel3({loader:this.loader});this.setContent(this.carousel)},onResourceChange:function(){this.onPagesReady()}},
{onLoad:function(){KJing.PdfViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange();this.resource.monitor()},onUnload:function(){KJing.PdfViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});KJing.ResourceViewer.register("file:application:pdf",KJing.PdfViewer);KJing.ResourceViewer.register("file:application:msword",KJing.PdfViewer);Ui.ScrollingArea.extend("KJing.PdfPageControllerViewer",{pageController:void 0,resource:void 0,image:void 0,changeLock:!1,constructor:function(a){this.pageController=a.pageController;delete a.pageController;this.resource=this.pageController.getResource();this.setMaxScale(4);this.image=new KJing.ScaledImage2;this.setContent(this.image);if(this.pageController.getIsReady())this.onPageControllerReady();else this.connect(this.pageController,"ready",this.onPageControllerReady);this.connect(this,"scroll",
this.onPageTransform)},onPageControllerReady:function(){this.image.setSrc(this.resource.getDownloadUrl())},onPageTransform:function(){this.changeLock||this.pageController.setTransform(-this.getRelativeOffsetX(),-this.getRelativeOffsetY(),this.getScale())},onPageControllerChange:function(){!this.getIsDown()&&!this.getIsInertia()&&(this.changeLock=!0,this.setScale(this.pageController.getTransform().scale),this.setOffset(-this.pageController.getTransform().x,-this.pageController.getTransform().y,!1),
this.changeLock=!1)},onControllerChange:function(){this.pageController.updateControllerData()}},{onLoad:function(){KJing.PdfPageControllerViewer.base.onLoad.apply(this,arguments);this.connect(this.pageController,"change",this.onPageControllerChange);this.connect(this.pageController.getController(),"change",this.onControllerChange);this.onPageControllerChange()},onUnload:function(){KJing.PdfPageControllerViewer.base.onUnload.apply(this,arguments);this.disconnect(this.pageController.getController(),
"change",this.onControllerChange);this.disconnect(this.pageController,"change",this.onPageControllerChange)}});
Ui.CarouselableLoader.extend("KJing.PdfControllerPagesLoader",{controller:void 0,pagesControl:void 0,constructor:function(a){this.controller=a.controller;delete a.controller;a=this.controller.getData();void 0!==a&&(this.pagesControl=a.pages);void 0===this.pagesControl&&(this.pagesControl=[])}},{getMin:function(){return 0},getMax:function(){return this.pagesControl.length-1},getElementAt:function(a){var b=this.pagesControl[a];console.log(this+".getElementAt("+a+") => "+JSON.stringify(b));if(void 0===
b)return new Ui.Element;a=KJing.Resource.create(b.path);a=new KJing.PageController({controller:this.controller,resource:a,id:b.id});a.updateData(b);return new KJing.PdfPageControllerViewer({pageController:a})}});
Ui.Carousel3.extend("KJing.PdfControllerViewer",{controller:void 0,loader:void 0,constructor:function(a){this.controller=a.controller;delete a.controller;this.loader=new KJing.PdfControllerPagesLoader({controller:this.controller});this.setLoader(this.loader);this.setBufferingSize(1);a=this.controller.getPosition();void 0===a&&(a=0);this.setCurrentAt(a,!0);this.connect(this,"change",this.onCarouselPageChange)},onCarouselPageChange:function(a,b){this.controller.setPosition(b)},onControllerChange:function(){var a=
this.controller.getPosition();void 0===a&&(a=0);this.setCurrentAt(a)}},{onLoad:function(){KJing.PdfControllerViewer.base.onLoad.apply(this,arguments);this.connect(this.controller,"change",this.onControllerChange);this.onControllerChange()},onUnload:function(){KJing.PdfControllerViewer.base.onUnload.apply(this,arguments);this.disconnect(this.controller,"change",this.onControllerChange)}});KJing.ResourceControllerViewer.register("file:application:pdf",KJing.PdfControllerViewer);KJing.ResourceCreator.extend("KJing.SiteCreator",{urlField:void 0,constructor:function(a){this.setType("file:text:uri-list");this.urlField=new KJing.TextField({title:"URL",width:350});this.connect(this.urlField,"change",this.checkValid);this.append(this.urlField)}},{create:function(){for(var a="----",b=0;16>b;b++)a+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(62*Math.random())];a+="----";b=new Core.HttpRequest({method:"POST",url:"/cloud/file"});b.setRequestHeader("Content-Type",
"multipart/form-data; boundary="+a);b.setContent("--"+a+'\r\nContent-Disposition: form-data; name="define"\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify({type:this.type,parent:this.resource.getId(),name:this.nameField.getValue(),mimetype:"text/uri-list",position:0})+"\r\n--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="noname"\r\nContent-Type: text/plain; charset=UTF-8\r\n\r\n'+this.urlField.getValue()+"\r\n--"+a+"--\r\n");this.connect(b,"done",this.onRequestDone);
this.connect(b,"done",this.onRequestFail);b.send()},checkValid:function(){var a=/^http(s){0,1}:\/\/.+?/,a=""!==this.nameField.getValue()&&a.test(this.urlField.getValue());this.valid!==a&&((this.valid=a)?this.fireEvent("valid",this):this.fireEvent("notvalid",this))}});KJing.ResourceCreator.register("urlfile",KJing.SiteCreator,"earth","Lien vers un site");KJing.ResourceProperties.extend("KJing.SiteProperties",{siteUrlField:void 0,onContentLoaded:function(a){this.siteUrlField.setValue(a.getResponseText());this.siteUrlField.enable()}},{build:function(){KJing.SiteProperties.base.build.apply(this,arguments);this.siteUrlField=new KJing.TextField({title:"URL du site Web",width:300,disabled:!0});this.insertAt(this.siteUrlField,1);var a=new Core.HttpRequest({method:"GET",url:this.resource.getDownloadUrl()});this.connect(a,"done",this.onContentLoaded);a.send()},
save:function(){return this.resource.changeData(this.getPropertiesJson(),this.siteUrlField.getValue())}});KJing.ResourceProperties.register("file:text:uri-list",KJing.SiteProperties);KJing.ResourceViewer.extend("KJing.SiteViewer",{text:void 0,image:void 0,constructor:function(a){a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center",spacing:10});this.setContent(a);var b=new Ui.LBox({verticalAlign:"bottom",horizontalAlign:"center"});a.append(b);this.image=new Ui.Image({width:128});b.append(this.image);this.connect(this.image,"error",function(){b.setContent(new Ui.Icon({icon:"earth",verticalAlign:"bottom",horizontalAlign:"center",width:128}))});this.text=new Ui.Text({textAlign:"center",
fontSize:20});a.append(this.text);this.linkButton=new Ui.LinkButton({text:"Ouvrir le site",horizontalAlign:"center"});this.linkButton.disable();a.append(this.linkButton)},onResourceChange:function(){var a=new Core.HttpRequest({method:"GET",url:this.resource.getDownloadUrl()});this.connect(a,"done",this.onContentLoaded);a.send();void 0!==this.resource.getPreviewUrl()&&this.image.setSrc(this.resource.getPreviewUrl());this.text.setText(this.resource.getName())},onContentLoaded:function(a){this.linkButton.setSrc(a.getResponseText());
this.linkButton.enable()}},{onLoad:function(){KJing.SiteViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange();this.resource.monitor()},onUnload:function(){KJing.SiteViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});KJing.ResourceViewer.register("file:text:uri-list",KJing.SiteViewer);Ui.LBox.extend("KJing.SiteControllerViewer",{controller:void 0,text:void 0,linkButton:void 0,lbox:void 0,constructor:function(a){this.controller=a.controller;delete a.controller;a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center",spacing:10});this.setContent(a);this.lbox=new Ui.LBox({verticalAlign:"bottom",horizontalAlign:"center"});a.append(this.lbox);this.lbox.setContent(new Ui.Icon({icon:"earth",width:128,height:128}));this.text=new Ui.Text({textAlign:"center",fontSize:20});a.append(this.text);
this.linkButton=new Ui.LinkButton({text:"Ouvrir le site",horizontalAlign:"center"});this.linkButton.disable();a.append(this.linkButton)},onControllerChange:function(){var a=new Core.HttpRequest({method:"GET",url:this.controller.getResource().getDownloadUrl()});this.connect(a,"done",this.onContentLoaded);a.send()},onContentLoaded:function(a){this.linkButton.setSrc(a.getResponseText());this.linkButton.enable();this.text.setText(this.controller.getResource().getName());void 0!==this.controller.getResource().getPreviewUrl()?
this.lbox.setContent(new Ui.Image({width:128,src:this.controller.getResource().getPreviewUrl()})):this.lbox.setContent(new Ui.Icon({icon:"earth",width:128,height:128}))}},{onLoad:function(){KJing.SiteControllerViewer.base.onLoad.apply(this,arguments);this.connect(this.controller,"change",this.onControllerChange);if(this.controller.getIsReady())this.onControllerChange()},onUnload:function(){KJing.SiteControllerViewer.base.onUnload.apply(this,arguments);this.disconnect(this.controller,"change",this.onControllerChange)}});
KJing.ResourceControllerViewer.register("file:text:uri-list",KJing.SiteControllerViewer);KJing.ResourceViewer.extend("KJing.LinkViewer",{linkedResource:void 0,linkedView:void 0,constructor:function(a){if(this.resource.getIsReady())this.onResourceReady();else this.connect(this.resource,"ready",this.onResourceReady)},onResourceReady:function(){this.linkedResource=this.resource.getLinkedResource();this.linkedView=KJing.ResourceViewer.create(this.linkedResource);this.setContent(this.linkedView)}},{getSetupPopup:function(){return void 0!==this.linkedView&&"getSetupPopup"in this.linkedView?
this.linkedView.getSetupPopup():new Ui.MenuPopup}});KJing.ResourceViewer.register("link",KJing.LinkViewer);Ui.LBox.extend("KJing.LinkIcon",{resource:void 0,icon:void 0,tags:void 0,ownerImage:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.icon=new Ui.Icon({icon:"draglink"});this.setContent(this.icon)},setSquareSize:function(a){Ui.Icon.hasInstance(this.icon)?(this.icon.setWidth(a),this.icon.setHeight(a)):this.icon.setSquareSize(a)},setRoundMode:function(a){Ui.Icon.hasInstance(this.icon)||this.icon.setRoundMode(a)},setTags:function(a){this.tags=a;Ui.Icon.hasInstance(this.icon)||
this.icon.setTags(a)},setOwnerImage:function(a){this.ownerImage=a;Ui.Icon.hasInstance(this.icon)||this.icon.setOwnerImage(a)},onResourceChange:function(){if(Ui.Icon.hasInstance(this.icon)){var a=this.resource.getLinkedResource();this.icon=KJing.ResourceIcon.create(a);this.setContent(this.icon);void 0!==this.ownerImage&&this.icon.setOwnerImage(this.ownerImage);void 0!==this.tags&&this.icon.setTags(this.tags)}}},{onLoad:function(){KJing.LinkIcon.base.onLoad.apply(this,arguments);this.connect(this.resource,
"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange()},onUnload:function(){KJing.LinkIcon.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange)}});KJing.ResourceIcon.register("link",KJing.LinkIcon);KJing.ResourceIconViewer.extend("KJing.LinkIconViewer",{linkedResource:void 0,constructor:function(a){console.log(this+".new id: "+this.getResource().getId()+", getIsReady: "+this.getResource().getIsReady());if(this.getResource().getIsReady())this.onResourceReady();else this.connect(this.getResource(),"ready",this.onResourceReady);this.setItemTags(["link"])},onResourceReady:function(){this.linkedResource=this.getResource().getLinkedResource();if(this.linkedResource.getIsReady())this.onLinkedResourceReady();
else this.connect(this.linkedResource,"ready",this.onLinkedResourceReady)},onLinkedResourceReady:function(){this.setItemName(this.getResource().getName());var a=KJing.Resource.create(this.linkedResource.getOwnerId());if(a.getIsReady())this.onLinkedOwnerReady(a);else this.connect(a,"ready",this.onLinkedOwnerReady)},onLinkedOwnerReady:function(a){a.getId()!==Ui.App.current.getUser().getId()?this.setItemOwnerImage(a.getFaceUrl()):this.setItemOwnerImage(void 0)}});
KJing.ResourceIconViewer.register("link",KJing.LinkIconViewer);KJing.ResourceViewer.extend("KJing.SearchViewer",{flow:void 0,filterType:void 0,constructor:function(a){this.flow=new Ui.Flow({uniform:!0});this.setContent(this.flow)},onResourceError:function(){this.flow.clear()},onResourceChange:function(){this.flow.clear();this.flow.append(new KJing.NewIcon({disabled:!0}));for(var a=this.getResource().getResources(),b=0;b<a.length;b++){var c=KJing.ResourceIconViewer.create(a[b]);void 0!==c&&this.flow.append(c)}},onTypeFilterChange:function(a,b,c){this.filterType=
b.type;this.getResource().setFilter("type",b.type)}},{getSetupPopup:function(){var a=new Ui.MenuPopup,b=new Ui.VBox({spacing:10});a.setContent(b);var c=[{text:"Tous types",type:void 0},{text:"Personnes",type:"user"},{text:"Groupes",type:"group"},{text:"Fichiers",type:"file"},{text:"Dossiers",type:"folder"},{text:"Liens",type:"link"},{text:"Salles de diffusion",type:"map"},{text:"Clients",type:"device"}],d=new Ui.Combo({field:"text",placeHolder:"choice...",data:c});b.append(d);for(var e=b=0;e<c.length;e++)if(c[e].type===
this.getResource().getFilter("type")){b=e;break}d.setCurrentAt(b);this.connect(d,"change",this.onTypeFilterChange);return a},getState:function(){if(void 0!==this.filterType)return{filterType:this.filterType}},setState:function(a){void 0!==a&&void 0!==a.filterType&&this.getResource().setFilter("type",a.filterType)},onLoad:function(){KJing.SearchViewer.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.connect(this.resource,"error",this.onResourceError);
this.resource.update();if(this.resource.getIsReady())this.onResourceChange()},onUnload:function(){KJing.SearchViewer.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.disconnect(this.resource,"error",this.onResourceError)}});KJing.ResourceViewer.register("search",KJing.SearchViewer);KJing.ResourceCreator.extend("KJing.StateCreator",{constructor:function(a){this.setType("file:application:x-kjing-state")}},{create:function(){for(var a="----",b=0;16>b;b++)a+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(62*Math.random())];a+="----";b=new Core.HttpRequest({method:"POST",url:"/cloud/file"});b.setRequestHeader("Content-Type","multipart/form-data; boundary="+a);b.setContent("--"+a+'\r\nContent-Disposition: form-data; name="define"\r\nContent-Type: application/x-kjing-state; charset=UTF-8\r\n\r\n'+
JSON.stringify({type:this.type,parent:this.resource.getId(),name:this.nameField.getValue(),mimetype:"application/x-kjing-state",position:0})+"\r\n--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="noname"\r\nContent-Type: application/x-kjing-state; charset=UTF-8\r\n\r\n[]\r\n--'+a+"--\r\n");this.connect(b,"done",this.onRequestDone);this.connect(b,"done",this.onRequestFail);b.send()}});KJing.ResourceCreator.register("statefile",KJing.StateCreator,"text","Etat clients / ressources");Ui.CanvasElement.extend("KJing.RoundDashedRectangle",{fill:void 0,borderWidth:2,radius:3,constructor:function(a){"fill"in a?(this.fill=Ui.Color.create(a.fill),delete a.fill):this.fill=Ui.Color.create("#000000")},setBorderWidth:function(a){this.borderWidth=a;this.invalidateDraw()},setRadius:function(a){this.radius=a;this.invalidateDraw()},setFill:function(a){this.fill=Ui.Color.create(a);this.invalidateDraw()}},{updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight(),d=Math.max(0,
Math.min(this.radius,Math.min(b/2,c/2)));a.strokeStyle=this.fill.getCssRgba();a.lineWidth=2;a.setLineDash([10,5]);a.beginPath();a.roundRect(this.borderWidth/2,this.borderWidth/2,b-this.borderWidth,c-this.borderWidth,d,d,d,d);a.closePath();a.stroke()}});
Ui.Selectionable.extend("KJing.StateCombination",{contentBox:void 0,deviceBox:void 0,applyButton:void 0,constructor:function(a){this.addEvents("change","delete");this.setDraggableData(this);a=new Ui.HBox;this.append(a);this.contentBox=new KJing.StateContentDrop({width:100,height:100});this.connect(this.contentBox,"change",this.onPartChange);a.append(this.contentBox);this.applyButton=new Ui.Button({icon:"arrowright",horizontalAlign:"center",verticalAlign:"center",disabled:!0});this.connect(this.applyButton,
"press",this.onButtonPress);a.append(this.applyButton,!0);this.deviceBox=new KJing.StateDeviceDrop({width:100,height:100});this.connect(this.deviceBox,"change",this.onPartChange);a.append(this.deviceBox)},getDeviceResource:function(){return this.deviceBox.getResource()},setDeviceResource:function(a){this.deviceBox.setResource(a)},getContentResource:function(){return this.contentBox.getResource()},setContentResource:function(a){this.contentBox.setResource(a)},onButtonPress:function(){this.getDeviceResource().setPath(this.getContentResource().getId())},
onPartChange:function(a,b){void 0!==this.contentBox.getResource()&&void 0!==this.deviceBox.getResource()?this.applyButton.enable():this.applyButton.disable();this.fireEvent("change",this,this.contentBox.getResource(),this.deviceBox.getResource())},onCombinationDelete:function(){this.fireEvent("delete",this)}},{getSelectionActions:function(){return{"delete":{text:"Supprimer",icon:"trash",color:"#d02020",scope:this,callback:this.onCombinationDelete,multiple:!1}}}});
Ui.DropBox.extend("KJing.StateDeviceDrop",{dash:void 0,resource:void 0,resourceIconViewer:void 0,onContentDetachBinded:void 0,constructor:function(a){this.addEvents("change");this.dash=new KJing.RoundDashedRectangle({borderWidth:2,radius:3,fill:"rgba(50,50,50,0.4)"});this.append(this.dash);a=this.onItemEffect.bind(this);this.addType(KJing.Device,a);this.addType(KJing.Map,a);this.connect(this,"drop",this.onResourceDrop);this.onContentDetachBinded=this.onContentDetach.bind(this)},getResource:function(){return this.resource},
setResource:function(a){void 0!==this.resourceIconViewer&&(this.remove(this.resourceIconViewer),this.resourceIconViewer=void 0);this.resource=a;void 0!==this.resource?(this.resourceIconViewer=KJing.ResourceIconViewer.create(this.resource),this.append(this.resourceIconViewer),this.dash.hide()):this.dash.show();this.fireEvent("change",this,this.resource)},onResourceDrop:function(a,b,c,d,e){(KJing.Map.hasInstance(b)||KJing.Device.hasInstance(b))&&this.setResource(b)},onItemEffect:function(a){return void 0===
this.resource||this.resource.getId()!==a.getId()?["link"]:[]},onContentDetach:function(a){a=a.getElements();for(var b=0;b<a.length;b++)a[b]===this.resourceIconViewer&&this.setResource(void 0)},getContextActions:function(a,b){return KJing.DeviceItemView.hasInstance(a)?{detach:{text:"Retirer",icon:"trash",callback:this.onContentDetachBinded,multiple:!0}}:b}});
Ui.DropBox.extend("KJing.StateContentDrop",{dash:void 0,resource:void 0,resourceIconViewer:void 0,onContentDetachBinded:void 0,constructor:function(a){this.addEvents("change");this.dash=new KJing.RoundDashedRectangle({borderWidth:2,radius:3,fill:"rgba(50,50,50,0.4)"});this.append(this.dash);a=this.onItemEffect.bind(this);this.addType(KJing.Folder,a);this.addType(KJing.File,a);this.connect(this,"drop",this.onResourceDrop);this.onContentDetachBinded=this.onContentDetach.bind(this)},getResource:function(){return this.resource},
setResource:function(a){void 0!==this.resourceIconViewer&&(this.remove(this.resourceIconViewer),this.resourceIconViewer=void 0);this.resource=a;void 0!==this.resource?(this.resourceIconViewer=KJing.ResourceIconViewer.create(this.resource),this.append(this.resourceIconViewer),this.dash.hide()):this.dash.show();this.fireEvent("change",this,this.resource)},onItemEffect:function(a){return void 0===this.resource||this.resource.getId()!==a.getId()?["link"]:[]},onResourceDrop:function(a,b,c,d,e){KJing.Resource.hasInstance(b)&&
this.setResource(b)},onContentDetach:function(a){a=a.getElements();for(var b=0;b<a.length;b++)a[b]===this.resourceIconViewer&&this.setResource(void 0)},getContextActions:function(a,b){return KJing.IconViewer.hasInstance(a)?{detach:{text:"Retirer",icon:"trash",callback:this.onContentDetachBinded,multiple:!0}}:b}});
KJing.ResourceViewer.extend("KJing.StateViewer",{data:void 0,combinationsBox:void 0,constructor:function(a){this.setContent(new Ui.Text({text:"Chargement en cours...",textAlign:"center",verticalAlign:"center"}));a=new Core.HttpRequest({method:"GET",url:this.resource.getDownloadUrl()});this.connect(a,"done",this.onDataLoaded);a.send()},supportUpdate:function(){return!0},onPlayPress:function(){for(var a=0;a<this.combinationsBox.getChildren().length;a++){var b=this.combinationsBox.getChildren()[a];void 0!==
b.getContentResource()&&void 0!==b.getDeviceResource()&&b.getDeviceResource().setPath(b.getContentResource().getId())}},onDataLoaded:function(a){this.data=a.getResponseJSON();a=new Ui.VBox({margin:10,spacing:10});this.setContent(a);var b=new Ui.ScrollingArea;a.append(b,!0);this.combinationsBox=new Ui.VBox;b.setContent(this.combinationsBox);for(b=0;b<this.data.length;b++){var c=new KJing.StateCombination({contentResource:null!==this.data[b].path?KJing.Resource.create(this.data[b].path):void 0,deviceResource:null!==
this.data[b].device?KJing.Resource.create(this.data[b].device):void 0});this.connect(c,"change",this.onCombinationChange);this.connect(c,"delete",this.onCombinationDelete);this.combinationsBox.append(c)}b=new KJing.StateCombination;this.connect(b,"change",this.onCombinationChange);this.connect(b,"delete",this.onCombinationDelete);this.combinationsBox.append(b);b=new Ui.DefaultButton({text:"Appliquer",verticalAlign:"center"});this.connect(b,"press",this.onPlayPress);a.append(b)},onCombinationChange:function(a,
b,c){a=this.combinationsBox.getChildren()[this.combinationsBox.getChildren().length-1];void 0!==a.getContentResource()&&void 0!==a.getDeviceResource()&&(a=new KJing.StateCombination,this.connect(a,"change",this.onCombinationChange),this.combinationsBox.append(a));this.saveCombinations()},onCombinationDelete:function(a){this.disconnect(a,"change",this.onCombinationChange);this.disconnect(a,"delete",this.onCombinationDelete);this.combinationsBox.remove(a);this.saveCombinations()},saveCombinations:function(){for(var a=
[],b=0;b<this.combinationsBox.getChildren().length;b++){var c=this.combinationsBox.getChildren()[b];if(void 0!==c.getContentResource()||void 0!==c.getDeviceResource()){var d=void 0!==c.getDeviceResource()?c.getDeviceResource().getId():null,c=void 0!==c.getContentResource()?c.getContentResource().getId():null;a.push({device:d,path:c})}}b=new Core.HttpRequest({method:"PUT",url:"/cloud/file/"+encodeURIComponent(this.resource.getId())+"/content"});b.setRequestHeader("Content-Type","application/x-kjing-state");
b.setContent(JSON.stringify(a));b.send();return b}});KJing.ResourceViewer.register("file:application:x-kjing-state",KJing.StateViewer);Ui.ScrollingArea.extend("KJing.PartView",{user:void 0,locator:void 0,locatorScroll:void 0,setupButton:void 0,content:void 0,contextBar:void 0,selection:void 0,stack:void 0,constructor:function(a){this.user=a.user;delete a.user;this.stack=[];this.setScrollHorizontal(!1);this.vbox=new Ui.VBox;this.setContent(this.vbox);a=new Ui.HBox;this.vbox.append(a);this.locatorScroll=new Ui.ScrollingArea({scrollVertical:!1});a.append(this.locatorScroll,!0);this.locator=new Ui.Locator({path:"/",horizontalAlign:"left",
margin:5});this.connect(this.locator,"change",this.onPathChange);this.locatorScroll.setContent(this.locator);this.setupButton=new Ui.Button({margin:5,icon:"gear"});this.setupButton.hide(!0);a.append(this.setupButton);this.connect(this.setupButton,"press",this.onSetupPress);this.push("Root",this.user.getId())},onSetupPress:function(a,b,c){this.content.getSetupPopup().open(a,"bottom")},getContentView:function(){return this.content},getStack:function(){return this.stack},setStack:function(a){this.stack=
a;a=this.stack[this.stack.length-1];void 0!==this.content&&this.vbox.remove(this.content);this.content=KJing.ResourceViewer.create(a.resource);this.vbox.append(this.content,!0);this.updateLocator();"getSetupPopup"in this.content?this.setupButton.show():this.setupButton.hide(!0)},push:function(a,b){if(void 0!==this.content){var c=this.content.getState();void 0!==c&&(this.stack[this.stack.length-1].state=c);this.vbox.remove(this.content)}this.stack.push({text:a,resource:b});this.resource=KJing.Resource.create(b);
this.content=KJing.ResourceViewer.create(this.resource);this.vbox.append(this.content,!0);this.updateLocator();"getSetupPopup"in this.content?this.setupButton.show():this.setupButton.hide(!0)},pop:function(){this.stack.pop()},updateLocator:function(){for(var a="",b=0;b<this.stack.length;b++)var c=this.stack[b],a=""===a?"/":"/"===a?a+c.text:a+("/"+c.text);this.locator.setPath(a)},onPathChange:function(a,b,c){void 0!==this.content&&(this.vbox.remove(this.content),a=this.content.getState(),void 0!==
a&&(this.stack[this.stack.length-1].state=a));a=this.stack[c];this.stack.splice(c+1,this.stack.length-c-1);this.resource=KJing.Resource.create(a.resource);this.content=KJing.ResourceViewer.create(this.resource);void 0!==a.state&&this.content.setState(a.state);this.vbox.append(this.content,!0);this.updateLocator();"getSetupPopup"in this.content?this.setupButton.show():this.setupButton.hide(!0)}});Ui.MenuToolBar.extend("KJing.MenuToolBar",{});
Ui.Button.extend("KJing.UserProfilButton",{userIcon:void 0,constructor:function(a){this.user=a.user;delete a.user;this.userIcon=new KJing.RoundItemGraphic({imageSrc:this.user.getFaceUrl(),width:48,height:48});this.setIcon(this.userIcon);this.setText(this.user.getName())}},{onStyleChange:function(){KJing.UserProfilButton.base.onStyleChange.apply(this,arguments);var a=this.getStyleProperty("iconSize");this.userIcon.setWidth(a);this.userIcon.setHeight(a)}});
Ui.Button.extend("KJing.Bookmark",{bookmark:void 0,constructor:function(a){this.bookmark=a.bookmark;delete a.bookmark;this.setIcon("star");this.setText(this.bookmark.name);this.setDraggableData(this)},suppress:function(){Ui.App.current.deleteBookmark(this.bookmark)},open:function(){this.onPress()}},{getSelectionActions:function(){return{suppress:{text:"Supprimer",icon:"trash",scope:this,callback:this.suppress,multiple:!0},open:{"default":!0,text:"Ouvrir",icon:"eye",scope:this,callback:this.open,multiple:!1}}},
onPress:function(){Ui.App.current.setState(this.bookmark.state)}});
Ui.MenuPopup.extend("KJing.DisplayPopup",{app:void 0,bookmarksVBox:void 0,constructor:function(a){this.app=a.app;delete a.app;a=new Ui.VBox;this.setContent(a);var b=new Ui.SegmentBar({margin:10,field:"text",data:[{text:"Horizontal",value:"horizontal"},{text:"Vertical",value:"vertical"}]});a.append(b);"horizontal"===this.app.paned.getOrientation()?b.setCurrentPosition(0):b.setCurrentPosition(1);this.connect(b,"change",function(a,b){this.app.paned.setOrientation(b.value)});b=new Ui.DefaultButton({icon:"switch",
text:"Inverser",margin:10});a.append(b);this.connect(b,"press",function(){this.app.paned.invert()});a.append(new Ui.Text({fontWeight:"bold",text:"Favoris",margin:10}));b=new Ui.DefaultButton({text:"Ajouter un favori",margin:10});this.connect(b,"press",function(){var a=new Ui.Dialog({preferredWidth:300,title:"Nouveau favori"}),b=new KJing.TextField({title:"Nom",value:"Nouveau"});a.setContent(b);a.setCancelButton(new Ui.DialogCloseButton);var e=new Ui.DefaultButton({text:"Enregistrer"});this.connect(e,
"press",function(){this.app.addBookmark(b.getValue(),this.app.saveDisplayState());a.close()});a.setActionButtons([e]);a.open()});a.append(b);this.bookmarksVBox=new Ui.VBox;a.append(this.bookmarksVBox)},onBookmarksChange:function(){this.bookmarksVBox.clear();for(var a=this.app.getBookmarks(),b=0;b<a.length;b++)this.bookmarksVBox.append(new KJing.Bookmark({bookmark:a[b]}))}},{onLoad:function(){KJing.DisplayPopup.base.onLoad.call(this);this.connect(this.app,"bookmarkschange",this.onBookmarksChange);
this.onBookmarksChange()},onUnload:function(){KJing.DisplayPopup.base.onUnload.call(this);this.disconnect(this.app,"bookmarkschange",this.onBookmarksChange)}});
Ui.App.extend("KJing.AdminApp",{user:void 0,selection:void 0,menuBox:void 0,actionBox:void 0,contextBox:void 0,title:void 0,loginDialog:void 0,paned:void 0,uploadProgressbar:void 0,uploaders:void 0,messageButton:void 0,messages:void 0,constructor:function(a){this.addEvents("bookmarkschange");this.uploaders=[];this.sendGetAuthSession();this.connect(this.getDrawing(),"keyup",this.onKeyUp)},sendGetAuthSession:function(){var a=void 0;void 0!=this.getArguments().authsession?a=this.getArguments().authsession:
"localStorage"in window&&(a=localStorage.getItem("authsession"));var b="/cloud/authsession/",b=void 0!=a?b+encodeURIComponent(a):b+"current",a=new Core.HttpRequest({method:"GET",url:b+"?setcookie=1"});this.connect(a,"done",this.onGetAuthSessionDone);this.connect(a,"error",this.onGetAuthSessionError);a.send()},onGetAuthSessionError:function(a){"localStorage"in window&&void 0==this.getArguments().authsession&&localStorage.removeItem("authsession");this.basicLogin()},onGetAuthSessionDone:function(a){a=
a.getResponseJSON();this.sessionId=a.id;"localStorage"in window&&void 0==this.getArguments().authsession&&localStorage.getItem("authsession")!=a.id&&localStorage.setItem("authsession",a.id);a=a.user;void 0!=this.getArguments().user&&(a=this.getArguments().user);this.user=KJing.Resource.create(a);this.connect(this.user,"ready",this.onLoginDone);this.connect(this.user,"error",this.onGetUserError);this.connect(this.user,"delete",this.onGetUserError)},onGetUserError:function(a){this.user=void 0;"localStorage"in
window&&this.sessionId==localStorage.getItem("authsession")&&localStorage.removeItem("authsession");this.basicLogin()},getUser:function(){return this.user},getMessages:function(){return this.messages},basicLogin:function(){this.loginDialog=new KJing.LoginWizard;this.connect(this.loginDialog,"done",this.onBasicLoginDone);this.loginDialog.open()},onBasicLoginDone:function(a){a.close();this.sendGetAuthSession()},onLoginDone:function(a){this.user.monitor();this.messages=new KJing.Messages({user:this.user});
this.connect(this.messages,"change",this.onMessagesChange);this.messages.monitor();a=new Ui.VBox;this.setContent(a);this.selection=new Ui.Selection;this.connect(this.selection,"change",this.onSelectionChange);this.menuBox=new Ui.LBox;a.append(this.menuBox);this.actionBox=new KJing.MenuToolBar({padding:5,spacing:10});this.menuBox.append(this.actionBox);var b=new Ui.LBox;this.actionBox.append(b,!1);this.title=new Ui.Image({src:"img/logo-kjing.svg",horizontalAlign:"left",verticalAlign:"center",width:120});
b.append(this.title);this.uploadProgressbar=new Ui.ProgressBar({verticalAlign:"bottom"});this.uploadProgressbar.hide();b.append(this.uploadProgressbar);this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.actionBox.append(this.searchField,!0);b=new Ui.Button({icon:"eye"});this.connect(b,"press",this.onDisplayPress);this.actionBox.append(b);this.messageButton=new Ui.Button({icon:"bell"});this.connect(this.messageButton,
"press",this.onMessagePress);this.actionBox.append(this.messageButton);b=new Ui.Button({icon:"person"});this.connect(b,"press",this.onProfilPress);this.actionBox.append(b);this.contextBox=new Ui.ContextBar({selection:this.selection});this.contextBox.hide();this.menuBox.append(this.contextBox);b=localStorage.getItem("panedPos")||0.5;this.paned=new Ui.Paned({orientation:"horizontal",pos:b});this.connect(this.paned,"change",this.onPanedChange);a.append(this.paned,!0);this.paned.setContent1(new KJing.PartView({user:this.user}));
this.paned.setContent2(new KJing.PartView({user:this.user}))},onMessagesChange:function(){for(var a=this.messages.getMessages(),b=0,c=0;c<a.length;c++)a[c].getSeen()||a[c].getOrigin()!==this.user.getId()&&b++;0<b?this.messageButton.setBadge(b):this.messageButton.setBadge(void 0)},onSearchValidate:function(a,b){var c=[];c.push(this.paned.getContent2().getStack()[0]);c.push({text:"Recherche: "+b,resource:"search:"+b});this.setMainStack(c)},setMainStack:function(a){this.paned.getContent2().setStack(a)},
onProfilPress:function(a){var b=new Ui.MenuPopup,c=new Ui.VBox;b.setContent(c);var d=new KJing.UserProfilButton({user:this.user});this.connect(d,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.user})).open();b.close()});c.append(d);c.append(new Ui.Separator);d=new Ui.Button({icon:"exit",text:"D\u00e9connecter"});this.connect(d,"press",this.onLogoutPress);c.append(d);b.open(a,"bottom")},onMessagePress:function(a){(new KJing.HistoryMessagesPopup({messages:this.messages})).open(a,
"bottom")},saveDisplayState:function(){return{orientation:this.paned.getOrientation(),position:this.paned.getPos(),part1:this.paned.getContent1().getStack(),part2:this.paned.getContent2().getStack()}},setState:function(a){this.paned.setOrientation(a.orientation);this.paned.setPos(a.position);this.paned.getContent1().setStack(a.part1);this.paned.getContent2().setStack(a.part2)},onDisplayPress:function(a){(new KJing.DisplayPopup({app:this})).open(a,"bottom")},getBookmarks:function(){var a=this.user.getUserData();
"bookmarks"in a||(a.bookmarks=[]);return a.bookmarks},addBookmark:function(a,b){var c={name:a,state:b};this.getBookmarks().unshift(c);this.user.changeData({data:this.user.getUserData()});this.fireEvent("bookmarkschange",this)},deleteBookmark:function(a){for(var b=this.getBookmarks(),c=0;c<b.length;c++)if(b[c].id===a.id){b.splice(c,1);break}this.user.changeData({data:this.user.getUserData()});this.fireEvent("bookmarkschange",this)},onLogoutPress:function(a){"localStorage"in window&&(localStorage.removeItem("login"),
localStorage.removeItem("password"),localStorage.removeItem("authsession"));document.cookie="KJING_AUTH=; expires=Thu, 01-Jan-1970 00:00:01 GMT";a=new Core.HttpRequest({method:"DELETE",url:"/cloud/authsession/current"});this.connect(a,"done",this.onAuthSessionDelete);this.connect(a,"error",this.onAuthSessionDelete);a.send()},onAuthSessionDelete:function(){var a=window.location.href;-1!=a.lastIndexOf("#")&&(a=a.substring(0,a.lastIndexOf("#")));window.location.replace(a)},onPanedChange:function(a,b){localStorage.setItem("panedPos",
b)},getUploaders:function(){return this.uploaders},getUploaderById:function(a){for(var b=0;b<this.uploaders.length;b++){var c=this.uploaders[b];if(c["KJing.AdminApp.uploaderId"]===a)return c}},addUploader:function(a){for(var b="uploader:"+this.user.getId()+":",c=0;16>c;c++)b+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(62*Math.random())];a["KJing.AdminApp.uploaderId"]=b;this.uploaders.push(a);1===this.uploaders.length&&this.uploadProgressbar.show();this.connect(a,"complete",
this.onUploaderComplete);this.connect(a,"error",this.onUploaderError);this.connect(a,"progress",this.updateUploaders);this.updateUploaders();return b},updateUploaders:function(){for(var a=0,b=0,c=0,d=0,e=0;e<this.uploaders.length;e++){var f=this.uploaders[e];void 0!=f.getTotal()&&(c+=f.getTotal(),d+=f.getIsCompleted()?f.getTotal():f.getLoaded(),b++);a++}this.uploadProgressbar.setValue(d/c)},onUploaderError:function(a,b){console.log(this+".onUploaderError status: "+b);var c=a.getResponseJSON();403===
b&&3===c.code&&(new Ui.Dialog({title:"D\u00e9passement de quota",preferredWidth:400,cancelButton:new Ui.DialogCloseButton,content:new Ui.Text({text:"Le t\u00e9l\u00e9versement du fichier a \u00e9chou\u00e9 car le quota de l'utilisateur est d\u00e9pass\u00e9."})})).open();this.onUploaderComplete(a)},onUploaderComplete:function(a){a=!0;for(var b=0;a&&b<this.uploaders.length;b++)a=this.uploaders[b].getIsCompleted();this.updateUploaders();a&&(this.uploaders=[],this.uploadProgressbar.hide(!0))},getSelectionHandler:function(){return this.selection},
onSelectionChange:function(a){0===a.getElements().length?(this.contextBox.hide(),this.actionBox.show()):(this.contextBox.show(),this.actionBox.hide())},onKeyUp:function(a){46===a.which&&0<this.selection.getElements().length&&(a.stopPropagation(),a.preventDefault(),this.selection.executeDeleteAction())}});
var theme={background:"#fdfdfd",foreground:"#555",roundness:3,thickness:1},app=new KJing.AdminApp({webApp:!0,style:{"Ui.Element":{color:theme.foreground,fontSize:16,interLine:1.4},"Ui.Popup":{background:theme.background,"Ui.Button":{background:new Ui.Color({r:1,g:1,b:1,a:0.1}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0.1}),activeBackground:"rgb(33,211,255)",activeBackgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0.1}),activeForeground:"#555555"},"Ui.ActionButton":{showText:!1}},"Ui.SegmentBar":{activeBackground:"#555555",
background:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackground:new Ui.Color({r:1,g:1,b:1,a:0}),radius:theme.roundness,borderWidth:theme.thickness},"Ui.Dialog":{background:theme.background},"Ui.DialogTitle":{fontSize:20,maxLine:2,interLine:1},"Ui.DialogCloseButton":{background:"rgba(250,250,250,0)",backgroundBorder:"rgba(250,250,250,0)"},"Ui.ContextBarCloseButton":{textWidth:5,borderWidth:1,background:"rgba(250,250,250,0)",backgroundBorder:"rgba(250,250,250,0)",foreground:theme.background,radius:theme.roundness},
"Ui.Separator":{color:"#999999"},"Ui.CheckBox":{color:theme.foreground,checkColor:theme.background,activeColor:new Ui.Color({r:0.03,g:0.63,b:0.9}),focusColor:new Ui.Color({r:0.13,g:0.83,b:1})},"Ui.ScrollingArea":{color:"#999999",showScrollbar:!1,overScroll:!0,radius:0},"Ui.VBoxScrollingArea":{color:"#999999",showScrollbar:!1,overScroll:!0,radius:0},"Ui.Button":{radius:theme.roundness,borderWidth:theme.thickness,background:theme.background,backgroundBorder:theme.foreground,foreground:theme.foreground,
focusBackground:new Ui.Color({r:0.13,g:0.83,b:1,a:0.5})},"Ui.DefaultButton":{fontWeight:2<=theme.thickness?"bold":"normal",textTransform:"uppercase",background:theme.foreground,backgroundBorder:theme.foreground,foreground:"#fefefe"},"Ui.TextFieldButton":{padding:3},"Ui.TextBgGraphic":{radius:3,borderWidth:theme.thickness,background:Ui.Color.create(theme.foreground).addY(0.5).addA(-0.5),focusBackground:new Ui.Color({r:0.13,g:0.83,b:1,a:0.5})},"Ui.ActionButton":{background:new Ui.Color({r:1,g:1,b:1,
a:0}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0}),foreground:"#ffffff",radius:theme.roundness,borderWidth:1},"Ui.Slider":{foreground:new Ui.Color({r:0.03,g:0.63,b:0.9})},"Ui.Locator":{radius:theme.roundness,backgroundBorder:theme.foreground,borderWidth:theme.thickness,color:theme.background},"Ui.MenuToolBarButton":{color:new Ui.Color({r:0.8,g:0.8,b:0.8,a:0.2})},"Ui.ContextBar":{background:"#00b9f1","Ui.Element":{color:"#ffffff"}},"Ui.DialogButtonBox":{background:theme.background},"KJing.PosBar":{radius:0,
current:new Ui.Color({r:0.03,g:0.63,b:0.9})},"KJing.OptionOpenButton":{borderWidth:0,radius:0,iconSize:16,whiteSpace:"pre-line",background:"rgba(250,250,250,0)",focusForeground:new Ui.Color({r:0,g:0.72,b:0.95}),focusBackground:"rgba(250,250,250,0)"},"KJing.IconViewer":{orientation:"vertical",whiteSpace:"pre-line",textWidth:100,maxTextWidth:100,fontSize:16,interLine:1,textHeight:32,iconSize:64,maxLine:2,background:new Ui.Color({r:1,g:1,b:1,a:0}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackground:new Ui.Color({r:1,
g:1,b:1,a:0}),focusBackgroundBorder:new Ui.Color({r:0,g:0.72,b:0.95}),selectCheckColor:new Ui.Color({r:0,g:0.72,b:0.95}),radius:theme.roundness,borderWidth:theme.thickness},"KJing.UploadFaceButton":{padding:2},"KJing.UserIconViewer":{roundMode:!0},"KJing.RightIconViewer":{roundMode:!0},"Ui.MenuToolBar":{"Ui.Button":{fontWeight:2<=theme.thickness?"bold":"normal",textTransform:"uppercase",background:new Ui.Color({r:0.8,g:0.8,b:0.8,a:0})}},"KJing.MenuToolBar":{background:"#4285f4","Ui.Button":{background:new Ui.Color({r:1,
g:1,b:1,a:0}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0.3}),foreground:"#ffffff",focusBackground:new Ui.Color({r:0.43,g:1,b:1,a:0.6}),focusForeground:"#ffffff"},"Ui.TextBgGraphic":{background:"rgba(255,255,255,0.6)",focusBackground:new Ui.Color({r:0.43,g:1,b:1,a:0.6})},"Ui.Entry":{color:"#ffffff"}},"KJing.NewIcon":{background:new Ui.Color({r:1,g:1,b:1,a:0}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackground:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackgroundBorder:new Ui.Color({r:0,
g:0.72,b:0.95}),iconSize:48,padding:31,radius:theme.roundness,borderWidth:theme.thickness},"KJing.UserProfilButton":{iconSize:32},"KJing.UserNotifyView":{background:Ui.Color.create("rgba(150,150,255,0.1)")}}});app.getDrawing().style.background=Ui.Color.create(theme.background).getCssHtml();
