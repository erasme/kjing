Ui.LBox.extend("KJing.RatioBox",{ratio:1,constructor:function(a){},setRatio:function(a){this.ratio!==a&&(this.ratio=a,this.invalidateMeasure())}},{measureCore:function(a,b){var c,d;this.ratio>a/b?(c=a,d=c/this.ratio):(d=b,c=d*this.ratio);return KJing.RatioBox.base.measureCore.call(this,c,d)},arrangeCore:function(a,b){var c,d,e,f;this.ratio>a/b?(c=a,d=c/this.ratio,e=0,f=(b-d)/2):(d=b,c=d*this.ratio,f=0,e=(a-c)/2);var g=this.getPaddingLeft(),h=this.getPaddingRight(),k=this.getPaddingTop(),l=this.getPaddingBottom();
c-=g+h;d-=k+l;for(h=0;h<this.getChildren().length;h++)this.getChildren()[h].arrange(g+e,k+f,c,d)}});Ui.CanvasElement.extend("KJing.RoundItemGraphic",{image:void 0,constructor:function(){this.image=new Ui.Image;this.appendChild(this.image);this.connect(this.image,"ready",this.invalidateDraw)},setImageSrc:function(a){this.image.setSrc(a)}},{canvasEngine:"canvas",updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight(),d=Math.min(b,c),e=d/2;if(this.image.getIsReady()){var f=this.image.getNaturalWidth(),g=this.image.getNaturalHeight(),h=Math.min(f,g),f=(f-h)/2,g=(g-h)/2,k=(b-d)/
2,l=(c-d)/2;a.save();a.beginPath();a.arc(b/2,c/2,e-0.5,0,2*Math.PI,!0);a.closePath();a.clip();a.drawImage(this.image.getDrawing(),f,g,h,h,k,l,d,d);a.restore();a.beginPath();a.arc(b/2,c/2,e-1,0,2*Math.PI,!0);a.closePath();a.strokeStyle="#ffffff";a.lineWidth=2;a.stroke()}}});Ui.LBox.extend("KJing.View",{view:void 0,constructor:function(a){this.view=a.view;delete a.view},getView:function(){return this.view}},{},{create:function(a,b){var c=KJing.Resource.create(b);if(KJing.User.hasInstance(c))return new KJing.ResourceView({view:a,resource:c});if(KJing.Group.hasInstance(c))return new KJing.GroupView({view:a,resource:c});if(KJing.Map.hasInstance(c))return new KJing.MapView({view:a,resource:c});if(KJing.Folder.hasInstance(c))return new KJing.ResourceView({view:a,resource:c});
if(KJing.Device.hasInstance(c))return new KJing.DeviceView({view:a,resource:c});if(KJing.Link.hasInstance(c))return new KJing.LinkView({view:a,resource:c});if(KJing.File.hasInstance(c))return new KJing.FileView({view:a,resource:c})}});Ui.Image.extend("KJing.SquareImage",{squareSize:void 0,setSquareSize:function(a){this.squareSize=a;this.invalidateMeasure()}},{measureCore:function(a,b){if(this.getIsReady()){var c=this.getNaturalWidth()/this.getNaturalHeight();return 1<c?{width:this.squareSize,height:this.squareSize/c}:{width:this.squareSize*c,height:this.squareSize}}return{width:this.squareSize,height:this.squareSize}}});
Ui.DropBox.extend("KJing.ItemViewIcon",{tagsBox:void 0,tags:void 0,isRound:!1,iconName:void 0,iconSrc:void 0,imageSrc:void 0,squareSize:48,icon:void 0,progressbar:void 0,constructor:function(){},setSquareSize:function(a){this.squareSize=a;void 0!==this.tags&&(this.tagsBox.setWidth(this.squareSize),this.tagsBox.setHeight(this.squareSize));void 0!==this.icon&&(KJing.SquareImage.hasInstance(this.icon)?this.icon.setSquareSize(this.squareSize):(this.icon.setWidth(this.squareSize),this.icon.setHeight(this.squareSize)))},
setRoundMode:function(a){this.isRound=a;void 0!==this.imageSrc&&this.setImage(this.imageSrc)},setProgressBar:function(a){void 0!==this.progressbar&&this.remove(this.progressbar);this.progressbar=a;void 0!==this.progressbar&&this.append(this.progressbar)},setIcon:function(a){this.iconName=a;Ui.Icon.hasInstance(this.icon)?this.icon.setIcon(this.iconName):(this.icon=new Ui.Icon({icon:this.iconName,width:this.squareSize,height:this.squareSize}),this.setContent(this.icon),void 0!==this.tagsBox&&this.append(this.tagsBox),
void 0!==this.progressbar&&this.append(this.progressbar))},setIconImage:function(a){this.iconSrc=a;this.icon=new KJing.SquareImage({src:this.iconSrc,squareSize:this.squareSize});this.setContent(this.icon);void 0!==this.tagsBox&&this.append(this.tagsBox);void 0!==this.progressbar&&this.append(this.progressbar)},setImage:function(a){this.imageSrc=a;this.isRound?this.icon=new KJing.RoundItemGraphic({imageSrc:this.imageSrc,width:this.squareSize,height:this.squareSize}):(this.icon=new KJing.SquareImage({src:this.imageSrc,
squareSize:this.squareSize}),this.connect(this.icon,"error",this.onImageError));this.setContent(this.icon);void 0!==this.tagsBox&&this.append(this.tagsBox);void 0!==this.progressbar&&this.append(this.progressbar)},setTags:function(a){this.tags=a;if(void 0!==this.tags){void 0===this.tagsBox&&(this.tagsBox=new Ui.LBox({width:this.squareSize,height:this.squareSize,verticalAlign:"bottom",horizontalAlign:"center"}),this.append(this.tagsBox));var b=new Ui.Flow({itemAlign:"right",verticalAlign:"bottom"});
this.tagsBox.setContent(b);for(var c=0;c<a.length;c++)b.append(new Ui.Icon({icon:a[c],width:24,height:24,fill:"#00c3ff"}))}else void 0!==this.tagsBox&&(this.remove(this.tagsBox),this.tagsBox=void 0)},onImageError:function(a){this.disconnect(a,"error",this.onImageError);void 0!==this.iconSrc?this.setIconImage(this.iconSrc):void 0!==this.iconName&&this.setIcon(this.iconName)}});
Ui.Button.extend("KJing.ItemView",{view:void 0,content:void 0,name:void 0,iconSrc:void 0,iconName:void 0,imageSrc:void 0,share:!1,tags:void 0,tagsBox:void 0,isRound:!1,itemIcon:void 0,selectedIcon:void 0,constructor:function(a){this.view=a.view;delete a.view;this.setDraggableData(this);this.itemIcon=new KJing.ItemViewIcon({verticalAlign:"bottom",horizontalAlign:"center"});this.setIcon(this.itemIcon);this.connect(this,"press",function(){this.getIsSelected()?this.unselect():this.select()})},getItemIcon:function(){return this.itemIcon},
getView:function(){return this.view},addType:function(a,b){this.itemIcon.addType(a,b)},setProgressBar:function(a){this.itemIcon.setProgressBar(a)},setItemTags:function(a){this.itemIcon.setTags(a)},setItemIcon:function(a){this.itemIcon.setIcon(a)},setItemIconSrc:function(a){this.itemIcon.setIconImage(a)},setItemImage:function(a){this.itemIcon.setImage(a)},getItemName:function(){return this.name},setItemName:function(a){this.name=a;this.setText(a)},setItemLabel:function(a){this.setText(a)},onImageError:function(a){this.disconnect(a,
"error",this.onImageError);void 0!==this.iconSrc?this.setItemIconSrc(this.iconSrc):void 0!==this.iconName&&this.setItemIcon(this.iconName)}},{onSelect:function(){this.selectedIcon=new Ui.Icon({icon:"check",verticalAlign:"top",horizontalAlign:"right",marginTop:5,marginRight:5,width:32,height:32,fill:this.getStyleProperty("selectCheckColor")});this.getDropBox().append(this.selectedIcon)},onUnselect:function(){this.getDropBox().remove(this.selectedIcon);this.selectedIcon=void 0},onStyleChange:function(){KJing.ItemView.base.onStyleChange.apply(this,
arguments);this.itemIcon.setSquareSize(this.getStyleProperty("iconSize"));this.itemIcon.setRoundMode(this.getStyleProperty("roundMode"));void 0!==this.selectedIcon&&this.selectedIcon.setFill(this.getStyleProperty("selectCheckColor"))}},{style:{selectCheckColor:"red",roundMode:!1}});KJing.ItemView.extend("KJing.ResourceItemView",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.connect(this.resource,"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange()},setShare:function(a){!0===a?this.setItemTags(["share"]):this.setItemTags(void 0)},getResource:function(){return this.resource},open:function(){this.getView().push(this.getResource().getName(),this.getResource().getId())},onItemProperties:function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open()},
suppress:function(a){this.resource.suppress()},onResourceChange:function(){var a=this.resource.getName();void 0===a||null===a?this.setItemName(""):this.setItemName(a)},onResourceDelete:function(){this.getView().getContentView().getResource().update()}},{onLoad:function(){KJing.ResourceItemView.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.connect(this.resource,"delete",this.onResourceDelete)},onUnload:function(){KJing.ResourceItemView.base.onUnload.apply(this,
arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.disconnect(this.resource,"delete",this.onResourceDelete)},getSelectionActions:function(){return{suppress:{text:"Supprimer",icon:"trash",scope:this,callback:this.suppress,multiple:!1},edit:{text:"Propri\u00e9t\u00e9s",icon:"edit",scope:this,callback:this.onItemProperties,multiple:!1},open:{"default":!0,text:"Ouvrir",icon:"eye",scope:this,callback:this.open,multiple:!1}}}});KJing.ResourceItemView.extend("KJing.GroupItemView",{constructor:function(a){this.setItemIcon("group");a=this.onIconEffect.bind(this);this.getItemIcon().addType(KJing.GroupUserItemView,a);this.getItemIcon().addType(KJing.GroupItemView,a);this.getItemIcon().addType(KJing.UserItemView,a);this.connect(this.getItemIcon(),"drop",this.onIconDrop);this.connect(this.getItemIcon(),"dragenter",this.onIconDragEnter);this.connect(this.getItemIcon(),"dragleave",this.onIconDragLeave)},onIconEffect:function(a){if(a.getResource().getId()===
this.getResource().getId())return"none";for(var b=this.getResource().getUsers(),c=0;c<b.length;c++)if(b[c]===a.getResource().getId())return"none";return"link"},onIconDrop:function(a,b,c,d,e){this.getResource().addUser(b.getResource())},onIconDragEnter:function(){this.setItemIcon("groupopen")},onIconDragLeave:function(){this.setItemIcon("group")}});KJing.ResourceItemView.extend("KJing.GroupUserItemView",{group:void 0,constructor:function(a){KJing.User.hasInstance(this.getResource())?this.setItemImage(this.getResource().getFaceUrl()):this.setItemIcon("person");this.group=a.group;delete a.group}},{onResourceChange:function(){KJing.GroupUserItemView.base.onResourceChange.call(this);KJing.User.hasInstance(this.getResource())?this.setItemImage(this.getResource().getFaceUrl()):this.setItemIcon("person")},suppress:function(){this.group.removeUser(this.getResource())}});KJing.ResourceItemView.extend("KJing.FolderItemView",{constructor:function(a){this.setItemIcon("folder");a=this.onIconEffect.bind(this);this.getItemIcon().addType(KJing.FolderItemView,a);this.getItemIcon().addType(KJing.FileItemView,a);this.getItemIcon().addType(KJing.GroupItemView,a);this.getItemIcon().addType(KJing.UserItemView,a);this.getItemIcon().addType(KJing.MapItemView,a);this.getItemIcon().addType("files","copy");this.connect(this.getItemIcon(),"dropfile",this.onIconDropFile);this.connect(this.getItemIcon(),
"drop",this.onIconDrop);this.connect(this.getItemIcon(),"dragenter",this.onIconDragEnter);this.connect(this.getItemIcon(),"dragleave",this.onIconDragLeave)},onIconEffect:function(a){return a.getResource().getParentId()===this.resource.getId()?"none":a.getResource().getOwnerId()===this.resource.getOwnerId()?a.getResource().getId()===this.resource.getId()||a.getResource().getIsParentOf(this.resource)?"none":"move":"link"},onIconDropFile:function(a,b,c,d,e){a=new Core.FilePostUploader({file:b,service:"/cloud/file"});
b=Ui.App.current.addUploader(a);a.setField("define",JSON.stringify({type:"file",parent:this.getResource().getId(),position:0,uploader:b}));a.send()},onIconDrop:function(a,b,c,d,e){"move"===c?b.getResource().setParent(this.getResource()):"link"===c&&(new Core.HttpRequest({method:"POST",url:"/cloud/link",content:JSON.stringify({type:"link",parent:this.getResource().getId(),link:b.getResource().getId()})})).send()},onIconDragEnter:function(){this.setItemIcon("folderopen")},onIconDragLeave:function(){this.setItemIcon("folder")}});KJing.ResourceItemView.extend("KJing.MapItemView",{constructor:function(a){this.setItemIcon("map");this.getItemIcon().addType(KJing.FileItemView,"link");this.getItemIcon().addType(KJing.FolderItemView,"link");this.connect(this.getItemIcon(),"drop",this.onIconDrop);this.connect(this.getItemIcon(),"dragenter",this.onIconDragEnter);this.connect(this.getItemIcon(),"dragleave",this.onIconDragLeave)},onIconDrop:function(a,b,c,d,e){console.log(this+".onIconDrop data: "+b);if(KJing.FileItemView.hasInstance(b)||
KJing.FolderItemView.hasInstance(b)){a=this.getResource().getDevices();for(c=0;c<a.length;c++)a[c].device.setPath(b.getResource().getId())}},onIconDragEnter:function(){this.setItemIcon("mapopen")},onIconDragLeave:function(){this.setItemIcon("map")}});KJing.ResourceItemView.extend("KJing.UserItemView",{constructor:function(a){this.setItemIcon("person")}});KJing.ResourceItemView.extend("KJing.LinkItemView",{linkedResource:void 0,constructor:function(a){this.setItemIcon("draglink");this.linkedResource=this.getResource().getLinkedResource();this.setItemTags(["link"]);if(this.linkedResource.getIsReady())this.onLinkedResourceReady();else this.connect(this.linkedResource,"ready",this.onLinkedResourceReady)},onLinkedResourceReady:function(){this.setItemName(this.linkedResource.getName());KJing.User.hasInstance(this.linkedResource)?this.setItemIcon("person"):
KJing.Group.hasInstance(this.linkedResource)?this.setItemIcon("group"):KJing.Map.hasInstance(this.linkedResource)?this.setItemIcon("map"):KJing.Device.hasInstance(this.linkedResource)?this.setItemIcon("eye"):KJing.Folder.hasInstance(this.linkedResource)?this.setItemIcon("folder"):KJing.File.hasInstance(this.linkedResource)&&this.setItemIcon("file")}},{setShare:function(a){!0===a?this.setItemTags(["share","link"]):this.setItemTags(["link"])}});Ui.VBox.extend("KJing.Field",{title:void 0,fieldBox:void 0,constructor:function(a){this.addEvents("change");var b=new Ui.Text({text:a.title});delete a.title;this.append(b);this.fieldBox=new Ui.LBox({marginLeft:10});this.append(this.fieldBox);a.desc&&(this.append(new Ui.Text({text:a.desc,color:"#aaaaaa"})),delete a.desc)},getTitle:function(){return this.title.getText()},setTitle:function(a){this.title.setText(a)},getField:function(){return this.fieldBox.getFirstChild()},setField:function(a){this.fieldBox.setContent(a)},
getValue:function(){if(void 0!==this.getField()&&void 0!==this.getField().getValue)return this.getField().getValue()},setValue:function(a){void 0!==this.getField()&&void 0!==this.getField().setValue&&this.getField().setValue(a)}});KJing.Field.extend("KJing.TextField",{constructor:function(a){a=new Ui.TextField;this.connect(a,"change",this.onFieldChange);this.setField(a)},getTextHolder:function(){return this.getField().getTextHolder()},setTextHolder:function(a){this.getField().setTextHolder(a)},setPasswordMode:function(a){this.getField().setPasswordMode(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});KJing.Field.extend("KJing.TextAreaField",{constructor:function(a){a=new Ui.TextAreaField;this.connect(a,"change",this.onFieldChange);this.setField(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});Ui.VBox.extend("KJing.ComboField",{title:void 0,field:void 0,constructor:function(a){this.addEvents("change");var b=new Ui.Text({text:a.title});delete a.title;this.append(b);this.field=new Ui.Combo({marginLeft:5});this.connect(this.field,"change",this.onFieldChange);this.append(this.field);a.desc&&(this.append(new Ui.Text({text:a.desc,color:"#aaaaaa"})),delete a.desc)},setField:function(a){this.field.setField(a)},getData:function(){return this.field.getData()},setData:function(a){this.field.setData(a)},
setCurrentAt:function(a){this.field.setCurrentAt(a)},getTitle:function(){return this.title.getText()},setTitle:function(a){this.title.setText(a)},getValue:function(){return this.field.getValue()},setValue:function(a){this.field.setValue(a)},setPasswordMode:function(a){this.field.setPasswordMode(a)},onFieldChange:function(a,b){this.fireEvent("change",this,b)}});Ui.Button.extend("KJing.OptionOpenButton",{constructor:function(){this.setIcon("optionarrow")}});
Ui.Fold.extend("KJing.OptionSection",{title:void 0,arrow:void 0,optionContent:void 0,constructor:function(){this.setOver(!1);this.setIsFolded(!1);this.optionOpenButton=new KJing.OptionOpenButton;this.connect(this.optionOpenButton,"press",this.invert);this.setHeader(this.optionOpenButton);this.optionContent=new Ui.LBox({paddingLeft:30});KJing.OptionSection.base.setContent.call(this,this.optionContent)},setTitle:function(a){this.optionOpenButton.setText(a)}},{setContent:function(a){this.optionContent.setContent(a)},
setOffset:function(a){KJing.OptionSection.base.setOffset.call(this,a);void 0!==this.arrow&&this.arrow.setTransform(Ui.Matrix.createRotate(90*a))}});Ui.Button.extend("KJing.NewItem",{constructor:function(a){this.setIcon("plus")}});KJing.NewItem.extend("KJing.ResourceNewItem",{view:void 0,resource:void 0,types:void 0,constructor:function(a){this.view=a.view;delete a.view;this.resource=a.resource;delete a.resource;"types"in a&&(this.types=a.types,delete a.types);this.connect(this,"press",this.onNewPress)},onNewPress:function(){(new KJing.NewResourceDialog({resource:this.resource,types:this.types})).open()}});Ui.SFlow.extend("KJing.NewDirectoryCreator",{resource:void 0,valid:!1,nameField:void 0,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.nameField=new KJing.TextAreaField({title:"Nom"});this.append(this.nameField);this.connect(this.nameField,"change",this.checkValid)},checkValid:function(){var a=""!==this.nameField.getValue();this.valid!==a&&((this.valid=a)?this.fireEvent("valid",this):this.fireEvent("notvalid",
this))},create:function(){this.valid=!1;this.fireEvent("notvalid",this);var a=new Core.HttpRequest({method:"POST",url:this.resource.getChildrenUploadUrl(),content:JSON.stringify({name:this.nameField.getValue(),mimetype:"application/x-directory"})});this.connect(a,"done",function(){this.fireEvent("done",this);this.resource.update()});this.connect(a,"error",function(){this.fireEvent("done",this)});a.send()}});
Ui.SFlow.extend("KJing.NewFileCreator",{resource:void 0,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;var b=a.file;delete a.file;a=new Core.FilePostUploader({file:b,service:"/cloud/file"});b=Ui.App.current.addUploader(a);a.setField("define",JSON.stringify({type:"file",parent:this.resource.getId(),uploader:b}));this.connect(a,"progress",this.onUploadProgress);this.connect(a,"complete",this.onUploadComplete);a.send()},create:function(){},
onUploadProgress:function(a){},onUploadComplete:function(a){this.fireEvent("done",this);this.resource.update()}});
Ui.SFlow.extend("KJing.NewFileSelector",{constructor:function(a){this.addEvents("done");this.setItemAlign("stretch");this.setStretchMaxRatio(5);this.setSpacing(5);this.setUniform(!0);a=[{type:"folder",icon:"folder",text:"Dossier",creator:KJing.NewDirectoryCreator},{type:"file",uploader:!0,icon:"new",text:"Fichier",creator:KJing.NewFileCreator}];for(var b=0;b<a.length;b++){var c=a[b],d;c.uploader?(d=new Ui.UploadButton({text:c.text,icon:c.icon,orientation:"horizontal",width:200}),this.connect(d,"file",
this.onButtonFile)):(d=new Ui.Button({text:c.text,icon:c.icon,orientation:"horizontal",width:200}),this.connect(d,"press",this.onButtonPress));d.kjingNewFileSelectorType=c;this.append(d)}},onButtonFile:function(a,b){this.fireEvent("done",this,a.kjingNewFileSelectorType,b)},onButtonPress:function(a){this.fireEvent("done",this,a.kjingNewFileSelectorType)}});
Ui.Dialog.extend("KJing.NewFileDialog",{resource:void 0,transBox:void 0,selector:void 0,creator:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.setTitle("Nouveau fichier");this.setFullScrolling(!0);this.setPreferredWidth(400);this.setPreferredHeight(400);this.transBox=new Ui.TransitionBox;this.setContent(this.transBox);this.selector=new KJing.NewFileSelector;this.connect(this.selector,"done",this.onSelectorDone);this.transBox.replaceContent(this.selector);this.setCancelButton(new Ui.DialogCloseButton({text:"Annuler"}));
this.prevButton=new Ui.Button({text:"Pr\u00e9c\u00e9dent"});this.connect(this.prevButton,"press",this.onPrevPress);this.createButton=new Ui.Button({text:"Cr\u00e9er"});this.connect(this.createButton,"press",this.onCreatePress)},onSelectorDone:function(a,b,c){this.setTitle(b.text);this.setActionButtons([this.prevButton,this.createButton]);this.creator=void 0!==c?new b.creator({resource:this.resource,file:c}):new b.creator({resource:this.resource});this.transBox.replaceContent(this.creator);this.connect(this.creator,
"done",this.onCreatorDone);this.connect(this.creator,"valid",this.onCreatorValid);this.connect(this.creator,"notvalid",this.onCreatorNotvalid);this.onCreatorNotvalid(this.creator)},onPrevPress:function(){this.setTitle("Nouveau fichier");this.setActionButtons([]);this.transBox.replaceContent(this.selector);void 0!==this.creator&&(this.disconnect(this.creator,"done",this.onCreatorDone),this.disconnect(this.creator,"valid",this.onCreatorValid),this.disconnect(this.creator,"notvalid",this.onCreatorNovalid),
this.creator=void 0)},onCreatePress:function(){this.creator.create()},onCreatorDone:function(){this.close()},onCreatorValid:function(){this.createButton.enable()},onCreatorNotvalid:function(){this.createButton.disable()}});Ui.Dialog.extend("Storage.FilePropertiesDialog",{resource:void 0,deleteButton:void 0,modifyButton:void 0,nameField:void 0,mimetypeField:void 0,filesizeField:void 0,ctimeField:void 0,mtimeField:void 0,positionField:void 0,durationField:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.setPreferredWidth(500);this.setPreferredHeight(500);this.setFullScrolling(!0);this.setTitle("Propri\u00e9t\u00e9s du fichier");this.setCancelButton(new Ui.DialogCloseButton);if(this.resource.getIsReady())this.onResourceReady();
else this.connect(this.resource,"ready",this.onResourceReady)},onResourceReady:function(){var a=new Ui.VBox;this.setContent(a);var b=new Ui.VBox({spacing:10});a.append(b);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Id",width:100,textAlign:"right",verticalAlign:"center"}));a.append(new Ui.TextField({verticalAlign:"center",enable:!1,value:this.resource.getId()}),!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Nom",width:100,textAlign:"right",verticalAlign:"center"}));
this.nameField=new Ui.TextAreaField({verticalAlign:"center"});a.append(this.nameField,!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Type",width:100,textAlign:"right",verticalAlign:"center"}));this.mimetypeField=new Ui.Text({verticalAlign:"center"});a.append(this.mimetypeField,!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Taille",width:100,textAlign:"right",verticalAlign:"center"}));this.filesizeField=new Ui.Text({verticalAlign:"center"});a.append(this.filesizeField,
!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Cr\u00e9ation",width:100,textAlign:"right",verticalAlign:"center"}));this.ctimeField=new Ui.Text({verticalAlign:"center"});a.append(this.ctimeField,!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Modification",width:100,textAlign:"right",verticalAlign:"center"}));this.mtimeField=new Ui.Text({verticalAlign:"center"});a.append(this.mtimeField,!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Position",
width:100,textAlign:"right",verticalAlign:"center"}));this.positionField=new Ui.TextField({verticalAlign:"center"});a.append(this.positionField,!0);a=new Ui.HBox({spacing:10});b.append(a);a.append(new Ui.Text({text:"Dur\u00e9e d'affichage",width:100,textAlign:"right",verticalAlign:"center"}));this.durationField=new Ui.TextField({verticalAlign:"center"});a.append(this.durationField,!0);"application/x-directory"!==this.resource.getMimetype()&&(a=new Storage.FileViewer({file:this.resource,height:300}),
b.append(a));Ui.App.current.getUser();Ui.App.current.getUser().isAdmin()||this.resource.canWrite()?(this.deleteButton=new Ui.Button({text:"Supprimer",style:{"Ui.Button":{color:"#fa4141"}}}),this.connect(this.deleteButton,"press",this.onDeletePress),this.saveButton=new Ui.Button({text:"Enregistrer"}),this.connect(this.saveButton,"press",this.onSavePress),this.setActionButtons([this.deleteButton,this.saveButton])):this.nameField.disable()},formatSize:function(a){return 1E9<a?(a/1E9).toFixed(2)+" Go":
1E6<a?(a/1E6).toFixed(2)+" Mo":1E3<a?(a/1E3).toFixed(2)+" ko":a+" octets"},formatDate:function(a){var b="",b=10>a.getDate()?b+("0"+a.getDate()):b+a.getDate(),b=b+"/",b=10>a.getMonth()+1?b+("0"+(a.getMonth()+1)):b+(a.getMonth()+1),b=b+("/"+a.getFullYear()+" "),b=10>a.getHours()?b+("0"+a.getHours()):b+a.getHours(),b=b+":",b=10>a.getMinutes()?b+("0"+a.getMinutes()):b+a.getMinutes(),b=b+":";return b=10>a.getSeconds()?b+("0"+a.getSeconds()):b+a.getSeconds()},onSavePress:function(){var a={name:this.nameField.getValue(),
position:this.positionField.getValue(),meta:{duration:this.durationField.getValue()}};this.resource.changeData(a);this.close()},onDeletePress:function(){this.resource.suppress();this.close()},onResourceChange:function(){this.nameField.setValue(this.resource.getName());this.mimetypeField.setText(this.resource.getMimetype());this.filesizeField.setText(this.formatSize(this.resource.getData().size));this.ctimeField.setText(this.formatDate(new Date(this.resource.getData().ctime)));this.mtimeField.setText(this.formatDate(new Date(this.resource.getData().mtime)));
this.positionField.setValue(this.resource.getData().position);this.durationField.setValue(void 0)}},{onLoad:function(){Storage.FilePropertiesDialog.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);if(this.resource.getIsReady())this.onResourceChange()},onUnload:function(){Storage.FilePropertiesDialog.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange)}});KJing.ResourceItemView.extend("KJing.FileItemView",{uploader:void 0,preview:void 0,progressbar:void 0,constructor:function(a){this.setItemIcon("file");this.setItemName("");if(this.resource.getIsReady())this.onFileReady();else this.connect(this.resource,"ready",this.onFileReady);this.connect(this.resource,"change",function(){this.onFileReady()})},getUploader:function(){return this.uploader},deleteFile:function(){void 0!==this.uploader&&(this.uploader.abort(),this.uploader=void 0);void 0!==this.resource&&
this.resource.suppress()},onDelete:function(a){a.getElements()[0].getResource().suppress()},onEdit:function(a){a=a.getElements()[0];(new KJing.ResourcePropertiesDialog({resource:a.getResource()})).open()},onOpen:function(a){a=a.getElements()[0];a.view.push(a.getResource().getName(),a.getResource().getId())},onDownload:function(a){a=a.getElements();for(var b=0;b<a.length;b++)window.open(a[b].getResource().getDownloadUrl(!0),"_blank")},onFileReady:function(){console.log(this+".onFileReady "+this.resource.getData().uploader);
if(void 0!==this.resource.getData().uploader){this.setItemIcon("uploadfile");var a=Ui.App.current.getUploaderById(this.resource.getData().uploader);this.uploader!==a&&(void 0!==this.uploader&&(this.disconnect(this.uploader,"progress",this.onUploaderProgress),this.disconnect(this.uploader,"complete",this.onUploaderErrorOrComplete),this.disconnect(this.uploader,"error",this.onUploaderErrorOrComplete)),this.uploader=a,void 0!==this.uploader?(this.progressbar=new Ui.ProgressBar({verticalAlign:"bottom",
margin:4}),this.connect(this.uploader,"progress",this.onUploaderProgress),this.connect(this.uploader,"complete",this.onUploaderErrorOrComplete),this.connect(this.uploader,"error",this.onUploaderErrorOrComplete)):this.progressbar=void 0,this.setProgressBar(this.progressbar),console.log(this+".onFileReady FOUND MATCHING UPLOADER"))}else"application/x-directory"===this.resource.getMimetype()?this.setItemIcon("folder"):(0===this.resource.getMimetype().indexOf("audio/")&&this.setItemIcon("sound"),void 0!==
this.resource.getPreviewUrl()&&this.setItemImage(this.resource.getPreviewUrl()));this.setItemName(this.resource.getName())},onUploaderProgress:function(a,b,c){this.progressbar.setValue(b/c)},onUploaderErrorOrComplete:function(a){this.setProgressBar(void 0);this.disconnect(this.uploader,"progress",this.onUploaderProgress);this.disconnect(this.uploader,"complete",this.onUploaderErrorOrComplete);this.disconnect(this.uploader,"error",this.onUploaderErrorOrComplete);this.progressbar=this.uploader=void 0}},
{getSelectionActions:function(){return void 0!==this.uploader?{suppress:{text:"Supprimer",icon:"trash",color:"#d02020",callback:this.onDelete,multiple:!1}}:{download:{text:"T\u00e9l\u00e9charger",icon:"savedisk",callback:this.onDownload,multiple:!1},suppress:{text:"Supprimer",icon:"trash",color:"#d02020",callback:this.onDelete,multiple:!1},open:{"default":!0,text:"Ouvrir",icon:"eye",callback:this.onOpen,multiple:!1},edit:{"default":!0,text:"Propri\u00e9t\u00e9s",icon:"pen",callback:this.onEdit,multiple:!1}}}});KJing.ItemView.extend("KJing.WebAccount",{label:void 0,accountIcon:void 0,user:void 0,constructor:function(a){this.addEvents("delete");this.user=a.user;delete a.user;this.setItemIcon("google")},getUser:function(){return this.user},setAccountIcon:function(a){this.setItemIcon(a)},"delete":function(){this.fireEvent("delete",this)},testDeleteRight:function(){var a=this.user.getData(),b=0;null!==a.login&&b++;null!==a.googleid&&b++;null!==a.facebookid&&b++;return 1<b}});
Ui.Dialog.extend("KJing.WebAccountNewDialog",{user:void 0,path:void 0,constructor:function(a){this.addEvents("done");this.user=a.user;delete a.user;this.setTitle("Nouveau compte Web");this.setPreferredWidth(400);this.setPreferredHeight(400);this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.VBox({spacing:5});this.setContent(a);var b=this.user.getData();if(null===b.login){var c=new Ui.Button({icon:"localaccount",text:"HOST",orientation:"horizontal"});this.connect(c,"press",this.onLocalPress);
a.append(c)}null===b.googleid&&(c=new Ui.Button({icon:"google",text:"Google",orientation:"horizontal"}),this.connect(c,"press",this.onGooglePress),a.append(c));null===b.facebookid&&(c=new Ui.Button({icon:"facebook",text:"Facebook",orientation:"horizontal"}),this.connect(c,"press",this.onFacebookPress),a.append(c))},onLocalPress:function(){var a=new Ui.VBox({spacing:10});this.setContent(a);var b=new Ui.TextField,c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Identifiant",textAlign:"right",
verticalAlign:"center",width:100}));c.append(b,!0);a.append(c);passwordField=new Ui.TextField({passwordMode:!0});c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Mot de passe",textAlign:"right",verticalAlign:"center",width:100}));c.append(passwordField,!0);a.append(c);var d=new Ui.Text({color:"red"});d.hide();a.append(d);var e=void 0,f=new Ui.Button({text:"Cr\u00e9er"});this.connect(f,"press",function(){var a=new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.user.getId(),content:JSON.stringify({type:"user",
login:b.getValue(),password:passwordField.getValue()})});this.connect(a,"done",function(){this.close();this.user.getData().login=b.getValue();this.fireEvent("done",this,new KJing.LocalAccount({user:this.user}))});this.connect(a,"error",function(a){var b=a.getStatus(),c="Echec de la cr\u00e9ation. V\u00e9rifier vos donn\u00e9es";403==b?1==a.getResponseJSON().code&&(c="Echec: mot de passe trop faible"):409==b&&(c="Echec: identifiant d\u00e9j\u00e0 utilis\u00e9");void 0!==e&&e.abort();d.setText(c);d.show();
e=new Core.DelayedTask({scope:this,delay:4,callback:function(){d.hide()}});this.getContent().enable();f.enable()});this.getContent().disable();f.disable();a.send()});this.setActionButtons([f])},onGooglePress:function(){this.setContent(new Ui.Text({verticalAlign:"center",textAlign:"center",text:"En attente d'authorization..."}));var a=window.open("/cloud/googleoauth2/redirect?state=grant","googleoauth");this.connect(a,"unload",function(){this.close()})},onFacebookPress:function(){this.setContent(new Ui.Text({verticalAlign:"center",
textAlign:"center",text:"En attente d'authorization..."}));var a=window.open("/cloud/facebookoauth2/redirect?state=grant","facebookoauth");this.connect(a,"unload",function(){this.close()})}});
Ui.Dialog.extend("KJing.GoogleAccountDialog",{user:void 0,account:void 0,constructor:function(a){this.user=a.user;delete a.user;this.account=a.account;delete a.account;this.setPreferredWidth(400);this.setTitle("Compte Google");this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.Button({text:"Supprimer"});this.connect(a,"press",this.onDeletePress);var b=new Ui.VBox({spacing:10});this.setContent(b);var c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Identifiant",textAlign:"right",verticalAlign:"center",
width:100}));c.append(new Ui.Text({text:this.user.getData().googleid}),!0);b.append(c);this.account.testDeleteRight()&&this.setActionButtons([a])},onDeletePress:function(){this.account["delete"]();this.close()}});
KJing.WebAccount.extend("KJing.GoogleAccount",{constructor:function(a){this.setAccountIcon("google");this.setText("Google")},onGoogleEdit:function(){(new KJing.GoogleAccountDialog({user:this.getUser(),account:this})).open()},onGoogleDelete:function(){this["delete"]()}},{"delete":function(){(new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.getUser().getId(),content:JSON.stringify({googleid:null})})).send();this.fireEvent("delete",this)},getSelectionActions:function(){return{"delete":{text:"Supprimer",
icon:"trash",color:"#d02020",testRight:this.testDeleteRight,scope:this,callback:this.onGoogleDelete,multiple:!1},edit:{"default":!0,text:"Modifier",icon:"pen",scope:this,callback:this.onGoogleEdit,multiple:!1}}}});
Ui.Dialog.extend("KJing.FacebookAccountDialog",{user:void 0,account:void 0,constructor:function(a){this.user=a.user;delete a.user;this.account=a.account;delete a.account;this.setPreferredWidth(400);this.setTitle("Compte Facebook");this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.Button({text:"Supprimer"});this.connect(a,"press",this.onDeletePress);var b=new Ui.VBox({spacing:10});this.setContent(b);var c=new Ui.HBox({spacing:10});c.append(new Ui.Text({text:"Identifiant",textAlign:"right",verticalAlign:"center",
width:100}));c.append(new Ui.Text({text:this.user.getData().facebookid}),!0);b.append(c);this.account.testDeleteRight()&&this.setActionButtons([a])},onDeletePress:function(){this.account["delete"]();this.close()}});
KJing.WebAccount.extend("KJing.FacebookAccount",{constructor:function(a){this.setAccountIcon("facebook");this.setText("Facebook")},onFacebookEdit:function(){(new KJing.FacebookAccountDialog({user:this.getUser(),account:this})).open()},onFacebookDelete:function(){this["delete"]()}},{"delete":function(){(new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.getUser().getId(),content:JSON.stringify({facebookid:null})})).send();this.fireEvent("delete",this)},getSelectionActions:function(){return{"delete":{text:"Supprimer",
icon:"trash",color:"#d02020",testRight:this.testDeleteRight,scope:this,callback:this.onFacebookDelete,multiple:!1},edit:{"default":!0,text:"Modifier",icon:"pen",scope:this,callback:this.onFacebookEdit,multiple:!1}}}});
Ui.Dialog.extend("KJing.LocalAccountDialog",{user:void 0,account:void 0,loginField:void 0,passwordField:void 0,deleteButton:void 0,saveButton:void 0,errorMessage:void 0,errorTimeout:void 0,constructor:function(a){this.user=a.user;delete a.user;this.account=a.account;delete a.account;this.setPreferredWidth(400);this.setTitle("Compte local");this.setCancelButton(new Ui.DialogCloseButton);this.deleteButton=new Ui.Button({text:"Supprimer"});this.connect(this.deleteButton,"press",this.onDeletePress);this.saveButton=
new Ui.Button({text:"Enregistrer"});this.connect(this.saveButton,"press",this.onSavePress);a=new Ui.VBox({spacing:10});this.setContent(a);this.loginField=new Ui.TextField({value:this.user.getData().login});var b=new Ui.HBox({spacing:10});b.append(new Ui.Text({text:"Identifiant",textAlign:"right",verticalAlign:"center",width:100}));b.append(this.loginField,!0);a.append(b);this.passwordField=new Ui.TextField({textHolder:"********",passwordMode:!0});b=new Ui.HBox({spacing:10});b.append(new Ui.Text({text:"Mot de passe",
textAlign:"right",verticalAlign:"center",width:100}));b.append(this.passwordField,!0);a.append(b);this.errorMessage=new Ui.Text({color:"red"});this.errorMessage.hide();a.append(this.errorMessage);this.account.testDeleteRight()?this.setActionButtons([this.deleteButton,this.saveButton]):this.setActionButtons([this.saveButton])},onDeletePress:function(){this.account["delete"]();this.close()},onSavePress:function(){var a={};void 0!=this.passwordField.getValue()&&""!=this.passwordField.getValue()&&(a.password=
this.passwordField.getValue());a.login=this.loginField.getValue();a=new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.user.getId(),content:JSON.stringify(a)});this.connect(a,"done",this.onSaveDone);this.connect(a,"error",this.onSaveError);this.getContent().disable();this.saveButton.disable();this.deleteButton.disable();a.send()},onSaveDone:function(){this.close()},onSaveError:function(a){var b="Echec de la modification. V\u00e9rifier vos donn\u00e9es";403==a.getStatus()&&1==a.getResponseJSON().code&&
(b="Echec: mot de passe trop faible");this.showError(b);this.getContent().enable();this.saveButton.enable();this.deleteButton.enable()},showError:function(a){void 0!=this.errorTimeout&&this.errorTimeout.abort();this.errorMessage.setText(a);this.errorMessage.show();this.errorTimeout=new Core.DelayedTask({scope:this,delay:4,callback:this.onShowErrorTimeout})},onShowErrorTimeout:function(){void 0!==this.errorTimeout&&(this.errorTimeout.abort(),this.errorTimeout=void 0,this.errorMessage.hide());this.errorTimeout=
void 0;this.errorMessage.hide()}});
KJing.WebAccount.extend("KJing.LocalAccount",{constructor:function(a){this.setAccountIcon("localaccount");this.setText("Local")},onLocalEdit:function(){(new KJing.LocalAccountDialog({user:this.getUser(),account:this})).open()},onLocalDelete:function(){this["delete"]()}},{"delete":function(){(new Core.HttpRequest({method:"PUT",url:"/cloud/resource/"+this.user.getId(),content:JSON.stringify({login:null,password:null})})).send();this.fireEvent("delete",this)},getSelectionActions:function(){return{"delete":{text:"Supprimer",icon:"trash",
color:"#d02020",testRight:this.testDeleteRight,scope:this,callback:this.onLocalDelete,multiple:!1},edit:{"default":!0,text:"Modifier",icon:"pen",scope:this,callback:this.onLocalEdit,multiple:!1}}}});
KJing.OptionSection.extend("KJing.WebAccountSection",{flow:void 0,user:void 0,plus:void 0,googleAccount:void 0,facebookAccount:void 0,localAccount:void 0,constructor:function(a){this.user=a.user;delete a.user;this.setTitle("Comptes Web");this.selection=[];this.flow=new Ui.Flow({uniform:!0});this.setContent(this.flow);this.plus=new Ui.Pressable;this.plus.setContent(new Ui.Icon({icon:"plus",width:48,height:48,fill:"#444444",verticalAlign:"center",horizontalAlign:"center"}));this.flow.append(this.plus);
this.connect(this.plus,"press",this.onPlusPress)},testPlus:function(){4<=this.flow.getChildren().length?this.plus.hide(!0):this.plus.show()},onPlusPress:function(){(new KJing.WebAccountNewDialog({user:this.user})).open()},onUserChange:function(){null!==this.user.getData().googleid&&void 0===this.googleAccount?(this.googleAccount=new KJing.GoogleAccount({user:this.user}),this.flow.prepend(this.googleAccount)):null===this.user.getData().googleid&&void 0!==this.googleAccount&&(this.flow.remove(this.googleAccount),
this.googleAccount=void 0);null!==this.user.getData().facebookid&&void 0===this.facebookAccount?(this.facebookAccount=new KJing.FacebookAccount({user:this.user}),this.flow.prepend(this.facebookAccount)):null===this.user.getData().facebookid&&void 0!==this.facebookAccount&&(this.flow.remove(this.facebookAccount),this.facebookAccount=void 0);null!==this.user.getData().login&&void 0===this.localAccount?(this.localAccount=new KJing.LocalAccount({user:this.user}),this.flow.prepend(this.localAccount)):
null===this.user.getData().login&&void 0!==this.localAccount&&(this.flow.remove(this.localAccount),this.localAccount=void 0);this.testPlus()}},{onLoad:function(){KJing.WebAccountSection.base.onLoad.call(this);this.connect(this.user,"change",this.onUserChange);this.onUserChange()},onUnload:function(){KJing.WebAccountSection.base.onUnload.call(this);this.disconnect(this.user,"change",this.onUserChange)}});Ui.DropBox.extend("KJing.UploadFaceButton",{user:void 0,graphic:void 0,uploadable:void 0,lbox:void 0,image:void 0,icon:void 0,constructor:function(a){this.user=a.user;delete a.user;this.addType("files","copy");this.uploadable=new Ui.Uploadable;this.setContent(this.uploadable);this.lbox=new Ui.LBox;this.uploadable.setContent(this.lbox);this.graphic=new Ui.ButtonGraphic;this.lbox.append(this.graphic);this.image=new Ui.Image({width:64,height:64,margin:10});this.lbox.append(this.image);this.connect(this.uploadable,
"down",function(){this.graphic.setIsDown(!0)});this.connect(this.uploadable,"up",function(){this.graphic.setIsDown(!1)});this.connect(this.uploadable,"focus",function(){this.graphic.setHasFocus(!0)});this.connect(this.uploadable,"blur",function(){this.graphic.setHasFocus(!1)});this.connect(this,"dropfile",this.onUploadFile);this.connect(this.uploadable,"file",this.onUploadFile)},onUploadFile:function(a,b){var c=new Core.FilePostUploader({file:b,service:"/cloud/user/"+this.user.getId()+"/face"});this.connect(c,
"progress",this.onUploadProgress);this.connect(c,"complete",this.onUploadComplete);c.send();Ui.App.current.addUploader(c)},onUploadProgress:function(a){},onUploadComplete:function(a){this.user.update()},onUserChange:function(){this.image.setSrc(this.user.getFaceUrl())}},{onLoad:function(){KJing.UploadFaceButton.base.onLoad.call(this);this.connect(this.user,"change",this.onUserChange);this.onUserChange()},onUnload:function(){KJing.UploadFaceButton.base.onUnload.call(this);this.disconnect(this.user,
"change",this.onUserChange)}});
Ui.Dialog.extend("KJing.UserProfil",{user:void 0,firstnameField:void 0,lastnameField:void 0,emailField:void 0,avatarBlob:void 0,avatarImage:void 0,adminField:void 0,saveButton:void 0,sflow:void 0,webSection:void 0,constructor:function(a){this.user=a.user;delete a.user;this.setFullScrolling(!0);this.setPreferredWidth(650);this.setPreferredHeight(550);this.setTitle("Profil utilisateur");this.setCancelButton(new Ui.DialogCloseButton);if(this.user.getIsReady())this.onUserReady();else this.connect(this.user,
"ready",this.onUserReady)},onUserReady:function(){var a=[];if(KJing.User.hasInstance(this.user)&&Ui.App.current.getUser().isAdmin()){var b=new Ui.Button({text:"Commuter"});b.setStyle({"Ui.Button":{color:"#b243ff"}});this.connect(b,"press",this.onSwitchPress);var c=new Ui.Button({text:"Supprimer"});c.setStyle({"Ui.Button":{color:"#d04040"}});this.connect(c,"press",this.onDeletePress);Ui.App.current.getUser().getId()!==this.user.getId()&&a.push(b);a.push(c)}KJing.User.hasInstance(this.user)&&(this.saveButton=
new Ui.Button({text:"Enregistrer"}),this.connect(this.saveButton,"press",this.onSavePress),a.push(this.saveButton));this.setActionButtons(a);a=new Ui.VBox;this.setContent(a);this.sflow=new Ui.SFlow({spacing:5,itemAlign:"stretch",stretchMaxRatio:5});a.append(this.sflow);b=new KJing.UploadFaceButton({user:this.user,marginLeft:10});this.sflow.append(b,"right");this.firstnameField=new KJing.TextField({title:"Pr\u00e9nom",width:150});this.sflow.append(this.firstnameField);this.lastnameField=new KJing.TextField({title:"Nom",
width:150});this.sflow.append(this.lastnameField);KJing.User.hasInstance(this.user)&&(this.emailField=new KJing.TextField({title:"Email",width:250}),this.sflow.append(this.emailField));this.descField=new KJing.TextAreaField({title:"Description",width:250});this.sflow.append(this.descField);KJing.User.hasInstance(this.user)&&(Ui.App.current.getUser().isAdmin()&&(this.adminField=new Ui.CheckBox({text:"Compte administrateur"}),this.sflow.append(this.adminField)),this.webSection=new KJing.WebAccountSection({user:this.user}),
a.append(this.webSection));this.firstnameField.setValue(this.user.getData().firstname);this.lastnameField.setValue(this.user.getData().lastname);this.descField.setValue(this.user.getData().description);KJing.User.hasInstance(this.user)?(this.emailField.setValue(this.user.getData().email),Ui.App.current.getUser().isAdmin()&&this.adminField.setValue(this.user.getData().admin)):this.sflow.disable()},onSavePress:function(){var a={};a.firstname=this.firstnameField.getValue();a.lastname=this.lastnameField.getValue();
a.email=this.emailField.getValue();""===a.email&&(a.email=null);a.description=this.descField.getValue();Ui.App.current.getUser().isAdmin()&&(a.admin=this.adminField.getValue());a=Core.Object.diff(this.user.getData(),a);void 0!==a?(a=this.user.changeData(a),this.connect(a,"done",this.close),this.connect(a,"error",this.onSaveError),a.send(),this.sflow.disable(),this.saveButton.disable()):this.close()},onSaveError:function(){this.sflow.enable();this.saveButton.enable();var a=new Ui.Dialog({preferredWidth:300,
title:"Echec de l'enregistrement"});a.setContent(new Ui.Text({text:"L'enregistrement \u00e0 \u00e9chou\u00e9."}));var b=new Ui.Button({text:"Fermer"});a.setActionButtons([b]);this.connect(b,"press",function(){a.close()});a.open()},onDeletePress:function(){var a=new Ui.Dialog({title:"Suppression de compte",fullScrolling:!1,preferredWidth:300});a.setContent(new Ui.Text({text:"Voulez vous vraiment supprimer ce compte ? ATTENTION, cet utilisateur et toutes ses ressources n'existeront plus apr\u00e8s cette action."}));
a.setCancelButton(new Ui.Button({text:"Annuler"}));var b=new Ui.Button({text:"Supprimer"});b.setStyle({"Ui.Button":{color:"#d04040"}});a.setActionButtons([b]);this.connect(b,"press",function(){a.disable();var b=new Core.HttpRequest({method:"DELETE",url:"/cloud/resource/"+this.user.getId()});this.connect(b,"done",function(){a.close();Ui.App.current.setMainPath("");this.close()});this.connect(b,"error",function(){a.close();this.close()});b.send()});a.open()},onSwitchPress:function(){var a=void 0,b=
new Ui.Dialog({title:"Connexion au compte",fullScrolling:!1,preferredWidth:300});b.setContent(new Ui.Text({text:"Voulez vous vraiment ouvrir une session sur le compte de cet utilisateur ? ATTENTION, vous ne serez plus sur votre compte et vous aller agir au nom de cette personne."}));b.setCancelButton(new Ui.Button({text:"Annuler"}));var c=new Ui.Button({text:"Commuter"});c.setStyle({"Ui.Button":{color:"#b243ff"}});c.disable();b.setActionButtons([c]);var d=new Core.HttpRequest({method:"POST",url:"/cloud/authsession",
content:JSON.stringify({user:this.user.getId()})});this.connect(d,"done",function(){a=d.getResponseJSON();c.enable()});d.send();this.connect(c,"press",function(){b.close();window.open("/?authsession="+a.id)});b.open()}});KJing.ItemView.extend("KJing.RightItemView",{resource:void 0,right:void 0,user:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.right=a.right;delete a.right;this.user=KJing.Resource.create(this.right.user);KJing.Group.hasInstance(this.user)?this.setItemIcon("group"):(this.setItemImage(this.user.getFaceUrl()),this.setItemName(this.user.getName()));a=void 0;this.right.write&&this.right.admin?a=["pen","tools"]:this.right.write?a=["pen"]:this.right.admin&&(a=["tools"]);this.setItemTags(a)},
getResource:function(){return this.resource},getUser:function(){return this.user},onUserChange:function(){this.setItemName(this.user.getName());KJing.User.hasInstance(this.user)&&this.setItemImage(this.user.getFaceUrl())}},{onLoad:function(){KJing.RightItemView.base.onLoad.apply(this,arguments);this.connect(this.user,"change",this.onUserChange)},onUnload:function(){KJing.RightItemView.base.onUnload.apply(this,arguments);this.disconnect(this.user,"change",this.onUserChange)},getSelectionActions:function(){return KJing.RightItemView.actions}},
{actions:void 0,constructor:function(a){KJing.RightItemView.actions={suppress:{icon:"trash",text:"Supprimer","default":!0,multiple:!0,callback:KJing.RightItemView.onSuppressAction}}},onSuppressAction:function(a){a=a.getElements();for(var b=[],c=0;c<a.length;c++)b.push({user:a[c].getUser().getId(),read:!1,write:!1,admin:!1});a[0].getResource().addRights(b)}});
KJing.NewItem.extend("KJing.RightNewItem",{resource:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.connect(this,"press",this.onNewPress)},onNewPress:function(){(new KJing.NewResourceDialog({resource:this.resource,types:["rightuser","rightgroup"]})).open()}});
KJing.OptionSection.extend("KJing.ResourceRightsSection",{resource:void 0,flow:void 0,constructor:function(a){this.setTitle("Droits");this.resource=a.resource;delete a.resource;this.flow=new Ui.Flow({spacing:5,uniform:!0});this.setContent(this.flow);if(this.resource.getIsReady())this.onResourceChange()},onResourceChange:function(){this.flow.clear();var a=new KJing.RightNewItem({resource:this.resource});this.flow.append(a);for(var a=this.resource.getRights(),b=0;b<a.length;b++){var c=new KJing.RightItemView({resource:this.resource,
right:a[b]});this.flow.append(c)}this.resource.canAdmin()||this.flow.disable()}},{onLoad:function(){KJing.ResourceRightsSection.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange)},onUnload:function(){KJing.ResourceRightsSection.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange)}});
Ui.Dialog.extend("KJing.ResourcePropertiesDialog",{resource:void 0,nameField:void 0,positionField:void 0,constructor:function(a){this.setFullScrolling(!0);this.setPreferredWidth(500);this.setPreferredHeight(500);this.setTitle("Propri\u00e9t\u00e9s");this.resource=a.resource;delete a.resource;a=new Ui.SFlow({itemAlign:"stretch",spacing:5,stretchMaxRatio:10});this.setContent(a);var b=new KJing.TextField({title:"Identifiant",value:this.resource.getId(),width:200});b.disable();a.append(b);this.nameField=
new KJing.TextField({title:"Nom",value:this.resource.getName(),width:200});a.append(this.nameField);a.append(new KJing.TextField({title:"Cr\u00e9ation",value:this.formatDate(new Date(this.resource.getData().ctime)),width:200,enable:!1}));a.append(new KJing.TextField({title:"Modification",value:this.formatDate(new Date(this.resource.getData().mtime)),width:200,enable:!1}));KJing.Device.hasInstance(this.resource)?(b=new KJing.TextField({title:"URL du client Web",width:300}),b.setValue((new Core.Uri({uri:"../client/?device="+
this.resource.getId()})).toString()),b.disable(),a.append(b)):KJing.Map.hasInstance(this.resource)?(b=new KJing.TextField({title:"URL des clients Web",width:300}),b.setValue((new Core.Uri({uri:"../client/?parent="+this.resource.getId()})).toString()),b.disable(),a.append(b)):KJing.File.hasInstance(this.resource);this.positionField=new KJing.TextField({title:"Position dans le dossier",value:this.resource.getData().position,width:200});a.append(this.positionField);b=new KJing.ResourceRightsSection({resource:this.resource});
a.append(b);this.setCancelButton(new Ui.DialogCloseButton);Ui.App.current.getUser().isAdmin()||this.resource.canWrite()?(a=new Ui.Button({text:"Supprimer",style:{"Ui.Button":{color:"#fa4141"}}}),this.connect(a,"press",this.onDeletePress),b=new Ui.Button({text:"Enregistrer"}),this.connect(b,"press",this.onSavePress),this.setActionButtons([a,b])):a.disable()},formatSize:function(a){return 1E9<a?(a/1E9).toFixed(2)+" Go":1E6<a?(a/1E6).toFixed(2)+" Mo":1E3<a?(a/1E3).toFixed(2)+" ko":a+" octets"},formatDate:function(a){var b=
"",b=10>a.getDate()?b+("0"+a.getDate()):b+a.getDate(),b=b+"/",b=10>a.getMonth()+1?b+("0"+(a.getMonth()+1)):b+(a.getMonth()+1),b=b+("/"+a.getFullYear()+" "),b=10>a.getHours()?b+("0"+a.getHours()):b+a.getHours(),b=b+":",b=10>a.getMinutes()?b+("0"+a.getMinutes()):b+a.getMinutes(),b=b+":";return b=10>a.getSeconds()?b+("0"+a.getSeconds()):b+a.getSeconds()},onDeletePress:function(){this.resource.suppress();this.close()},onSavePress:function(){var a={name:this.nameField.getValue(),position:parseInt(this.positionField.getValue())};
this.resource.changeData(a);this.close()}});KJing.ItemView.extend("KJing.GroupAddUserItemView",{resource:void 0,group:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.group=a.group;delete a.group;this.setItemImage(this.getResource().getFaceUrl());this.setItemName(this.getResource().getName())},getResource:function(){return this.resource},getGroup:function(){return this.group}},{getSelectionActions:function(){return KJing.GroupAddUserItemView.actions}},{actions:void 0,constructor:function(){KJing.GroupAddUserItemView.actions=
{add:{text:"Ajouter",icon:"plus","default":!0,callback:KJing.GroupAddUserItemView.onAddAction,multiple:!0}}},onAddAction:function(a){a=a.getElements();for(var b=[],c=0;c<a.length;c++)b.push(a[c].getResource());a[0].getGroup().addUsers(b);a[0].getView().create()}});
KJing.ItemView.extend("KJing.GroupAddGroupItemView",{resource:void 0,group:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.group=a.group;delete a.group;this.setItemIcon("group");this.setItemName(this.getResource().getName())},getResource:function(){return this.resource},getGroup:function(){return this.group}},{getSelectionActions:function(){return KJing.GroupAddGroupItemView.actions}},{actions:void 0,constructor:function(){KJing.GroupAddGroupItemView.actions={add:{text:"Ajouter",
icon:"plus","default":!0,callback:KJing.GroupAddGroupItemView.onAddAction,multiple:!0}}},onAddAction:function(a){a=a.getElements();for(var b=[],c=0;c<a.length;c++)b.push(a[c].getResource());a[0].getGroup().addUsers(b);a[0].getView().create()}});
KJing.ItemView.extend("KJing.RightAddUserItemView",{resource:void 0,target:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.target=a.target;delete a.target;this.setItemImage(this.getResource().getFaceUrl());this.setItemName(this.getResource().getName())},getResource:function(){return this.resource},getTarget:function(){return this.target}},{getSelectionActions:function(){return KJing.RightAddUserItemView.actions}},{actions:void 0,constructor:function(){KJing.RightAddUserItemView.actions=
{add:{text:"Ajouter",icon:"plus","default":!0,callback:KJing.RightAddUserItemView.onAddAction,multiple:!0}}},onAddAction:function(a){a=a.getElements();for(var b=a[0].getView().getRights(),c=[],d=0;d<a.length;d++)c.push({user:a[d].getResource().getId(),read:b.read,write:b.write,admin:b.admin});a[0].getTarget().addRights(c);a[0].getView().create()}});
KJing.ItemView.extend("KJing.RightAddGroupItemView",{resource:void 0,target:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.target=a.target;delete a.target;this.setItemIcon("group");this.setItemName(this.getResource().getName())},getResource:function(){return this.resource},getTarget:function(){return this.target}},{getSelectionActions:function(){return KJing.RightAddGroupItemView.actions}},{actions:void 0,constructor:function(){KJing.RightAddGroupItemView.actions={add:{text:"Ajouter",
icon:"plus","default":!0,callback:KJing.RightAddGroupItemView.onAddAction,multiple:!0}}},onAddAction:function(a){a=a.getElements();for(var b=a[0].getView().getRights(),c=[],d=0;d<a.length;d++)c.push({user:a[d].getResource().getId(),read:b.read,write:b.write,admin:b.admin});a[0].getTarget().addRights(c);a[0].getView().create()}});
Ui.SFlow.extend("KJing.NewResourceSelector",{types:void 0,constructor:function(a){this.addEvents("done");"types"in a&&(this.types=a.types,delete a.types);this.setItemAlign("stretch");this.setStretchMaxRatio(5);this.setSpacing(5);a={folder:{icon:"folder",text:"Classeur",creator:KJing.NewFolderCreator},file:{icon:"file",uploader:!0,text:"Fichier",creator:KJing.NewFileCreator},user:{icon:"person",text:"Utilisateur",creator:KJing.NewUserCreator},group:{icon:"group",text:"Groupe de personne",creator:KJing.NewGroupCreator},
share:{icon:"files",text:"Dossier de fichiers",creator:KJing.NewShareCreator},map:{icon:"map",text:"Salle de diffusion",creator:KJing.NewMapCreator},groupuser:{icon:"person",text:"Utilisateur",creator:KJing.NewGroupUserCreator},groupgroup:{icon:"group",text:"Groupe de personne",creator:KJing.NewGroupGroupCreator},rightuser:{icon:"person",text:"Utilisateur",creator:KJing.NewRightUserCreator},rightgroup:{icon:"group",text:"Group de personne",creator:KJing.NewRightGroupCreator},device:{icon:"eye",text:"Client de diffusion",
creator:KJing.NewDeviceCreator}};for(var b in a){if(void 0!==this.types){for(var c=!1,d=0;!c&&d<this.types.length;d++)c=this.types[d]===b;if(!c)continue}c=a[b];c.uploader?(d=new Ui.UploadButton({text:c.text,icon:c.icon,orientation:"horizontal",width:200}),this.connect(d,"file",this.onButtonFile)):(d=new Ui.Button({text:c.text,icon:c.icon,orientation:"horizontal",width:200}),this.connect(d,"press",this.onButtonPress));d.kjingNewResourceSelectorType=c;this.append(d)}},onButtonFile:function(a,b){this.fireEvent("done",
this,a.kjingNewResourceSelectorType,b)},onButtonPress:function(a){this.fireEvent("done",this,a.kjingNewResourceSelectorType)}});
Ui.VBox.extend("KJing.NewGroupUserCreator",{resource:void 0,searchField:void 0,flow:void 0,valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.append(this.searchField);this.flow=new Ui.Flow;this.append(this.flow)},create:function(){this.fireEvent("done",this)},onSearchValidate:function(){var a=new Core.HttpRequest({method:"GET",
url:"/cloud/user?seenBy="+Ui.App.current.getUser().getId()+"&query="+encodeURIComponent(this.searchField.getValue())});this.connect(a,"done",this.onSearchDone);this.connect(a,"error",this.onSearchError);a.send()},onSearchDone:function(a){a=a.getResponseJSON();this.flow.clear();for(var b=0;b<a.length;b++){var c=KJing.Resource.create(a[b]);console.log(c);c=new KJing.GroupAddUserItemView({resource:c,group:this.resource,view:this});this.flow.append(c)}},onSearchError:function(a){}});
Ui.VBox.extend("KJing.NewGroupGroupCreator",{resource:void 0,searchField:void 0,flow:void 0,valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.append(this.searchField);this.flow=new Ui.Flow;this.append(this.flow)},create:function(){this.fireEvent("done",this)},onSearchValidate:function(){var a=new Core.HttpRequest({method:"GET",
url:"/cloud/resource?seenBy="+Ui.App.current.getUser().getId()+"&type=group&query="+encodeURIComponent(this.searchField.getValue())});this.connect(a,"done",this.onSearchDone);this.connect(a,"error",this.onSearchError);a.send()},onSearchDone:function(a){a=a.getResponseJSON();this.flow.clear();for(var b=0;b<a.length;b++){var c=KJing.Resource.create(a[b]),c=new KJing.GroupAddGroupItemView({resource:c,group:this.resource,view:this});this.flow.append(c)}},onSearchError:function(a){}});
Ui.VBox.extend("KJing.NewRightUserCreator",{resource:void 0,searchField:void 0,writeField:void 0,readField:void 0,flow:void 0,valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.append(this.searchField);a=new Ui.HBox;this.append(a);this.writeField=new Ui.CheckBox({text:"Ecriture"});this.adminField=new Ui.CheckBox({text:"Administrer"});
a.append(this.writeField,!0);a.append(this.adminField,!0);this.flow=new Ui.Flow;this.append(this.flow)},getRights:function(){return{read:!0,write:this.writeField.getValue(),admin:this.adminField.getValue()}},create:function(){this.fireEvent("done",this)},onSearchValidate:function(){var a=new Core.HttpRequest({method:"GET",url:"/cloud/user?seenBy="+Ui.App.current.getUser().getId()+"&query="+encodeURIComponent(this.searchField.getValue())});this.connect(a,"done",this.onSearchDone);this.connect(a,"error",
this.onSearchError);a.send()},onSearchDone:function(a){a=a.getResponseJSON();this.flow.clear();for(var b=0;b<a.length;b++){var c=KJing.Resource.create(a[b]);console.log(c);c=new KJing.RightAddUserItemView({resource:c,target:this.resource,view:this});this.flow.append(c)}},onSearchError:function(a){}});
Ui.VBox.extend("KJing.NewRightGroupCreator",{resource:void 0,searchField:void 0,writeField:void 0,readField:void 0,flow:void 0,valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.searchField=new Ui.TextButtonField({buttonIcon:"search"});this.connect(this.searchField,"validate",this.onSearchValidate);this.append(this.searchField);a=new Ui.HBox;this.append(a);this.writeField=new Ui.CheckBox({text:"Ecriture"});this.adminField=new Ui.CheckBox({text:"Administrer"});
a.append(this.writeField,!0);a.append(this.adminField,!0);this.flow=new Ui.Flow;this.append(this.flow)},getRights:function(){return{read:!0,write:this.writeField.getValue(),admin:this.adminField.getValue()}},create:function(){this.fireEvent("done",this)},onSearchValidate:function(){var a=new Core.HttpRequest({method:"GET",url:"/cloud/resource?seenBy="+Ui.App.current.getUser().getId()+"&type=group&query="+encodeURIComponent(this.searchField.getValue())});this.connect(a,"done",this.onSearchDone);this.connect(a,
"error",this.onSearchError);a.send()},onSearchDone:function(a){a=a.getResponseJSON();this.flow.clear();for(var b=0;b<a.length;b++){var c=KJing.Resource.create(a[b]),c=new KJing.RightAddGroupItemView({resource:c,target:this.resource,view:this});this.flow.append(c)}},onSearchError:function(a){}});
Ui.SFlow.extend("KJing.NewUserCreator",{resource:void 0,firstnameField:void 0,lastnameField:void 0,loginField:void 0,passwordField:void 0,valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.setStretchMaxRatio(5);this.firstnameField=new KJing.TextField({title:"Pr\u00e9nom",width:100});this.connect(this.firstnameField,"change",this.checkValid);this.append(this.firstnameField);this.lastnameField=new KJing.TextField({title:"Nom",
width:100});this.connect(this.lastnameField,"change",this.checkValid);this.append(this.lastnameField);this.loginField=new KJing.TextField({title:"Identifiant",width:200});this.connect(this.loginField,"change",this.checkValid);this.append(this.loginField);this.passwordField=new KJing.TextField({title:"Mot de passe",width:200,passwordMode:!0,desc:"8 caract\u00e8res minimum avec chiffre et lettre"});this.connect(this.passwordField,"change",this.checkValid);this.append(this.passwordField)},create:function(){var a=
new Core.HttpRequest({method:"POST",url:"/cloud/resource",content:JSON.stringify({type:"user",parent:this.resource.getId(),firstname:this.firstnameField.getValue(),lastname:this.lastnameField.getValue(),login:this.loginField.getValue(),password:this.passwordField.getValue()})});this.connect(a,"done",this.onRequestDone);this.connect(a,"done",this.onRequestFail);this.valid=!1;this.fireEvent("notvalid",this);a.send()},onRequestFail:function(){this.valid=!0;this.fireEvent("valid",this)},onRequestDone:function(){this.fireEvent("done",
this)},checkValid:function(){var a=""!==this.loginField.getValue(),b=this.passwordField.getValue(),a=a&""!==b&8<=b.length;this.valid!==a&&((this.valid=a)?this.fireEvent("valid",this):this.fireEvent("notvalid",this))}});
Ui.SFlow.extend("KJing.NewResourceCreator",{nameField:void 0,resource:void 0,resourceType:"resource",valid:!1,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.setStretchMaxRatio(5);this.nameField=new KJing.TextField({title:"Nom",width:150});this.connect(this.nameField,"change",this.checkValid);this.append(this.nameField)},setType:function(a){this.type=a},create:function(){var a=new Core.HttpRequest({method:"POST",
url:"/cloud/resource",content:JSON.stringify({type:this.type,parent:this.resource.getId(),name:this.nameField.getValue()})});this.connect(a,"done",this.onRequestDone);this.connect(a,"done",this.onRequestFail);this.valid=!1;this.fireEvent("notvalid",this);a.send()},onRequestFail:function(){this.valid=!0;this.fireEvent("valid",this)},onRequestDone:function(){this.fireEvent("done",this)},checkValid:function(){var a=""!==this.nameField.getValue();this.valid!==a&&((this.valid=a)?this.fireEvent("valid",
this):this.fireEvent("notvalid",this))}});KJing.NewResourceCreator.extend("KJing.NewGroupCreator",{constructor:function(a){this.setType("group")}});KJing.NewResourceCreator.extend("KJing.NewMapCreator",{constructor:function(a){this.setType("map")}});KJing.NewResourceCreator.extend("KJing.NewFolderCreator",{constructor:function(a){this.setType("folder")}});KJing.NewResourceCreator.extend("KJing.NewShareCreator",{constructor:function(a){this.setType("share")}});
Ui.SFlow.extend("KJing.AirPlayDeviceForm",{addressField:void 0,passwordField:void 0,constructor:function(a){this.setItemAlign("stretch");this.setSpacing(10);this.setStretchMaxRatio(5);this.addressField=new KJing.TextField({title:"Nom de l'h\u00f4te (ou adresse IP)",width:150});this.append(this.addressField);this.passwordField=new KJing.TextField({title:"Mot de passe (si n\u00e9cessaire)",width:150,passwordMode:!0});this.append(this.passwordField)}});
Ui.SFlow.extend("KJing.ChromecastDeviceForm",{addressField:void 0,constructor:function(a){this.setItemAlign("stretch");this.setSpacing(10);this.setStretchMaxRatio(5);this.addressField=new KJing.TextField({title:"Nom de l'h\u00f4te (ou adresse IP)",width:150});this.append(this.addressField)}});
Ui.SFlow.extend("KJing.NewDeviceCreator",{resource:void 0,form:void 0,valid:!1,nameField:void 0,protocolField:void 0,constructor:function(a){this.addEvents("done","valid","notvalid");this.resource=a.resource;delete a.resource;this.setItemAlign("stretch");this.setSpacing(10);this.nameField=new KJing.TextField({title:"Nom",width:150});this.connect(this.nameField,"change",this.checkValid);this.append(this.nameField);this.protocolField=new KJing.ComboField({title:"Protocole",field:"text"});this.protocolField.setData([{text:"Web",
protocol:"web"},{text:"AirPlay",protocol:"airplay",creator:KJing.AirPlayDeviceForm},{text:"Chromecast",protocol:"chromecast",creator:KJing.ChromecastDeviceForm}]);this.protocolField.setCurrentAt(0);this.connect(this.protocolField,"change",this.onProtocolChange);this.append(this.protocolField)},create:function(){this.valid=!1;this.fireEvent("notvalid",this);var a=this.protocolField.getValue(),a={type:"device",parent:this.resource.getId(),protocol:a.protocol,name:this.nameField.getValue()},a=new Core.HttpRequest({method:"POST",
url:"/cloud/resource",content:JSON.stringify(a)});this.connect(a,"done",function(){this.fireEvent("done",this)});this.connect(a,"error",function(){this.fireEvent("done",this)});a.send()},checkValid:function(){var a=""!==this.nameField.getValue();this.valid!==a&&((this.valid=a)?this.fireEvent("valid",this):this.fireEvent("notvalid",this))},onProtocolChange:function(a,b,c){void 0!==this.form&&(this.remove(this.form),this.form=void 0);void 0!==b.creator&&(this.form=new b.creator,this.append(this.form));
this.checkValid()}});
Ui.Dialog.extend("KJing.NewResourceDialog",{transBox:void 0,resource:void 0,prevButton:void 0,createButton:void 0,creator:void 0,selector:void 0,types:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;"types"in a&&(this.types=a.types,delete a.types);this.setTitle("Nouvelle ressource");this.setFullScrolling(!0);this.setPreferredWidth(400);this.setPreferredHeight(400);this.transBox=new Ui.TransitionBox;this.setContent(this.transBox);this.selector=new KJing.NewResourceSelector({types:this.types});this.connect(this.selector,
"done",this.onSelectorDone);this.transBox.replaceContent(this.selector);this.setCancelButton(new Ui.DialogCloseButton({text:"Annuler"}));this.prevButton=new Ui.Button({text:"Pr\u00e9c\u00e9dent"});this.connect(this.prevButton,"press",this.onPrevPress);this.createButton=new Ui.Button({text:"Cr\u00e9er"});this.connect(this.createButton,"press",this.onCreatePress)},onSelectorDone:function(a,b,c){this.setTitle(b.text);this.setActionButtons([this.prevButton,this.createButton]);this.creator=void 0!==c?
new b.creator({resource:this.resource,file:c}):new b.creator({resource:this.resource});this.transBox.replaceContent(this.creator);this.connect(this.creator,"done",this.onCreatorDone);this.connect(this.creator,"valid",this.onCreatorValid);this.connect(this.creator,"notvalid",this.onCreatorNotvalid);this.onCreatorNotvalid(this.creator)},onPrevPress:function(){this.setTitle("Nouvelle ressource");this.setActionButtons([]);this.transBox.replaceContent(this.selector);void 0!==this.creator&&(this.disconnect(this.creator,
"done",this.onCreatorDone),this.disconnect(this.creator,"valid",this.onCreatorValid),this.disconnect(this.creator,"notvalid",this.onCreatorNovalid),this.creator=void 0)},onCreatePress:function(){this.creator.create()},onCreatorDone:function(){this.close();this.resource.update()},onCreatorValid:function(){this.createButton.enable()},onCreatorNotvalid:function(){this.createButton.disable()}});Ui.FlowDropBox.extend("KJing.ResourceView",{resource:void 0,view:void 0,flow:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.setUniform(!0);a=this.onItemEffect.bind(this);this.addType(KJing.FolderItemView,a);this.addType(KJing.FileItemView,a);this.addType(KJing.GroupItemView,a);this.addType(KJing.UserItemView,a);this.addType(KJing.MapItemView,a);this.addType("files","copy");this.connect(this,"dropat",this.onItemDropAt);this.connect(this,
"dropfileat",this.onItemDropFileAt);if(this.resource.getIsChildrenReady())this.onResourceChange();else this.resource.loadChildren()},getResource:function(){return this.resource},onItemEffect:function(a,b){console.log(this+".onItemEffect pos: "+b);if(a.getResource().getParentId()===this.resource.getId()){for(var c=this.getLogicalChildren(),d=void 0,e=0;void 0===d&&e<c.length;e++){var f=c[e];KJing.ResourceItemView.hasInstance(f)&&f.getResource().getId()===a.getResource().getId()&&(d=e)}return 0<c.length&&
!KJing.ResourceItemView.hasInstance(c[0])&&0===b?"none":void 0===d?"none":b===d||b===d+1?"none":"move"}return a.getResource().getOwnerId()===this.resource.getOwnerId()?a.getResource().getId()===this.resource.getId()||a.getResource().getIsParentOf(this.resource)?"none":"move":"link"},onItemDropAt:function(a,b,c,d,e,f){console.log(this+".onItemDropAt "+b+", effect: "+c+", pos: "+d);d--;KJing.ResourceItemView.hasInstance(b)&&("move"===c?b.getResource().changeData({parent:this.resource.getId(),position:d}):
"link"===c&&(new Core.HttpRequest({method:"POST",url:"/cloud/link",content:JSON.stringify({type:"link",parent:this.resource.getId(),pos:d,link:b.getResource().getId()})})).send())},onItemDropFileAt:function(a,b,c,d,e,f){d--;a=new Core.FilePostUploader({file:b,service:"/cloud/file"});b=Ui.App.current.addUploader(a);a.setField("define",JSON.stringify({type:"file",parent:this.resource.getId(),position:d,uploader:b}));this.connect(a,"error",this.onUploadError);this.connect(a,"complete",this.onUploadError);
a.send()},onUploadError:function(a){this.resource.update()},onResourceChange:function(){this.clear();this.append(new KJing.ResourceNewItem({view:this.view,resource:this.resource,types:["folder","file","user","group","map"]}));for(var a=this.resource.getChildren(),b=0;b<a.length;b++)this.addResource(a[b],!1);for(var c=this.resource.getShares(),b=0;b<c.length;b++){for(var d=!1,e=0;!1===d&&e<a.length;e++)d=a[e].getId()===c[b].getId();d||this.addResource(c[b],!0)}},addResource:function(a,b){var c;"group"==
a.getType()?c=new KJing.GroupItemView({resource:a,view:this.view,share:b}):"map"==a.getType()?c=new KJing.MapItemView({resource:a,view:this.view,share:b}):"folder"==a.getType()?c=new KJing.FolderItemView({resource:a,view:this.view,share:b}):"user"==a.getType()?c=new KJing.UserItemView({resource:a,view:this.view,share:b}):"link"==a.getType()?c=new KJing.LinkItemView({resource:a,view:this.view,share:b}):"file"==a.getType()&&(c=new KJing.FileItemView({resource:a,view:this.view,share:b}));void 0!==c&&
this.append(c)},getSetupPopup:function(){var a=new Ui.MenuPopup({preferredWidth:200}),b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.hide()});b.append(c);return a}},{onLoad:function(){KJing.ResourceView.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.ResourceView.base.onUnload.apply(this,
arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});Ui.DropBox.extend("KJing.GroupView",{resource:void 0,view:void 0,flow:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.flow=new Ui.Flow({spacing:5,uniform:!0});this.setContent(this.flow);a=this.onItemEffect.bind(this);this.addType(KJing.GroupUserItemView,a);this.addType(KJing.UserItemView,a);this.connect(this,"drop",this.onItemDrop);if(this.resource.getIsReady())this.onResourceChange()},getResource:function(){return this.resource},getSetupPopup:function(){var a=
new Ui.MenuPopup({preferredWidth:200}),b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.hide()});b.append(c);return a},onItemEffect:function(a){for(var b=this.getResource().getUsers(),c=0;c<b.length;c++)if(b[c]===a.getResource().getId())return"none";return"link"},onResourceChange:function(){this.flow.clear();this.flow.append(new KJing.ResourceNewItem({view:this.view,
resource:this.resource,types:["groupuser","groupgroup"]}));for(var a=this.resource.getUsers(),b=0;b<a.length;b++){var c=KJing.Resource.create(a[b]);this.flow.append(new KJing.GroupUserItemView({group:this.resource,resource:c,view:this.view}))}},onItemDrop:function(a,b,c,d,e){this.resource.addUser(b.getResource())}},{onLoad:function(){KJing.GroupView.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.GroupView.base.onUnload.apply(this,
arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});Ui.DropBox.extend("KJing.MapProvisioningView",{resource:void 0,view:void 0,flow:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.flow=new Ui.Flow({spacing:5,uniform:!0});this.setContent(this.flow);this.flow.append(new KJing.ResourceNewItem({view:this.view,resource:this.resource,types:["device"]}));if(this.resource.getIsReady())this.onResourceChange()},getResource:function(){return this.resource},onResourceChange:function(){for(var a=this.resource.getChildren(),
b=this.flow.getChildren(),c=[],d=1;d<b.length;d++){for(var e=!1,f=0;!e&&f<a.length;f++)e=b[d].getResource().getId()===a[f].getId();e||c.push(b[d])}for(f=0;f<c.length;f++)this.flow.remove(c[f]);c=[];for(f=0;f<a.length;f++)if(KJing.Device.hasInstance(a[f])){e=!1;for(d=1;!e&&d<b.length;d++)e=b[d].getResource().getId()===a[f].getId();e||c.push(a[f])}for(f=0;f<c.length;f++)this.flow.append(new KJing.DeviceItemView({resource:c[f],view:this.view}))}},{onLoad:function(){KJing.MapProvisioningView.base.onLoad.apply(this,
arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.MapProvisioningView.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
Ui.VBox.extend("KJing.MapMapView",{resource:void 0,view:void 0,devicesBox:void 0,fold:void 0,provisioningText:void 0,mapDevicesView:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.mapDevicesView=new KJing.MapDevicesView({view:this.view,resource:this.resource});this.append(this.mapDevicesView,!0);a=new Ui.ScrollingArea({scrollVertical:!1});this.devicesBox=new Ui.HBox({height:120,uniform:!0});a.setContent(this.devicesBox);var b=new Ui.Pressable;
b.append(new Ui.Rectangle({fill:"rgba(120,120,120,0.1)"}));this.provisioningText=new Ui.Text({text:"Hello World",margin:5,textAlign:"center"});b.append(this.provisioningText);this.fold=new Ui.Fold({over:!1});this.connect(b,"press",function(){this.fold.invert()});this.fold.setHeader(b);this.fold.setContent(a);this.append(this.fold);if(this.resource.getIsReady())this.onResourceChange()},getResource:function(){return this.resource},onResourceChange:function(){for(var a=this.resource.getChildren(),b=
this.devicesBox.getChildren(),c=[],d=0;d<b.length;d++){for(var e=!1,f=0;!e&&f<a.length;f++)KJing.Device.hasInstance(a[f])&&(this.resource.isAttachedDevice(a[f])||(e=b[d].getResource().getId()===a[f].getId()));e||c.push(b[d])}for(f=0;f<c.length;f++)this.devicesBox.remove(c[f]);for(var c=[],g=0,f=0;f<a.length;f++)if(KJing.Device.hasInstance(a[f])&&!this.resource.isAttachedDevice(a[f])){g++;e=!1;for(d=0;!e&&d<b.length;d++)e=b[d].getResource().getId()===a[f].getId();e||c.push(a[f])}for(f=0;f<c.length;f++)this.devicesBox.append(new KJing.DeviceItemView({resource:c[f],
view:this.view}));this.provisioningText.setText(g+" clients en attente")}},{onLoad:function(){KJing.MapMapView.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.MapMapView.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});
Ui.DropBox.extend("KJing.MapView",{resource:void 0,view:void 0,viewMode:"map",constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.setContent(new KJing.MapMapView({resource:this.resource,view:this.view}))},getResource:function(){return this.resource},getSetupPopup:function(){var a=new Ui.MenuPopup({preferredWidth:200}),b=new Ui.VBox({spacing:10});a.setContent(b);var c=new Ui.SegmentBar({margin:10,orientation:"horizontal",field:"text",data:[{text:"Carte",
value:"map"},{text:"Rattach\u00e9s",value:"provisioning"}]});b.append(c);"provisioning"===this.viewMode?c.setCurrentPosition(1):c.setCurrentPosition(0);this.connect(c,"change",function(b,c){c.value!==this.viewMode&&(this.viewMode=c.value,"provisioning"===this.viewMode?this.setContent(new KJing.MapProvisioningView({resource:this.resource,view:this.view})):this.setContent(new KJing.MapMapView({resource:this.resource,view:this.view})));a.hide()});c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});
this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.hide()});b.append(c);return a}});Ui.Dialog.extend("Storage.TextEditor",{file:void 0,textField:void 0,updateRequest:void 0,saveRequest:void 0,constructor:function(a){this.file=a.file;delete a.file;this.setTitle("Edition de texte");this.setFullScrolling(!0);this.setPreferredWidth(600);this.setPreferredHeight(600);this.setCancelButton(new Ui.DialogCloseButton);a=new Ui.DefaultButton({text:"Enregistrer & Fermer"});this.connect(a,"press",this.onSaveQuitPress);this.setActionButtons([a]);a=new Ui.ScaleBox({fixedWidth:800,fixedHeight:600});
this.setContent(a);a.append(new Ui.Rectangle({fill:"black"}));this.textField=navigator.isIE7||navigator.isIE8?new Ui.TextArea({margin:20,style:{"Ui.TextArea":{fontSize:40,color:"white"}}}):new Ui.ContentEditable({margin:20,style:{"Ui.ContentEditable":{fontSize:40,color:"white"}}});a.append(this.textField);this.updateText()},updateText:function(){void 0===this.updateRequest&&(this.updateRequest=new Core.HttpRequest({url:this.file.getDownloadUrl()}),this.connect(this.updateRequest,"done",this.onUpdateTextDone),
this.connect(this.updateRequest,"error",this.onUpdateTextError),this.updateRequest.send())},onUpdateTextDone:function(){var a=this.updateRequest.getResponseText();""===a&&(a="\n");navigator.isIE7||navigator.isIE8?this.textField.setValue(a):this.textField.setText(a);this.updateRequest=void 0},onUpdateTextError:function(){this.updateRequest=void 0},onSaveQuitPress:function(){var a;a=navigator.isIE7||navigator.isIE8?this.textField.getValue():this.textField.getText();this.saveRequest=new Core.HttpRequest({method:"PUT",
url:this.file.getUploadUrl()});this.saveRequest.setContent(a);this.connect(this.saveRequest,"done",this.onSaveTextDone);this.connect(this.saveRequest,"error",this.onSaveTextError);this.saveRequest.send()},onSaveTextDone:function(){this.close()},onSaveTextError:function(){this.close()}});Ui.HBox.extend("Storage.FileViewer",{uploader:void 0,file:void 0,updateNeeded:!1,viewer:void 0,tools:void 0,contentBox:void 0,playing:!1,contentViewer:void 0,constructor:function(a){this.addEvents("toolschange","end");this.tools=[];this.contentBox=new Ui.LBox;this.append(this.contentBox,!0);"uploader"in a?(this.uploader=a.uploader,delete a.uploader):"file"in a&&(this.update(a.file),delete a.file)},getSetupPopup:function(){var a=new Ui.MenuPopup({preferredWidth:200}),b=new Ui.VBox({spacing:10});a.setContent(b);
for(var c=0;c<this.tools.length;c++)b.append(this.tools[c]);c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.file})).open();a.hide()});b.append(c);return a},update:function(a){if(void 0===this.file||this.updateNeeded||this.file.rev!=a.rev)this.file=a,this.updateNeeded=!1,this.getIsLoaded()&&this.buildContent()},removeContent:function(){this.contentBox.setContent()},buildContent:function(){void 0!==this.uploader?
this.contentBox.setContent(new Storage.UploaderViewer({storage:this.storage,uploader:this.uploader,fileViewer:this})):(this.tools=[],this.supportProperties=!0,"image/gif"==this.file.getMimetype()?this.contentViewer=new Storage.GifImageFileViewer({file:this.file,fileViewer:this}):0==this.file.getMimetype().indexOf("image/")?this.contentViewer=new Storage.ImageFileViewer({file:this.file,fileViewer:this}):"text/uri-list"==this.file.getMimetype()?this.contentViewer=new Storage.SiteFileViewer({file:this.file,
fileViewer:this}):!navigator.isIE7&&!navigator.isIE8&&0==this.file.getMimetype().indexOf("video/")?this.contentViewer=new Storage.VideoFileViewer({file:this.file,fileViewer:this}):!navigator.isIE7&&!navigator.isIE8&&0==this.file.getMimetype().indexOf("audio/")?this.contentViewer=new Storage.AudioFileViewer({file:this.file,fileViewer:this}):0==this.file.getMimetype().indexOf("text/plain")&&5E4>this.file.getData().size?this.contentViewer=new Storage.TextFileViewer({file:this.file,fileViewer:this}):
0===this.file.getMimetype().indexOf("application/pdf")?this.contentViewer=new Storage.PdfFileViewer({file:this.file,fileViewer:this}):this.contentViewer=new Storage.GenericFileViewer({file:this.file,fileViewer:this}),this.contentBox.setContent(this.contentViewer),this.playing&&this.play())},getFile:function(){return this.file},getUploader:function(){return this.uploader},getTools:function(){return this.tools},appendTool:function(a){this.tools.push(a);this.fireEvent("toolschange",this,this.tools)},
play:function(){if(void 0===this.contentViewer)this.playing=!0;else if("play"in this.contentViewer)this.connect(this.contentViewer,"end",this.onPlayEnd),this.contentViewer.play();else{var a=5;"duration"in this.file.meta&&(a=parseFloat(this.file.meta.duration));new Core.DelayedTask({scope:this,delay:a,callback:this.onPlayEnd})}},current:function(){0<this.contentBox.getChildren().length&&"current"in this.contentBox.getChildren()[0]&&this.contentBox.getChildren()[0].current()},uncurrent:function(){0<
this.contentBox.getChildren().length&&"uncurrent"in this.contentBox.getChildren()[0]&&this.contentBox.getChildren()[0].uncurrent()},onPlayEnd:function(){this.playing=!1;this.fireEvent("end",this)},deleteFile:function(){void 0!==this.file?(this.file.suppress(),(new Core.HttpRequest({method:"DELETE",url:"/cloud/storage/"+this.storage+"/"+this.file.id})).send()):void 0!=this.uploader&&this.uploader.abort()},onFileChange:function(){this.buildContent()}},{onLoad:function(){Storage.FileViewer.base.onLoad.apply(this,
arguments);this.connect(this.file,"change",this.onFileChange);if(this.file.getIsReady())this.onFileChange();this.file.monitor()},onUnload:function(){Storage.FileViewer.base.onUnload.apply(this,arguments);this.disconnect(this.file,"change",this.onFileChange);this.removeContent();this.file.unmonitor()}});
Ui.LBox.extend("Storage.UploaderViewer",{storage:void 0,uploader:void 0,progressbar:void 0,label:void 0,fileViewer:void 0,constructor:function(a){this.storage=a.storage;delete a.storage;this.uploader=a.uploader;delete a.uploader;this.fileViewer=a.fileViewer;delete a.fileViewer;a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center"});this.setContent(a);a.append(new Ui.Icon({icon:"uploadfile",fill:"#3f3f3f",width:256,height:256,horizontalAlign:"center"}));this.progressbar=new Ui.ProgressBar({width:120,
height:10});a.append(this.progressbar);void 0!=this.uploader.getFile().getFileName()&&a.append(new Ui.CompactLabel({width:256,maxLine:3,textAlign:"center",text:this.uploader.getFile().getFileName()}));this.connect(this.uploader,"progress",this.onUploaderProgress)},onUploaderProgress:function(a,b,c){this.progressbar.setValue(b/c)}});
Ui.LBox.extend("Storage.DirectoryFileViewer",{storage:void 0,file:void 0,image:void 0,values:void 0,quality:!1,fileViewer:void 0,transBox:void 0,playing:!1,directoryChildren:void 0,position:void 0,constructor:function(a){this.addEvents("end");this.storage=a.storage;delete a.storage;this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;this.transBox=new Ui.TransitionBox;this.setContent(this.transBox);var b=new Core.HttpRequest({url:"/cloud/storage/"+this.storage+"/"+this.file.id+
"?depth=1"});this.connect(b,"done",function(){var a=b.getResponseJSON();this.directoryChildren=a.children;0===this.directoryChildren.length?this.playing&&this.fireEvent("end",this):(this.position=0,a=new Storage.FileViewer({storage:this.storage,file:a.children[this.position]}),this.connect(a,"end",this.onFileEnd),this.transBox.replaceContent(a),this.playing&&a.play())});b.send()},play:function(){this.playing=!0;void 0!==this.directoryChildren&&0===this.directoryChildren.length?this.fireEvent("end",
this):void 0!==this.transBox.getCurrent()&&this.transBox.getCurrent().play()},onFileEnd:function(){this.disconnect(this.transBox.getCurrent(),"end",this.onFileEnd);this.position++;if(this.position>=this.directoryChildren.length)this.fireEvent("end",this);else{var a=new Storage.FileViewer({storage:this.storage,file:this.directoryChildren[this.position]});this.connect(a,"end",this.onFileEnd);this.transBox.replaceContent(a);a.play()}}});
Ui.ScrollingArea.extend("Storage.ImageFileViewer",{file:void 0,image:void 0,values:void 0,quality:!1,fileViewer:void 0,transformable:void 0,userInteraction:!0,constructor:function(a){this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;this.setMaxScale(4);this.image=new KJing.ScaledImage2;void 0!==this.file.getPreviewHighUrl()&&this.image.setSrc(this.file.getPreviewHighUrl());this.setContent(this.image)}});
Ui.LBox.extend("Storage.GifImageFileViewer",{file:void 0,image:void 0,values:void 0,fileViewer:void 0,constructor:function(a){this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;this.image=new KJing.ScaledImage2;this.image.setSrc(this.file.getDownloadUrl());this.setContent(this.image)}});
Ui.LBox.extend("Storage.SiteFileViewer",{storage:void 0,file:void 0,text:void 0,fileViewer:void 0,linkButton:void 0,constructor:function(a){this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;a=new Core.HttpRequest({method:"GET",url:this.file.getDownloadUrl()});this.connect(a,"done",this.onContentLoaded);a.send();a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center",spacing:10});this.setContent(a);var b=new Ui.LBox({verticalAlign:"bottom",horizontalAlign:"center"});
a.append(b);var c=new Ui.Image({width:128});void 0!==this.file.getPreviewUrl()&&c.setSrc(this.file.getPreviewUrl());b.append(c);this.connect(c,"error",function(){b.setContent(new Ui.Icon({icon:"earth",verticalAlign:"bottom",horizontalAlign:"center",width:128}))});this.text=new Ui.Text({textAlign:"center",text:this.file.getName(),fontSize:20});a.append(this.text);this.linkButton=new Ui.LinkButton({text:"Ouvrir le site",horizontalAlign:"center"});this.linkButton.disable();a.append(this.linkButton)},
onContentLoaded:function(a){this.linkButton.setSrc(a.getResponseText());this.linkButton.enable()}});
Ui.LBox.extend("Storage.AudioFileViewer",{file:void 0,fileViewer:void 0,player:void 0,playing:!1,constructor:function(a){console.log("new Storage.AudioFileViewer");this.addEvents("end");this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer},uncurrent:function(){void 0!==this.player&&this.player.pause()},play:function(){this.playing=!0;var a=!navigator.iOs&&!navigator.Android;void 0!==this.player&&a&&this.player.play()},onMediaEnd:function(){this.fireEvent("end",this)},onFileChange:function(){console.log(this+
".onFileChange");console.log(this.file.getData());if(void 0===this.file.getData().audioMp3)this.setContent(new Ui.Text({text:"Impossible d'\u00e9couter ce fichier son",verticalAlign:"center",textAlign:"center"}));else{var a=KJing.File.create(this.file.getData().audioMp3);"application/x-cache-progress"===a.getMimetype()?(a=new Ui.VBox({verticalAlign:"center",spacing:10}),a.append(new Ui.Loading({width:50,height:50,horizontalAlign:"center"})),a.append(new Ui.Text({text:"Encodage en cours... Veuillez patienter",
textAlign:"center"}))):"audio/mpeg"===a.getMimetype()?(this.player=new KJing.AudioPlayer({src:a.getDownloadUrl(),text:this.file.getName()}),this.connect(this.player,"end",this.onMediaEnd),this.setContent(this.player),this.playing&&this.play()):this.setContent(new Ui.Text({text:"Impossible d'\u00e9couter ce fichier son",verticalAlign:"center",textAlign:"center"}))}}},{onVisible:function(){void 0===this.player&&(this.connect(this.file,"change",this.onFileChange),this.onFileChange())},onHidden:function(){this.disconnect(this.file,
"change",this.onFileChange);void 0!==this.player&&this.player.pause()}});
Ui.Pressable.extend("Storage.VideoFileViewer",{file:void 0,fileViewer:void 0,player:void 0,playing:!1,constructor:function(a){this.addEvents("end");this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;this.setLock(!0);this.connect(this,"press",this.onVideoPress)},onVideoEnd:function(a){this.playing=!1;this.fireEvent("end",this)},onVideoStateChange:function(a){this.setLock(this.player.getIsControlsVisible())},onVideoPress:function(){void 0!==this.player&&"playing"==this.player.getState()&&
this.player.pause()},uncurrent:function(){void 0!==this.player&&this.player.pause()},play:function(){this.playing=!0;var a=!navigator.iOs&&!navigator.Android;void 0!==this.player&&a&&this.player.play()},onFileChange:function(){if(void 0===this.file.getData().videoMp4)this.setContent(new Ui.Text({text:"Impossible de lire ce fichier vid\u00e9o",verticalAlign:"center",textAlign:"center"}));else{var a=KJing.File.create(this.file.getData().videoMp4);"application/x-cache-progress"===a.getMimetype()?(a=
new Ui.VBox({verticalAlign:"center",spacing:10}),a.append(new Ui.Loading({width:50,height:50,horizontalAlign:"center"})),a.append(new Ui.Text({text:"Encodage en cours... Veuillez patienter",textAlign:"center"}))):"video/mp4"===a.getMimetype()?(this.player=new KJing.VideoPlayer({src:a.getDownloadUrl(),poster:this.file.getPreviewHighUrl()}),this.connect(this.player,"statechange",this.onVideoStateChange),this.connect(this.player,"end",this.onVideoEnd),this.setContent(this.player),this.playing&&this.play()):
this.setContent(new Ui.Text({text:"Impossible de lire ce fichier vid\u00e9o",verticalAlign:"center",textAlign:"center"}))}}},{onVisible:function(){void 0===this.player&&(this.connect(this.file,"change",this.onFileChange),this.onFileChange())},onHidden:function(){this.disconnect(this.file,"change",this.onFileChange);void 0!==this.player&&this.player.pause()}});
Ui.LBox.extend("Storage.TextFileViewer",{file:void 0,fileViewer:void 0,text:void 0,constructor:function(a){this.storage=a.storage;delete a.storage;this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;a=new Ui.ScaleBox({fixedWidth:800,fixedHeight:600});this.setContent(a);a.append(new Ui.Rectangle({fill:"black"}));this.text=new Ui.Text({margin:20,style:{"Ui.Text":{fontSize:40,color:"white"}}});a.append(this.text);a=new Core.HttpRequest({method:"GET",url:this.file.getDownloadUrl()});
this.connect(a,"done",this.onTextLoaded);a.send();var b=new Ui.Button({text:"Edit",icon:"edit"});this.connect(b,"press",function(){(new Storage.TextEditor({file:this.file})).open();for(var a=void 0,d=b.getParent();void 0===a&&void 0!==d;)Ui.Popup.hasInstance(d)&&(a=d),d=d.getParent();void 0!==a&&a.hide()});this.fileViewer.appendTool(b)},onTextLoaded:function(a){this.text.setText(a.getResponseText())}});
Ui.CanvasElement.extend("Storage.PageBackgroundGraphic",{},{updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight();a.roundRectFilledShadow(5,5,b-10,c-10,2,2,2,2,!1,2,new Ui.Color({r:0,g:0,b:0,a:0.5}));a.fillStyle="#ffffff";a.fillRect(7,7,b-14,c-14)}});
Ui.LBox.extend("Storage.RssItemFileViewer",{storage:void 0,file:void 0,fileViewer:void 0,title:void 0,content:void 0,constructor:function(a){this.storage=a.storage;delete a.storage;this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;var b=new Ui.ScrollingArea({scrollHorizontal:!1,scrollVertical:!0});this.setContent(b);a=new Ui.LBox;a.append(new Storage.PageBackgroundGraphic);b.setContent(a);b=new Ui.VBox({margin:20,spacing:10});a.append(b);this.title=new Ui.Text({text:this.file.name,
fontWeight:"bold",fontSize:24,marginTop:20});b.append(this.title);this.content=new Ui.Html;this.connect(this.content,"link",this.onContentLink);b.append(this.content);a=new Core.HttpRequest({method:"GET",url:"/cloud/storage/"+this.storage+"/"+this.file.id+"/content?rev="+this.file.rev});this.connect(a,"done",this.onTextLoaded);a.send()},onTextLoaded:function(a){var b='<div style="word-wrap: break-word; font-family: '+this.getStyleProperty("fontFamily")+";font-size: "+this.getStyleProperty("fontSize")+
"px;font-weight: "+this.getStyleProperty("fontWeight")+';">',b=b+((new Date(this.file.meta.pubDate)).toLocaleString()+"&nbsp;&nbsp;");void 0!=this.file.meta.link&&(b+='<a href="'+this.file.meta.link+'" style="cursor: pointer; text-decoration: underline; color: #4d4d4d">article complet</a><br>');b=b+"<br>"+a.getResponseText();b+="</div>";this.content.setHtml(b)},onContentLink:function(a,b){window.open(b,"_blank")}});
Ui.CanvasElement.extend("Storage.PdfPageGraphic",{src:void 0,image:void 0,ratio:1,constructor:function(a){this.src=a.src;delete a.src;this.ratio=a.ratio;delete a.ratio;this.image=new Ui.Image({src:this.src});this.connect(this.image,"ready",this.onImageReady);this.appendChild(this.image)},onImageReady:function(){this.invalidateDraw()}},{measureCore:function(a,b){return{width:a,height:(a-14)/this.ratio+14}},updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight();a.roundRectFilledShadow(5,
5,b-10,c-10,2,2,2,2,!1,2,new Ui.Color({r:0,g:0,b:0,a:0.5}));a.fillStyle="#ffffff";a.fillRect(7,7,b-14,c-14);this.image.getIsReady()&&a.drawImage(this.image.getDrawing(),0,0,this.image.getNaturalWidth(),this.image.getNaturalHeight(),7,7,b-14,c-14)}});Ui.ScrollingArea.extend("Storage.PdfPage",{file:void 0,constructor:function(a){this.file=a.file;delete a.file;this.setMaxScale(4);this.setContent(new KJing.ScaledImage2({src:this.file.getDownloadUrl()}))}});
Ui.CarouselableLoader.extend("Storage.PdfPagesLoader",{file:void 0,pages:void 0,constructor:function(a){this.file=a.file;delete a.file;console.log(this.file);this.pages=this.file.getData().pdfPages.cache}},{getMin:function(){return 0},getMax:function(){return this.pages.length-1},getElementAt:function(a){return new Storage.PdfPage({file:KJing.File.create(this.pages[a])})}});
Ui.LBox.extend("Storage.PdfFileViewer",{file:void 0,fileViewer:void 0,data:void 0,isCurrent:!1,carousel:void 0,loader:void 0,checkTask:void 0,request:void 0,position:0,constructor:function(a){this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;this.onPagesReady()},onPagesReady:function(){this.loader=new Storage.PdfPagesLoader({file:this.file});this.carousel=new Ui.Carousel3({loader:this.loader});this.setContent(this.carousel)}});
Ui.LBox.extend("Storage.GenericFileViewer",{file:void 0,text:void 0,fileViewer:void 0,constructor:function(a){this.file=a.file;delete a.file;this.fileViewer=a.fileViewer;delete a.fileViewer;a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center",spacing:10});this.setContent(a);a.append(new Ui.Icon({icon:"file",width:128,height:128,horizontalAlign:"center"}));this.text=new Ui.Text({textAlign:"center",text:this.file.getName(),fontSize:20});a.append(this.text);var b=new Ui.DownloadButton({text:"T\u00e9l\u00e9charger",
horizontalAlign:"center"});b.setSrc(this.file.getDownloadUrl(!0));a.append(b)}});Ui.LBox.extend("KJing.FileControlViewer",{fileControl:void 0,contentViewer:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl},onFileControlReady:function(){var a=this.fileControl.getFile();0==a.getMimetype().indexOf("image/")?this.contentViewer=new KJing.ImageFileControlViewer({fileControl:this.fileControl}):!navigator.isIE7&&!navigator.isIE8&&0===a.getMimetype().indexOf("video/")?this.contentViewer=new KJing.VideoFileControlViewer({fileControl:this.fileControl}):
!navigator.isIE7&&!navigator.isIE8&&0===a.getMimetype().indexOf("audio/")?this.contentViewer=new KJing.AudioFileControlViewer({fileControl:this.fileControl}):"text/uri-list"===a.getMimetype()?this.contentViewer=new KJing.SiteFileControlViewer({fileControl:this.fileControl}):"application/pdf"===a.getMimetype()?this.contentViewer=new KJing.PdfFileControlViewer({fileControl:this.fileControl}):0===a.getMimetype().indexOf("text/plain")&&(this.contentViewer=new KJing.TextFileControlViewer({fileControl:this.fileControl}));
void 0!==this.contentViewer&&this.setContent(this.contentViewer)}},{onLoad:function(){KJing.FileControlViewer.base.onLoad.apply(this,arguments);this.connect(this.fileControl,"ready",this.onFileControlReady);if(this.fileControl.getIsReady())this.onFileControlReady()},onUnload:function(){KJing.FileControlViewer.base.onUnload.apply(this,arguments);this.disconnect(this.fileControl,"ready",this.onFileControlReady)}});
Ui.ScrollingArea.extend("KJing.ImageFileControlViewer",{fileControl:void 0,image:void 0,changeLock:!1,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;this.setMaxScale(4);this.image=new KJing.ScaledImage2;"image/gif"===this.fileControl.getFile().getMimetype()?this.image.setSrc(this.fileControl.getFile().getDownloadUrl()):void 0!==this.fileControl.getFile().getPreviewHighUrl()&&this.image.setSrc(this.fileControl.getFile().getPreviewHighUrl());this.setContent(this.image);
this.connect(this,"scroll",this.onFileTransform)},onFileTransform:function(){this.changeLock||this.fileControl.setTransform(-this.getRelativeOffsetX(),-this.getRelativeOffsetY(),this.getScale())},onFileControlChange:function(){!this.getIsDown()&&!this.getIsInertia()&&(this.changeLock=!0,this.setScale(this.fileControl.getTransform().scale),this.setOffset(-this.fileControl.getTransform().x,-this.fileControl.getTransform().y,!1),this.changeLock=!1)}},{onLoad:function(){KJing.ImageFileControlViewer.base.onLoad.apply(this,
arguments);this.connect(this.fileControl,"change",this.onFileControlChange);this.onFileControlChange()},onUnload:function(){KJing.ImageFileControlViewer.base.onUnload.apply(this,arguments);this.disconnect(this.fileControl,"change",this.onFileControlChange)}});
Ui.Element.extend("KJing.MediaControl",{fileControl:void 0,state:"initial",duration:void 0,position:void 0,isReady:!1,constructor:function(a){this.addEvents("ready","ended","timeupdate","bufferingupdate","statechange","error");this.fileControl=a.fileControl;delete a.fileControl},play:function(){this.fileControl.sendOrder({order:"play"})},pause:function(){this.fileControl.sendOrder({order:"pause"})},getDuration:function(){return this.duration},setCurrentTime:function(a){this.fileControl.sendOrder({order:"seek",
time:a})},getCurrentTime:function(){return this.position*this.duration},getState:function(){return this.state},getIsReady:function(){return this.isReady},onFileControlChange:function(){this.duration!==this.fileControl.getDuration()&&(this.duration=this.fileControl.getDuration());this.state!==this.fileControl.getState()&&void 0!==this.fileControl.getState()&&(this.state=this.fileControl.getState(),this.fireEvent("statechange",this,this.state));this.position!==this.fileControl.getPosition()&&void 0!==
this.fileControl.getPosition()&&(this.position=this.fileControl.getPosition(),this.fireEvent("timeupdate",this,this.getCurrentTime(),this.getDuration()));this.isReady||(this.isReady=this.fileControl.getIsReady()&&void 0!==this.duration)&&this.fireEvent("ready",this)}},{onLoad:function(){KJing.MediaControl.base.onLoad.apply(this,arguments);this.connect(this.fileControl,"change",this.onFileControlChange);this.onFileControlChange()},onUnload:function(){KJing.MediaControl.base.onUnload.apply(this,arguments);
this.disconnect(this.fileControl,"change",this.onFileControlChange)}});
Ui.LBox.extend("KJing.VideoFileControlViewer",{fileControl:void 0,scroll:void 0,image:void 0,changeLock:!1,mediaControl:void 0,mediaBar:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;this.scroll=new Ui.ScrollingArea({maxScale:4});this.append(this.scroll);this.image=new KJing.ScaledImage2;void 0!==this.fileControl.getFile().getPreviewHighUrl()&&this.image.setSrc(this.fileControl.getFile().getPreviewHighUrl());this.scroll.setContent(this.image);this.mediaControl=
new KJing.MediaControl({fileControl:this.fileControl,verticalAlign:"top",horizontalAlign:"left",width:0,height:0});this.append(this.mediaControl);this.mediaBar=new KJing.MediaPlayBar({media:this.mediaControl,verticalAlign:"bottom"});this.append(this.mediaBar);this.connect(this.scroll,"scroll",this.onFileTransform)},onFileTransform:function(){this.changeLock||this.fileControl.setTransform(-this.scroll.getRelativeOffsetX(),-this.scroll.getRelativeOffsetY(),this.scroll.getScale())},onFileControlChange:function(){!this.scroll.getIsDown()&&
!this.scroll.getIsInertia()&&(this.changeLock=!0,this.scroll.setScale(this.fileControl.getTransform().scale),this.scroll.setOffset(-this.fileControl.getTransform().x,-this.fileControl.getTransform().y,!1),this.changeLock=!1)}},{onLoad:function(){KJing.VideoFileControlViewer.base.onLoad.apply(this,arguments);this.connect(this.fileControl,"change",this.onFileControlChange);this.onFileControlChange()},onUnload:function(){KJing.VideoFileControlViewer.base.onUnload.apply(this,arguments);this.disconnect(this.fileControl,
"change",this.onFileControlChange)}});Ui.LBox.extend("KJing.AudioFileControlViewer",{fileControl:void 0,mediaControl:void 0,mediaBar:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;this.mediaControl=new KJing.MediaControl({fileControl:this.fileControl,verticalAlign:"top",horizontalAlign:"left",width:0,height:0});this.append(this.mediaControl);this.mediaBar=new KJing.MediaPlayBar({media:this.mediaControl,verticalAlign:"bottom"});this.append(this.mediaBar)}});
Ui.LBox.extend("KJing.SiteFileControlViewer",{fileControl:void 0,text:void 0,linkButton:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;a=new Core.HttpRequest({method:"GET",url:this.fileControl.getFile().getDownloadUrl()});this.connect(a,"done",this.onContentLoaded);a.send();a=new Ui.VBox({verticalAlign:"center",horizontalAlign:"center",spacing:10});this.setContent(a);var b=new Ui.LBox({verticalAlign:"bottom",horizontalAlign:"center"});a.append(b);void 0!==this.fileControl.getFile().getPreviewUrl()?
b.setContent(new Ui.Image({width:128,src:this.fileControl.getFile().getPreviewUrl()})):b.setContent(new Ui.Icon({icon:"earth",width:128,height:128}));this.text=new Ui.Text({textAlign:"center",text:this.fileControl.getFile().getName(),fontSize:20});a.append(this.text);this.linkButton=new Ui.LinkButton({text:"Ouvrir le site",horizontalAlign:"center"});this.linkButton.disable();a.append(this.linkButton)},onContentLoaded:function(a){this.linkButton.setSrc(a.getResponseText());this.linkButton.enable()}});
Ui.ScrollingArea.extend("KJing.PdfPageControlViewer",{pageControl:void 0,file:void 0,image:void 0,changeLock:!1,constructor:function(a){this.pageControl=a.pageControl;delete a.pageControl;this.file=this.pageControl.getFile();this.setMaxScale(4);this.image=new KJing.ScaledImage2;this.setContent(this.image);if(this.pageControl.getIsReady())this.onPageControlReady();else this.connect(this.pageControl,"ready",this.onPageControlReady);this.connect(this,"scroll",this.onPageTransform)},onPageControlReady:function(){this.image.setSrc(this.file.getDownloadUrl())},
onPageTransform:function(){this.changeLock||this.pageControl.setTransform(-this.getRelativeOffsetX(),-this.getRelativeOffsetY(),this.getScale())},onPageControlChange:function(){!this.getIsDown()&&!this.getIsInertia()&&(this.changeLock=!0,this.setScale(this.pageControl.getTransform().scale),this.setOffset(-this.pageControl.getTransform().x,-this.pageControl.getTransform().y,!1),this.changeLock=!1)},onFileControlChange:function(){this.pageControl.updateFileControlData()}},{onLoad:function(){KJing.PdfPageControlViewer.base.onLoad.apply(this,
arguments);this.connect(this.pageControl,"change",this.onPageControlChange);this.connect(this.pageControl.getFileControl(),"change",this.onFileControlChange);this.onPageControlChange()},onUnload:function(){KJing.PdfPageControlViewer.base.onUnload.apply(this,arguments);this.disconnect(this.pageControl.getFileControl(),"change",this.onFileControlChange);this.disconnect(this.pageControl,"change",this.onPageControlChange)}});
Ui.CarouselableLoader.extend("KJing.PdfControlPagesLoader",{fileControl:void 0,pagesControl:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;a=this.fileControl.getData();void 0!==a&&(this.pagesControl=a.pages);void 0===this.pagesControl&&(this.pagesControl=[])}},{getMin:function(){return 0},getMax:function(){return this.pagesControl.length-1},getElementAt:function(a){a=this.pagesControl[a];if(void 0===a)return new Ui.Element;var b=KJing.File.create(a.id),b=new KJing.PageControl({fileControl:this.fileControl,
file:b,id:a.id});b.updateData(a);return new KJing.PdfPageControlViewer({pageControl:b})}});
Ui.Carousel3.extend("KJing.PdfFileControlViewer",{fileControl:void 0,loader:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;this.loader=new KJing.PdfControlPagesLoader({fileControl:this.fileControl});this.setLoader(this.loader);this.setBufferingSize(1);a=this.fileControl.getPosition();void 0===a&&(a=0);this.setCurrentAt(a,!0);this.connect(this,"change",this.onCarouselPageChange)},onCarouselPageChange:function(a,b){this.fileControl.setPosition(b)},onFileControlChange:function(){var a=
this.fileControl.getPosition();void 0===a&&(a=0);this.setCurrentAt(a)}},{onLoad:function(){KJing.PdfFileControlViewer.base.onLoad.apply(this,arguments);this.connect(this.fileControl,"change",this.onFileControlChange);this.onFileControlChange()},onUnload:function(){KJing.PdfFileControlViewer.base.onUnload.apply(this,arguments);this.disconnect(this.fileControl,"change",this.onFileControlChange)}});
Ui.ScrollingArea.extend("KJing.TextFileControlViewer",{fileControl:void 0,text:void 0,changeLock:!1,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;this.setMaxScale(4);a=new Ui.ScaleBox({fixedWidth:800,fixedHeight:600});this.setContent(a);a.append(new Ui.Rectangle({fill:"black"}));this.text=new Ui.Text({margin:20,style:{"Ui.Text":{fontSize:40,color:"white"}}});a.append(this.text);a=new Core.HttpRequest({method:"GET",url:this.fileControl.getFile().getDownloadUrl()});this.connect(a,
"done",this.onTextLoaded);a.send()},onTextLoaded:function(a){this.text.setText(a.getResponseText())}});Ui.CanvasElement.extend("KJing.DeviceItemGraphic",{ratio:1.33,online:!1,image:void 0,imageSrc:void 0,constructor:function(a){this.image=new Ui.Image;this.appendChild(this.image);this.connect(this.image,"ready",this.invalidateDraw);this.connect(this.image,"error",this.invalidateDraw)},setRatio:function(a){isNaN(a)&&(ratis=1.33);this.ratio!==a&&(this.ratio=a,this.invalidateDraw())},setOnline:function(a){this.online!==a&&(this.online=a,this.invalidateDraw())},setImageSrc:function(a){this.imageSrc!==
a&&(this.imageSrc=a,this.image.setSrc(this.imageSrc))}},{updateCanvas:function(a){var b=this.getLayoutWidth(),c=this.getLayoutHeight(),d=Math.min(b,c),e=Math.round(0.05*d),f;1<this.ratio?f=d/this.ratio:(f=d,d=f*this.ratio);var b=(b-d)/2,c=c-f,g=d-2*e,h=f-2*e;a.fillStyle="black";a.fillRect(b,c,d,f);if(void 0!==this.imageSrc&&this.image.getIsReady()){var k=this.image.getNaturalWidth(),l=this.image.getNaturalHeight(),k=k/l,m;k>this.ratio?(l=d,m=l/k):(m=f,l=m*k);a.drawImage(this.image.getDrawing(),b+
(d-l)/2,c+(f-m)/2,l,m)}a.fillStyle=this.online?"#81e309":"#f75265";a.beginPath();a.moveTo(b,c);a.lineTo(b+d,c);a.lineTo(b+d,c+f);a.lineTo(b,c+f);a.moveTo(b+e,c+e);a.lineTo(b+e,c+e+h);a.lineTo(b+e+g,c+e+h);a.lineTo(b+e+g,c+e);a.closePath();a.fill()}});
Ui.Selectionable.extend("KJing.DeviceItemView",{view:void 0,resource:void 0,label:void 0,content:void 0,graphic:void 0,constructor:function(a){this.view=a.view;delete a.view;this.resource=a.resource;delete a.resource;if(!KJing.Device.hasInstance(this.resource))throw"STOP HERE";this.setDraggableData(this);this.bg=new Ui.Rectangle({fill:"#e0eff8"});this.bg.hide();this.append(this.bg);a=new Ui.VBox({margin:5,spacing:5});this.append(a);this.content=new Ui.DropBox({width:70,height:70});this.connect(this.content,
"drop",this.onDrop);this.connect(this.content,"dropfile",this.onDropFile);a.append(this.content);this.content.addType(KJing.FileItemView,"move");this.content.addType(KJing.FolderItemView,"move");this.label=new Ui.CompactLabel({width:100,maxLine:3,textAlign:"center"});a.append(this.label);this.graphic=new KJing.DeviceItemGraphic({verticalAlign:"bottom",horizontalAlign:"center",width:64,height:64});this.content.setContent(this.graphic);if(this.resource.getIsReady())this.onResourceChange();this.connect(this,
"press",function(){this.getIsSelected()?this.unselect():this.select()})},getView:function(){return this.view},getResource:function(){return this.resource},open:function(){this.getView().push(this.getResource().getName(),this.getResource().getId())},suppress:function(){this.resource.suppress()},onItemProperties:function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open()},onDrop:function(a,b,c,d,e){KJing.ItemView.hasInstance(b)&&this.getResource().setPath(b.getResource().getId())},
onDropFile:function(){},onResourceChange:function(){this.label.setText(this.resource.getName());this.graphic.setOnline(this.resource.getIsConnected());var a=this.resource.getDevicePlayList();if(void 0!==a&&0<a.length){var b=this.resource.getDevicePosition(),a=a[b];if(a.getIsReady())this.onFileControlReady(a);else this.connect(a,"ready",this.onFileControlReady)}else if(null!==this.resource.getData().path)if(a=KJing.Resource.create(this.resource.getData().path),a.getIsReady())this.onFileReady(a);else this.connect(a,
"ready",this.onFileReady);this.graphic.setRatio(this.resource.getDeviceRatio())},onFileControlReady:function(a){this.onFileReady(a.getFile())},onFileReady:function(a){void 0!==a.data.thumbnailLow&&(a=KJing.File.create(a.data.thumbnailLow),this.graphic.setImageSrc(a.getDownloadUrl()))}},{onLoad:function(){KJing.DeviceItemView.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onResourceChange)},onUnload:function(){KJing.DeviceItemView.base.onUnload.apply(this,arguments);this.disconnect(this.resource,
"change",this.onResourceChange)},getSelectionActions:function(){return{suppress:{text:"Supprimer",icon:"trash",color:"#e05050",scope:this,callback:this.suppress,multiple:!0},edit:{text:"Propri\u00e9t\u00e9s",icon:"edit",scope:this,callback:this.onItemProperties,multiple:!1},open:{"default":!0,text:"Ouvrir",icon:"eye",scope:this,callback:this.open,multiple:!1}}},onSelect:function(){this.bg.show()},onUnselect:function(){this.bg.hide()}});KJing.ItemView.extend("KJing.FileControlItemView",{fileControl:void 0,currentGraphic:void 0,constructor:function(a){this.fileControl=a.fileControl;delete a.fileControl;this.setDraggableData(void 0);this.currentGraphic=new Ui.Rectangle({height:4,verticalAlign:"bottom"});this.currentGraphic.hide();this.append(this.currentGraphic);this.setItemIcon("file");this.setItemName("");if(this.fileControl.getIsReady())this.onFileReady();else this.connect(this.fileControl,"ready",this.onFileReady)},getFileControl:function(){return this.fileControl},
onFileReady:function(){"application/x-directory"===this.fileControl.getFile().getMimetype()?this.setItemIcon("folder"):(0===this.fileControl.getFile().getMimetype().indexOf("audio/")&&this.setItemIcon("sound"),void 0!==this.fileControl.getFile().getPreviewUrl()&&this.setItemImage(this.fileControl.getFile().getPreviewUrl()));this.setItemName(this.fileControl.getFile().getName())}},{onPress:function(){this.fileControl.setCurrent()},onCurrent:function(){this.currentGraphic.show()},onUncurrent:function(){this.currentGraphic.hide()},
onStyleChange:function(){KJing.FileControlItemView.base.onStyleChange.apply(this,arguments);this.currentGraphic.setFill(this.getStyleProperty("activeForeground"))},onLoad:function(){KJing.FileControlItemView.base.onLoad.apply(this,arguments);this.connect(this.fileControl,"current",this.onCurrent);this.connect(this.fileControl,"uncurrent",this.onUncurrent);if(this.fileControl.getIsCurrent())this.onCurrent();else this.onUncurrent()},onUnload:function(){KJing.FileControlItemView.base.onUnload.apply(this,
arguments);this.disconnect(this.fileControl,"current",this.onCurrent);this.disconnect(this.fileControl,"uncurrent",this.onUncurrent)}});Ui.CarouselableLoader.extend("KJing.DeviceListLoader",{device:void 0,constructor:function(a){this.device=a.device;delete a.device}},{getMin:function(){return 0},getMax:function(){return this.device.getDevicePlayList().length-1},getElementAt:function(a){return new KJing.FileControlViewer({fileControl:this.device.getDevicePlayList()[a]})}});
KJing.View.extend("KJing.DeviceView",{resource:void 0,file:void 0,volumeControl:void 0,path:void 0,mainVBox:void 0,listView:void 0,ratioBox:void 0,viewer:void 0,carousel:void 0,loader:void 0,message:void 0,constructor:function(a){this.resource=a.resource;delete a.resource},buildNoControl:function(){void 0===this.message&&(this.message=new Ui.Text({text:"Le client d'affichage n'est pas connect\u00e9. Vous ne pouvez donc pas le contr\u00f4ler pour le moment",textAlign:"center",verticalAlign:"center",
margin:40}),this.setContent(this.message),this.mainVBox=void 0)},buildControl:function(){if(void 0===this.mainVBox){var a=new Ui.VBox({spacing:5});this.mainVBox=a;this.setContent(a);var b=new Ui.HBox;a.append(b,!0);a=new Ui.DropBox;a.addType(KJing.FileItemView,"link");a.addType(KJing.FolderItemView,"link");b.append(a,!0);this.connect(a,"drop",this.onDrop);this.ratioBox=new KJing.RatioBox({ratio:4/3});a.setContent(this.ratioBox);this.ratioBox.append(new Ui.Rectangle({fill:"black"}));this.loader=new KJing.DeviceListLoader({device:this.resource});
this.carousel=new Ui.Carousel3({loader:this.loader,bufferingSize:1});this.connect(this.carousel,"change",this.onCarouselChange);this.ratioBox.append(this.carousel);a=new Ui.VBox;b.append(a);this.volumeControl=new Ui.Slider({orientation:"vertical"});this.connect(this.volumeControl,"change",this.onVolumeControlChange);a.append(this.volumeControl,!0);a.append(new Ui.Icon({icon:"sound",width:24,height:24,horizontalAlign:"center"}));this.listView=new KJing.DeviceControlListView({view:this,resource:this.resource});
this.mainVBox.append(this.listView);this.message=void 0}},onCarouselChange:function(a,b,c){"user"===c&&this.resource.setDevicePosition(b)},onDeviceChange:function(){this.resource.getIsConnected()?(this.buildControl(),this.resource.getIsDeviceSync()&&(this.ratioBox.setRatio(this.resource.getDeviceRatio()),this.carousel.getCurrentPosition()!==this.resource.getDevicePosition()&&this.carousel.setCurrentAt(this.resource.getDevicePosition()),this.volumeControl.getValue()!==this.resource.getDeviceVolume()&&
this.volumeControl.setValue(this.resource.getDeviceVolume()))):this.buildNoControl()},onDrop:function(a,b,c,d,e){(KJing.FileItemView.hasInstance(b)||KJing.FolderItemView.hasInstance(b))&&this.resource.setPath(b.getResource().getId())},onVolumeControlChange:function(){this.resource.setDeviceVolume(this.volumeControl.getValue())},onPlayListChange:function(){void 0!==this.carousel&&this.carousel.setLoader(this.loader)}},{getSetupPopup:function(){var a=new Ui.MenuPopup({preferredWidth:200}),b=new Ui.VBox({spacing:10});
a.setContent(b);var c=new Ui.Button({text:"Propri\u00e9t\u00e9s",icon:"edit"});this.connect(c,"press",function(){(new KJing.ResourcePropertiesDialog({resource:this.resource})).open();a.hide()});b.append(c);return a},onLoad:function(){KJing.DeviceView.base.onLoad.apply(this,arguments);this.connect(this.resource,"change",this.onDeviceChange);this.connect(this.resource,"playlistchange",this.onPlayListChange);this.resource.monitor()},onUnload:function(){KJing.DeviceView.base.onUnload.apply(this,arguments);
this.disconnect(this.resource,"change",this.onDeviceChange);this.disconnect(this.resource,"playlistchange",this.onPlayListChange);this.resource.unmonitor()}});
Ui.ScrollingArea.extend("KJing.DeviceControlListView",{view:void 0,resource:void 0,flow:void 0,constructor:function(a){this.view=a.view;delete a.view;this.resource=a.resource;delete a.resource;this.setScrollVertical(!1);this.flow=new Ui.HBox;this.setContent(this.flow)},getResource:function(){return this.resource},onDeviceChange:function(){for(var a=this.resource.getDevicePlayList(),b=[],c=0;c<a.length;c++){for(var d=a[c],e=!1,f,g=0;g<this.flow.getChildren().length;g++)if(f=this.flow.getChildren()[g].getFileControl(),
d.getId()===f.getId()&&d.getFile().getId()===f.getFile().getId()){e=!0;break}!1===e&&b.push(d)}for(var h=[],g=0;g<this.flow.getChildren().length;g++){var k=this.flow.getChildren()[g];f=k.getFileControl();e=!1;for(c=0;c<a.length;c++)if(d=a[c],d.getId()===f.getId()&&d.getFile().getId()===f.getFile().getId()){e=!0;break}!1===e&&h.push(k)}for(c=0;c<h.length;c++)this.flow.remove(h[c]);for(c=0;c<b.length;c++)f=b[c],this.flow.insertAt(new KJing.FileControlItemView({fileControl:f}),f.getId())}},{onLoad:function(){KJing.DeviceControlListView.base.onLoad.apply(this,
arguments);this.connect(this.resource,"change",this.onDeviceChange);this.resource.monitor();this.onDeviceChange()},onUnload:function(){KJing.DeviceControlListView.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onDeviceChange);this.resource.unmonitor()}});KJing.DeviceItemView.extend("KJing.MapDeviceItemView",{map:void 0,x:0,y:0,constructor:function(a){},getMap:function(){return this.map},setMap:function(a){this.map=a},getX:function(){return this.x},setX:function(a){this.x=a},getY:function(){return this.y},setY:function(a){this.y=a}},{suppress:function(){this.map.detachDevice(this.resource)}});
Ui.DropBox.extend("KJing.MapDevicesView",{resource:void 0,view:void 0,image:void 0,fixed:void 0,devices:void 0,mapX:0,mapY:0,mapWidth:100,mapHeight:100,constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.devices=[];this.fixed=new Ui.Fixed;this.setContent(this.fixed);this.addType("files","copy");this.addType(KJing.DeviceItemView,"link");this.connect(this,"dropfile",this.onMapDropFile);this.connect(this,"drop",this.onMapDrop);this.image=new Ui.Image;
a=this.resource.getMapImageUrl();void 0!==a&&this.image.setSrc(a);this.image.getIsReady()||this.image.hide();this.connect(this.image,"ready",function(){this.image.show()});this.connect(this.image,"error",function(){this.image.hide()});this.fixed.append(this.image,0,0);this.connect(this.image,"ready",this.onReady);this.connect(this.fixed,"resize",this.onResize);this.addEvents("ready")},getIsReady:function(){return this.image.getIsReady()},onReady:function(){this.updateSize();this.fireEvent("ready",
this)},onResize:function(){this.updateSize()},updateSize:function(){var a=this.image.getNaturalWidth(),b=this.image.getNaturalHeight();void 0===a&&(a=100);void 0===b&&(b=100);var c=this.getLayoutWidth(),d=this.getLayoutHeight();if(a/b<c/d){var e=d,f=a*e/b;this.mapX=-(f-c)/2;this.mapY=0}else f=c,e=b*f/a,this.mapX=0,this.mapY=-(e-d)/2;this.mapWidth=f;this.mapHeight=e;this.fixed.setPosition(this.image,this.mapX,this.mapY);this.image.setWidth(f);this.image.setHeight(e);this.updateDevicesPositions()},
updateDevicesPositions:function(){for(var a=this.mapWidth,b=this.mapHeight,c=0;c<this.devices.length;c++)this.fixed.setPosition(this.devices[c],this.mapX+this.devices[c].getX()*a,this.mapY+this.devices[c].getY()*b)},onMapDropFile:function(a,b,c,d,e){this.resource.setMapImage(b)},onMapDrop:function(a,b,c,d,e){KJing.DeviceItemView.hasInstance(b)&&(a=b.getDragDelta(),d-=this.mapX,e-=this.mapY,d-=a.x,e-=a.y,d+=b.getLayoutWidth()/2,e+=b.getLayoutHeight()/2,a=b.getResource(),d/=this.mapWidth,e/=this.mapHeight,
this.resource.isAttachedDevice(a)?(this.resource.moveDevice(a,d,e),b.setX(d),b.setY(e),this.updateDevicesPositions()):this.resource.attachDevice(a,d,e))},onResourceChange:function(){var a=this.resource.getMapImageUrl();void 0!==a&&a!==this.image.getSrc()&&this.image.setSrc(a);for(var a=[],b=this.resource.getDevices(),c=0;c<this.devices.length;c++){for(var d=this.devices[c],e=void 0,f=0;void 0===e&&f<b.length;f++)b[f].device.getId()===d.getResource().getId()&&(e=b[f]);void 0===e?this.fixed.remove(d):
(a.push(d),d.setX(e.x),d.setY(e.y))}for(c=0;c<b.length;c++){e=void 0;for(f=0;void 0===e&&f<this.devices.length;f++)this.devices[f].getResource().getId()===b[c].device.getId()&&(e=this.devices[f]);void 0===e&&(d=new KJing.MapDeviceItemView({view:this.view,resource:b[c].device,map:this.resource,x:b[c].x,y:b[c].y}),a.push(d),this.fixed.append(d,0,0),this.fixed.setRelativePosition(d,0.5,0.5,!1))}this.devices=a;this.updateDevicesPositions()}},{onLoad:function(){KJing.MapDevicesView.base.onLoad.apply(this,
arguments);this.connect(this.resource,"change",this.onResourceChange);this.resource.monitor()},onUnload:function(){KJing.MapDevicesView.base.onUnload.apply(this,arguments);this.disconnect(this.resource,"change",this.onResourceChange);this.resource.unmonitor()}});Ui.LBox.extend("KJing.FileView",{resource:void 0,view:void 0,viewer:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;this.view=a.view;delete a.view;this.viewer=new Storage.FileViewer({file:this.resource});this.setContent(this.viewer)},getSetupPopup:function(){return this.viewer.getSetupPopup()},getResource:function(){return this.resource}});KJing.View.extend("KJing.LinkView",{resource:void 0,linkedResource:void 0,linkedView:void 0,constructor:function(a){this.resource=a.resource;delete a.resource;if(this.resource.getIsReady())this.onResourceReady();else this.connect(this.resource,"ready",this.onResourceReady)},getSetupPopup:function(){return void 0!==this.linkedView&&"getSetupPopup"in this.linkedView?this.linkedView.getSetupPopup():new Ui.MenuPopup({preferredWidth:200})},onResourceReady:function(){this.linkedResource=this.resource.getLinkedResource();
this.linkedView=KJing.View.create(this.view,this.linkedResource);this.setContent(this.linkedView)}});Ui.LBox.extend("KJing.WizardItem",{data:void 0,isDone:!1,constructor:function(a){this.data=a.data;delete a.data;this.addEvents("done")},getData:function(){return this.data},getIsDone:function(){return this.isDone},done:function(){this.isDone||(this.isDone=!0,this.fireEvent("done"))},save:function(){this.onSave()},onSave:function(){}});Core.Object.extend("KJing.LoginCreator",{data:void 0,session:void 0,isDone:!1,constructor:function(a){this.data=a.data;delete a.data;this.session=a.session;delete a.session;this.addEvents("done","fail")},getIsDone:function(){return this.isDone},getData:function(){return this.data},getSession:function(){return this.session},done:function(a){this.isDone||(this.isDone=!0,this.fireEvent("done",this,a))},fail:function(){this.fireEvent("fail",this)}});KJing.WizardItem.extend("KJing.LoginWizardSelector",{selectItem:void 0,constructor:function(a){this.addEvents("choose");var b=new Ui.VBox({uniform:!0,spacing:10});this.setContent(b);for(var c=KJing.LoginWizard.getWizardTypes(),d=0;d<c.length;d++){var e=KJing.LoginWizard.getWizard(c[d]),e=new Ui.Button({icon:e.icon,text:e.name,orientation:"horizontal"});this.connect(e,"press",this.onItemPress);e.hostLoginWizardSelector=c[d];b.append(e)}delete a.wizardType},getSelectedType:function(){return this.selectItem.hostLoginWizardSelector},
onItemPress:function(a){this.selectItem=a;this.fireEvent("done",this)}});
Ui.Dialog.extend("KJing.LoginWizard",{previousButton:void 0,nextButton:void 0,transBox:void 0,position:0,current:void 0,wizardType:void 0,data:void 0,constructor:function(a){this.addEvents("done");this.setTitle("Connexion");this.setFullScrolling(!0);this.setPreferredWidth(450);this.setPreferredHeight(450);this.setAutoClose(!1);this.data={};this.previousButton=new Ui.Button({text:"Pr\u00e9c\u00e9dent"});this.previousButton.hide();this.connect(this.previousButton,"press",this.onPreviousPress);this.nextButton=
new Ui.Button({text:"Suivant"});this.connect(this.nextButton,"press",this.onNextPress);this.transBox=new Ui.TransitionBox;this.setContent(this.transBox);this.current=new KJing.LoginWizardSelector;this.transBox.replaceContent(this.current);this.connect(this.current,"done",this.onItemDone);this.nextButton.disable()},onPreviousPress:function(){this.position--;this.disconnect(this.current,"done",this.onItemDone);this.current.save();0>this.position&&(this.position=0);if(0==this.position)this.setTitle("Connexion"),
this.current=new KJing.LoginWizardSelector({wizardType:this.wizardType}),this.previousButton.hide(),this.setActionButtons(void 0);else{var a=KJing.LoginWizard.getWizard(this.wizardType);this.setTitle(a.name);this.current=new a.array[this.position-1]({data:this.data})}this.nextButton.setText("Suivant");this.connect(this.current,"done",this.onItemDone);this.transBox.replaceContent(this.current);this.current.getIsDone()?this.nextButton.enable():this.nextButton.disable()},onItemDone:function(){if(0==
this.position)this.onNextPress();this.nextButton.enable()},onNextPress:function(){this.position++;this.disconnect(this.current,"done",this.onItemDone);this.current.save();this.nextButton.disable();this.previousButton.show();1==this.position&&(this.setActionButtons([this.previousButton,this.nextButton]),this.wizardType!=this.current.getSelectedType()&&(this.wizardType=this.current.getSelectedType(),this.data={}));var a=KJing.LoginWizard.getWizard(this.wizardType);this.position>a.array.length?(a=new a.creator({data:this.data,
item:this.current}),this.disable(),this.connect(a,"done",this.onCreatorDone),this.connect(a,"fail",this.onCreatorFail)):(this.setTitle(a.name),this.current=new a.array[this.position-1]({data:this.data}),this.position==a.array.length?this.nextButton.setText(a.endlabel):this.nextButton.setText("Suivant"),this.connect(this.current,"done",this.onItemDone),this.transBox.replaceContent(this.current))},onCreatorDone:function(a,b){this.close();this.fireEvent("done",this,b)},onCreatorFail:function(){this.enable();
this.position--;this.nextButton.enable()}},{},{apps:void 0,constructor:function(){this.apps={}},register:function(a,b,c,d,e,f){KJing.LoginWizard.apps[a]={name:b,icon:c,array:d,creator:e,endlabel:f}},getWizardTypes:function(){var a=[],b;for(b in KJing.LoginWizard.apps)a.push(b);return a},getWizard:function(a){return KJing.LoginWizard.apps[a]}});KJing.LoginCreator.extend("KJing.Local.Creator",{item:void 0,constructor:function(a){this.item=a.item;delete a.item;a=new Core.HttpRequest({method:"POST",url:"/cloud/user/login",content:JSON.stringify({login:this.getData().login,password:this.getData().password})});this.connect(a,"done",this.onLoginBasicDone);this.connect(a,"error",this.onLoginBasicFails);a.send()},onLoginBasicDone:function(a){"localStorage"in window&&(this.data.localstore?(localStorage.setItem("login",this.data.login),localStorage.setItem("password",
this.data.password)):(localStorage.removeItem("login"),localStorage.removeItem("password")));this.done()},onLoginBasicFails:function(){this.fail();this.item.showError()}});
KJing.WizardItem.extend("KJing.Local.Wizard",{loginField:void 0,passwordField:void 0,localStoreField:void 0,errorMessage:void 0,errorTimeout:void 0,constructor:function(a){a=new Ui.SFlow({spacing:5,itemAlign:"stretch",stretchMaxRatio:5});this.setContent(a);this.loginField=new KJing.TextField({title:"Identifiant",width:250});this.connect(this.loginField,"change",this.onChange);a.append(this.loginField);this.passwordField=new KJing.TextField({title:"Mot de passe",passwordMode:!0,width:250});this.connect(this.passwordField,
"change",this.onChange);a.append(this.passwordField);this.localStoreField=new Ui.CheckBox({text:"Se souvenir de moi"});"localStorage"in window&&a.append(this.localStoreField);this.errorMessage=new Ui.Text({text:"Echec: Identifiant ou mot de passe incorrect",color:"red"});this.errorMessage.hide();a.append(this.errorMessage);a=this.getData();void 0!=a.login?this.loginField.setValue(a.login):"localStorage"in window&&void 0!=localStorage.getItem("login")&&this.loginField.setValue(localStorage.getItem("login"));
void 0!=a.password?this.passwordField.setValue(a.password):"localStorage"in window&&void 0!=localStorage.getItem("password")&&this.passwordField.setValue(localStorage.getItem("password"));void 0!=a.localstore?this.localStoreField.setValue(a.localstore):"localStorage"in window&&(void 0!=localStorage.getItem("password")||void 0!=localStorage.getItem("login"))&&this.localStoreField.setValue(!0);this.onChange()},showError:function(){void 0!=this.errorTimeout&&this.errorTimeout.abort();this.errorMessage.show();
this.errorTimeout=new Core.DelayedTask({scope:this,delay:4,callback:this.onShowErrorTimeout})},onShowErrorTimeout:function(){this.errorTimeout=void 0;this.errorMessage.hide()},onChange:function(){void 0!=this.errorTimeout&&(this.errorTimeout.abort(),this.errorTimeout=void 0,this.errorMessage.hide());""!=this.loginField.getValue()&&""!=this.passwordField.getValue()&&this.done()}},{onSave:function(){var a=this.getData();a.login=this.loginField.getValue();a.password=this.passwordField.getValue();a.localstore=
this.localStoreField.getValue()}});KJing.LoginWizard.register("local","Local","localaccount",[KJing.Local.Wizard],KJing.Local.Creator,"Connecter");KJing.WizardItem.extend("KJing.Google.Wizard",{constructor:function(a){this.setContent(new Ui.Text({text:"Redirection en cours...",textAlign:"center",verticalAlign:"center"}));location="/cloud/googleoauth2/redirect?state=create"}});KJing.WizardItem.extend("KJing.Facebook.Wizard",{constructor:function(a){this.setContent(new Ui.Text({text:"Redirection en cours...",textAlign:"center",verticalAlign:"center"}));location="/cloud/facebookoauth2/redirect?state=create"}});KJing.LoginCreator.extend("KJing.Create.Creator",{item:void 0,newuser:void 0,newresources:void 0,resources:void 0,constructor:function(a){this.item=a.item;delete a.item;a=new Core.HttpRequest({method:"POST",url:"/cloud/resource",content:JSON.stringify({type:"user",login:this.getData().login,password:this.getData().password,firstname:this.getData().firstname,lastname:this.getData().lastname})});this.connect(a,"done",this.onCreateUserDone);this.connect(a,"error",this.onCreateUserError);a.send()},onCreateUserError:function(a){var b=
a.getStatus(),c="Echec de la cr\u00e9ation. V\u00e9rifier vos donn\u00e9es";409==b?c="Echec: l'identifiant existe d\u00e9j\u00e0":403==b&&1==a.getResponseJSON().code&&(c="Echec: mot de passe trop faible");this.item.showError(c);this.fail()},onCreateUserDone:function(){var a=new Core.HttpRequest({method:"POST",url:"/cloud/user/login",content:JSON.stringify({login:this.getData().login,password:this.getData().password})});this.connect(a,"done",this.onLoginBasicDone);this.connect(a,"error",this.onLoginBasicFails);
a.send()},onLoginBasicDone:function(){this.done()},onLoginBasicFails:function(){this.fail()}});
KJing.WizardItem.extend("KJing.Create.Wizard",{firstnameField:void 0,lastnameField:void 0,loginField:void 0,passwordField:void 0,errorMessage:void 0,errorTimeout:void 0,constructor:function(a){a=new Ui.SFlow({spacing:10,itemAlign:"stretch",stretchMaxRatio:5});this.setContent(a);this.firstnameField=new KJing.TextField({title:"Pr\u00e9nom",width:150});this.connect(this.firstnameField,"change",this.onChange);a.append(this.firstnameField);this.lastnameField=new KJing.TextField({title:"Nom",width:150});
this.connect(this.lastnameField,"change",this.onChange);a.append(this.lastnameField);this.loginField=new KJing.TextField({title:"Identifiant",width:400});this.connect(this.loginField,"change",this.onChange);a.append(this.loginField);this.passwordField=new KJing.TextField({title:"Mot de passe",width:400,passwordMode:!0,desc:"8 caract\u00e8res minimum avec chiffre et lettre"});this.connect(this.passwordField,"change",this.onChange);a.append(this.passwordField);this.errorMessage=new Ui.Text({text:"Echec de la cr\u00e9ation. V\u00e9rifier vos donn\u00e9es",
color:"red"});this.errorMessage.hide();a.append(this.errorMessage);a=this.getData();void 0!==a.login&&this.loginField.setValue(a.login);void 0!==a.password&&this.passwordField.setValue(a.password);this.onChange()},showError:function(a){void 0!==this.errorTimeout&&this.errorTimeout.abort();this.errorMessage.setText(a);this.errorMessage.show();this.errorTimeout=new Core.DelayedTask({scope:this,delay:4,callback:this.onShowErrorTimeout})},onShowErrorTimeout:function(){void 0!=this.errorTimeout&&(this.errorTimeout.abort(),
this.errorTimeout=void 0,this.errorMessage.hide());this.errorTimeout=void 0;this.errorMessage.hide()},onChange:function(){""!=this.firstnameField.getValue()&&(""!=this.lastnameField.getValue()&&""!=this.loginField.getValue()&&""!=this.passwordField.getValue())&&this.done()}},{onSave:function(){var a=this.getData();a.firstname=this.firstnameField.getValue();a.lastname=this.lastnameField.getValue();a.login=this.loginField.getValue();a.password=this.passwordField.getValue()}});
KJing.LoginWizard.register("create","Nouveau compte","plus",[KJing.Create.Wizard],KJing.Create.Creator,"Cr\u00e9er");Ui.ScrollingArea.extend("KJing.PartView",{user:void 0,locator:void 0,locatorScroll:void 0,setupButton:void 0,content:void 0,contextBar:void 0,selection:void 0,stack:void 0,constructor:function(a){this.user=a.user;delete a.user;this.stack=[];this.setScrollHorizontal(!1);this.vbox=new Ui.VBox;this.setContent(this.vbox);a=new Ui.HBox;this.vbox.append(a);this.locatorScroll=new Ui.ScrollingArea;a.append(this.locatorScroll,!0);this.locator=new Ui.Locator({path:"/",horizontalAlign:"left",margin:5});this.connect(this.locator,
"change",this.onPathChange);this.locatorScroll.setContent(this.locator);this.setupButton=new Ui.Button({margin:5,icon:"gear"});this.setupButton.hide(!0);a.append(this.setupButton);this.connect(this.setupButton,"press",this.onSetupPress);this.push("Root",this.user.getId())},onSetupPress:function(a,b,c){this.content.getSetupPopup().show(a,"bottom")},getContentView:function(){return this.content},getStack:function(){return this.stack},setStack:function(a){this.stack=a;a=this.stack[this.stack.length-
1];void 0!==this.content&&this.vbox.remove(this.content);this.content=KJing.View.create(this,a.resource);this.vbox.append(this.content,!0);this.updateLocator();"getSetupPopup"in this.content?this.setupButton.show():this.setupButton.hide(!0)},push:function(a,b){this.stack.push({text:a,resource:b});void 0!==this.content&&this.vbox.remove(this.content);this.content=KJing.View.create(this,b);this.vbox.append(this.content,!0);this.updateLocator();"getSetupPopup"in this.content?this.setupButton.show():
this.setupButton.hide(!0)},pop:function(){this.stack.pop()},updateLocator:function(){for(var a="",b=0;b<this.stack.length;b++)var c=this.stack[b],a=""===a?"/":"/"===a?a+c.text:a+("/"+c.text);this.locator.setPath(a)},onPathChange:function(a,b,c){a=this.stack[c];this.stack.splice(c+1,this.stack.length-c-1);void 0!==this.content&&this.vbox.remove(this.content);this.content=KJing.View.create(this,a.resource);this.vbox.append(this.content,!0);this.updateLocator();"getSetupPopup"in this.content?this.setupButton.show():
this.setupButton.hide(!0)}});Ui.MenuToolBar.extend("KJing.MenuToolBar",{});
Ui.Button.extend("KJing.UserProfilButton",{userIcon:void 0,constructor:function(a){this.user=a.user;delete a.user;this.userIcon=new KJing.RoundItemGraphic({imageSrc:this.user.getFaceUrl(),width:48,height:48});this.setIcon(this.userIcon);this.setText(this.user.getName())}},{onStyleChange:function(){KJing.UserProfilButton.base.onStyleChange.apply(this,arguments);var a=this.getStyleProperty("iconSize");this.userIcon.setWidth(a);this.userIcon.setHeight(a)}});
Ui.Button.extend("KJing.Bookmark",{bookmark:void 0,constructor:function(a){this.bookmark=a.bookmark;delete a.bookmark;this.setIcon("star");this.setText(this.bookmark.name);this.setDraggableData(this)},suppress:function(){Ui.App.current.deleteBookmark(this.bookmark)},open:function(){this.onPress()}},{getSelectionActions:function(){return{suppress:{text:"Supprimer",icon:"trash",scope:this,callback:this.suppress,multiple:!0},open:{"default":!0,text:"Ouvrir",icon:"eye",scope:this,callback:this.open,multiple:!1}}},
onPress:function(){Ui.App.current.setState(this.bookmark.state)}});
Ui.MenuPopup.extend("KJing.DisplayPopup",{app:void 0,bookmarksVBox:void 0,constructor:function(a){this.app=a.app;delete a.app;a=new Ui.VBox;this.setContent(a);var b=new Ui.SegmentBar({margin:10,field:"text",data:[{text:"Horizontal",value:"horizontal"},{text:"Vertical",value:"vertical"}]});a.append(b);"horizontal"===this.app.paned.getOrientation()?b.setCurrentPosition(0):b.setCurrentPosition(1);this.connect(b,"change",function(a,b){this.app.paned.setOrientation(b.value)});b=new Ui.DefaultButton({icon:"switch",
text:"Inverser",margin:10});a.append(b);this.connect(b,"press",function(){this.app.paned.invert()});a.append(new Ui.Text({fontWeight:"bold",text:"Favoris",margin:10}));b=new Ui.DefaultButton({text:"Ajouter un favori",margin:10});this.connect(b,"press",function(){var a=new Ui.Dialog({preferredWidth:300,title:"Nouveau favori"}),b=new KJing.TextField({title:"Nom",value:"Nouveau"});a.setContent(b);a.setCancelButton(new Ui.DialogCloseButton);var e=new Ui.Button({text:"Enregistrer"});this.connect(e,"press",
function(){this.app.addBookmark(b.getValue(),this.app.saveDisplayState());a.close()});a.setActionButtons([e]);a.open()});a.append(b);this.bookmarksVBox=new Ui.VBox;a.append(this.bookmarksVBox)},onBookmarksChange:function(){this.bookmarksVBox.clear();for(var a=this.app.getBookmarks(),b=0;b<a.length;b++)this.bookmarksVBox.append(new KJing.Bookmark({bookmark:a[b]}))}},{onLoad:function(){KJing.DisplayPopup.base.onLoad.call(this);this.connect(this.app,"bookmarkschange",this.onBookmarksChange);this.onBookmarksChange()},
onUnload:function(){KJing.DisplayPopup.base.onUnload.call(this);this.disconnect(this.app,"bookmarkschange",this.onBookmarksChange)}});
Ui.App.extend("KJing.AdminApp",{user:void 0,selection:void 0,menuBox:void 0,actionBox:void 0,contextBox:void 0,title:void 0,loginDialog:void 0,paned:void 0,uploadProgressbar:void 0,uploaders:void 0,constructor:function(a){this.addEvents("bookmarkschange");this.uploaders=[];this.sendGetAuthSession();this.connect(this.getDrawing(),"keyup",this.onKeyUp)},sendGetAuthSession:function(){var a=void 0;void 0!=this.getArguments().authsession?a=this.getArguments().authsession:"localStorage"in window&&(a=localStorage.getItem("authsession"));
var b="/cloud/authsession/",b=void 0!=a?b+encodeURIComponent(a):b+"current",a=new Core.HttpRequest({method:"GET",url:b+"?setcookie=1"});this.connect(a,"done",this.onGetAuthSessionDone);this.connect(a,"error",this.onGetAuthSessionError);a.send()},onGetAuthSessionError:function(a){"localStorage"in window&&void 0==this.getArguments().authsession&&localStorage.removeItem("authsession");this.basicLogin()},onGetAuthSessionDone:function(a){a=a.getResponseJSON();this.sessionId=a.id;"localStorage"in window&&
void 0==this.getArguments().authsession&&localStorage.getItem("authsession")!=a.id&&localStorage.setItem("authsession",a.id);void 0!=this.getArguments().authsession&&this.getArguments().authsession==a.id&&Core.HttpRequest.setRequestHeader("X-KJing-Authentication",a.id);a=new Core.HttpRequest({url:"/cloud/resource/"+a.user});this.connect(a,"done",this.onGetUserDone);this.connect(a,"error",this.onGetUserError);a.send()},onGetUserDone:function(a){this.onLoginDone(a.getResponseJSON())},onGetUserError:function(a){"localStorage"in
window&&this.sessionId==localStorage.getItem("authsession")&&localStorage.removeItem("authsession");this.basicLogin()},getUser:function(){return this.user},basicLogin:function(){this.loginDialog=new KJing.LoginWizard;this.connect(this.loginDialog,"done",this.onBasicLoginDone);this.loginDialog.open()},onBasicLoginDone:function(a){a.close();this.sendGetAuthSession()},onLoginDone:function(a){this.user=KJing.Resource.create(a);a=new Ui.VBox;this.setContent(a);this.selection=new Ui.Selection;this.connect(this.selection,
"change",this.onSelectionChange);this.menuBox=new Ui.LBox;a.append(this.menuBox);this.actionBox=new KJing.MenuToolBar({padding:5,spacing:10});this.menuBox.append(this.actionBox);var b=new Ui.LBox;this.actionBox.append(b,!1);this.title=new Ui.Image({src:"img/logo-kjing.svg",horizontalAlign:"left",verticalAlign:"center",width:120});b.append(this.title);this.uploadProgressbar=new Ui.ProgressBar({verticalAlign:"bottom"});this.uploadProgressbar.hide();b.append(this.uploadProgressbar);this.actionBox.append(new Ui.Element,
!0);b=new Ui.Button({icon:"eye"});this.connect(b,"press",this.onDisplayPress);this.actionBox.append(b);b=new Ui.Button({icon:"person"});this.connect(b,"press",this.onProfilPress);this.actionBox.append(b);this.contextBox=new Ui.ContextBar({selection:this.selection});this.contextBox.hide();this.menuBox.append(this.contextBox);b=localStorage.getItem("panedPos")||0.5;this.paned=new Ui.Paned({orientation:"horizontal",pos:b});this.connect(this.paned,"change",this.onPanedChange);a.append(this.paned,!0);
this.paned.setContent1(new KJing.PartView({user:this.user}));this.paned.setContent2(new KJing.PartView({user:this.user}))},onProfilPress:function(a){var b=new Ui.MenuPopup,c=new Ui.VBox;b.setContent(c);var d=new KJing.UserProfilButton({user:this.user});this.connect(d,"press",function(){(new KJing.UserProfil({user:this.user})).open();b.hide()});c.append(d);c.append(new Ui.Separator);d=new Ui.Button({icon:"exit",text:"D\u00e9connecter"});this.connect(d,"press",this.onLogoutPress);c.append(d);b.show(a,
"bottom")},onMessagePress:function(a){var b=new Ui.MenuPopup;b.setContent(new Ui.Text({text:"TODO",verticalAlign:"center",width:150,height:200,margin:10}));b.show(a,"bottom")},saveDisplayState:function(){return{orientation:this.paned.getOrientation(),position:this.paned.getPos(),part1:this.paned.getContent1().getStack(),part2:this.paned.getContent2().getStack()}},setState:function(a){this.paned.setOrientation(a.orientation);this.paned.setPos(a.position);this.paned.getContent1().setStack(a.part1);
this.paned.getContent2().setStack(a.part2)},onDisplayPress:function(a){(new KJing.DisplayPopup({app:this,preferredWidth:220})).show(a,"bottom")},getBookmarks:function(){var a=localStorage.getItem("bookmarks");if(null!==a)for(var a=JSON.parse(a),b=0;b<a.length;b++)a[b].id=b;else a=[];return a},addBookmark:function(a,b){var c=this.getBookmarks();c.unshift({name:a,state:b});localStorage.setItem("bookmarks",JSON.stringify(c));this.fireEvent("bookmarkschange",this)},deleteBookmark:function(a){var b=this.getBookmarks();
0<=a.id&&a.id<b.length&&(b.splice(a.id,1),localStorage.setItem("bookmarks",JSON.stringify(b)),this.fireEvent("bookmarkschange",this))},onLogoutPress:function(a){"localStorage"in window&&(localStorage.removeItem("login"),localStorage.removeItem("password"),localStorage.removeItem("bookmarks"),localStorage.removeItem("authsession"));document.cookie="KJING_AUTH=; expires=Thu, 01-Jan-1970 00:00:01 GMT";a=new Core.HttpRequest({method:"DELETE",url:"/cloud/authsession/current"});this.connect(a,"done",this.onAuthSessionDelete);
this.connect(a,"error",this.onAuthSessionDelete);a.send()},onAuthSessionDelete:function(){var a=window.location.href;-1!=a.lastIndexOf("#")&&(a=a.substring(0,a.lastIndexOf("#")));window.location.replace(a)},onPanedChange:function(a,b){localStorage.setItem("panedPos",b)},getUploaders:function(){return this.uploaders},getUploaderById:function(a){for(var b=0;b<this.uploaders.length;b++){var c=this.uploaders[b];if(c["KJing.AdminApp.uploaderId"]===a)return c}},addUploader:function(a){for(var b="uploader:"+
this.user.getId()+":",c=0;16>c;c++)b+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(62*Math.random())];a["KJing.AdminApp.uploaderId"]=b;this.uploaders.push(a);1===this.uploaders.length&&this.uploadProgressbar.show();this.connect(a,"complete",this.onUploaderCompleteError);this.connect(a,"error",this.onUploaderCompleteError);this.connect(a,"progress",this.updateUploaders);this.updateUploaders();return b},updateUploaders:function(){for(var a=0,b=0,c=0,d=0,e=0;e<this.uploaders.length;e++){var f=
this.uploaders[e];void 0!=f.getTotal()&&(c+=f.getTotal(),d+=f.getIsCompleted()?f.getTotal():f.getLoaded(),b++);a++}this.uploadProgressbar.setValue(d/c)},onUploaderCompleteError:function(a){a=!0;for(var b=0;a&&b<this.uploaders.length;b++)a=this.uploaders[b].getIsCompleted();this.updateUploaders();a&&(this.uploaders=[],this.uploadProgressbar.hide(!0))},getSelectionHandler:function(){return this.selection},onSelectionChange:function(a){0===a.getElements().length?(this.contextBox.hide(),this.actionBox.show()):
(this.contextBox.show(),this.actionBox.hide())},onKeyUp:function(a){46===a.which&&0<this.selection.getElements().length&&(a.stopPropagation(),a.preventDefault(),this.selection.executeDeleteAction())}});
new KJing.AdminApp({webApp:!0,style:{"Ui.Element":{color:"#444444",fontSize:16,interLine:1.4},"Ui.MenuPopup":{background:"#ffffff","Ui.Button":{background:new Ui.Color({r:1,g:1,b:1,a:0.1}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0.1}),iconSize:28,textHeight:28},"Ui.DefaultButton":{borderWidth:1,background:"#fefefe",backgroundBorder:"black",iconSize:16,textHeight:16},"Ui.ActionButton":{showText:!1},"Ui.SegmentBar":{spacing:7,color:"#ffffff"}},"Ui.SegmentBar":{spacing:8,color:"#ffffff"},"Ui.Dialog":{background:"#ffffff"},
"Ui.DialogTitle":{fontSize:20,maxLine:2,interLine:1},"Ui.DialogCloseButton":{background:"rgba(250,250,250,0)",radius:0,borderWidth:0},"Ui.ContextBarCloseButton":{textWidth:5,borderWidth:0,background:"rgba(250,250,250,0)",foreground:"#ffffff",radius:0},"Ui.Separator":{color:"#999999"},"Ui.CheckBox":{color:"#444444",focusColor:new Ui.Color({r:0.13,g:0.83,b:1}),checkColor:new Ui.Color({r:0.03,g:0.63,b:0.9})},"Ui.ScrollingArea":{color:"#999999",showScrollbar:!1,overScroll:!0,radius:0},"Ui.Button":{background:"#fefefe",
iconSize:28,textHeight:28,padding:8,spacing:10,focusBackground:new Ui.Color({r:0.13,g:0.83,b:1,a:0.5})},"Ui.TextBgGraphic":{focusBackground:new Ui.Color({r:0.13,g:0.83,b:1})},"Ui.ActionButton":{iconSize:28,textHeight:28,background:new Ui.Color({r:1,g:1,b:1,a:0}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0}),foreground:"#ffffff",radius:0,borderWidth:0},"Ui.Slider":{foreground:new Ui.Color({r:0.03,g:0.63,b:0.9})},"Ui.Locator":{color:"#eeeeee",iconSize:30,spacing:6},"Ui.MenuToolBarButton":{color:new Ui.Color({r:0.8,
g:0.8,b:0.8,a:0.2}),iconSize:28,spacing:0},"Ui.ContextBar":{background:"#00b9f1","Ui.Element":{color:"#ffffff"}},"KJing.PosBar":{radius:0,current:new Ui.Color({r:0.03,g:0.63,b:0.9})},"KJing.OptionOpenButton":{borderWidth:0,iconSize:16,radius:0,whiteSpace:"pre-line",background:"rgba(250,250,250,0)"},"KJing.ItemView":{orientation:"vertical",whiteSpace:"pre-line",textWidth:100,maxTextWidth:100,fontSize:16,interLine:1,textHeight:32,iconSize:64,maxLine:2,background:new Ui.Color({r:1,g:1,b:1,a:0}),backgroundBorder:new Ui.Color({r:1,
g:1,b:1,a:0}),focusBackground:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackgroundBorder:new Ui.Color({r:0,g:0.72,b:0.95}),selectCheckColor:new Ui.Color({r:0,g:0.72,b:0.95}),radius:0,borderWidth:2},"KJing.GroupUserItemView":{roundMode:!0},"KJing.GroupAddUserItemView":{roundMode:!0},"KJing.RightAddGroupItemView":{roundMode:!0},"KJing.RightAddUserItemView":{roundMode:!0},"KJing.RightItemView":{roundMode:!0},"KJing.MenuToolBar":{background:"#4285f4","Ui.Button":{background:new Ui.Color({r:1,g:1,b:1,a:0.2}),
backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0.3}),foreground:"#ffffff",focusBackground:new Ui.Color({r:0.43,g:1,b:1,a:0.6}),focusForeground:"#ffffff"},"Ui.TextBgGraphic":{background:"#ffffff",focusBackground:new Ui.Color({r:0.43,g:1,b:1,a:0.6})},"Ui.Entry":{color:"#ffffff"}},"KJing.NewItem":{background:new Ui.Color({r:1,g:1,b:1,a:0}),backgroundBorder:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackground:new Ui.Color({r:1,g:1,b:1,a:0}),focusBackgroundBorder:new Ui.Color({r:0,g:0.72,b:0.95}),iconSize:48,
padding:31,radius:0,borderWidth:2},"KJing.UserProfilButton":{iconSize:32}}});
